(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../utils/js.js", "../platform/debug.js", "./loading-items.js", "./utils.js", "../default-constants.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../utils/js.js"), require("../platform/debug.js"), require("./loading-items.js"), require("./utils.js"), require("../default-constants.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.js, global.debug, global.loadingItems, global.utils, global.defaultConstants);
    global.uuidLoader = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, js, _debug, _loadingItems, _utils, _defaultConstants) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.isSceneObj = isSceneObj;
  _exports.loadUuid = loadUuid;
  js = _interopRequireWildcard(js);

  function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

  function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

  function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

  function isSceneObj(json) {
    var SCENE_ID = 'cc.Scene';
    var PREFAB_ID = 'cc.Prefab';
    return json && (json[0] && json[0].__type__ === SCENE_ID || json[1] && json[1].__type__ === SCENE_ID || json[0] && json[0].__type__ === PREFAB_ID);
  }

  function parseDepends(item, asset, tdInfo, deferredLoadRawAssetsInRuntime) {
    var uuidList = tdInfo.uuidList;
    var objList = tdInfo.uuidObjList;
    var propList = tdInfo.uuidPropList;
    var stillUseUrl = tdInfo._stillUseUrl;
    var depends;
    var i, dependUuid; // cache dependencies for auto release

    var dependKeys = item.dependKeys = [];

    if (deferredLoadRawAssetsInRuntime) {
      depends = []; // parse depends assets

      for (i = 0; i < uuidList.length; i++) {
        dependUuid = uuidList[i];
        var obj = objList[i];
        var prop = propList[i];

        var info = cc.AssetLibrary._getAssetInfoInRuntime(dependUuid);

        if (info.raw) {
          // skip preloading raw assets
          var url = info.url;
          obj[prop] = url;
          dependKeys.push(url);
        } else {
          // declare depends assets
          depends.push({
            type: 'uuid',
            uuid: dependUuid,
            deferredLoadRaw: true,
            _owner: obj,
            _ownerProp: prop,
            _stillUseUrl: stillUseUrl[i]
          });
        }
      }
    } else {
      depends = new Array(uuidList.length); // declare depends assets

      for (i = 0; i < uuidList.length; i++) {
        dependUuid = uuidList[i];
        depends[i] = {
          type: 'uuid',
          uuid: dependUuid,
          _owner: objList[i],
          _ownerProp: propList[i],
          _stillUseUrl: stillUseUrl[i]
        };
      } // load native object (Image/Audio) as depends


      if (asset._native && !asset.constructor.preventPreloadNativeObject) {
        depends.push({
          url: asset.nativeUrl,
          _owner: asset,
          _ownerProp: '_nativeAsset'
        });
      }
    }

    return depends;
  }

  function loadDepends(pipeline, item, asset, depends, callback) {
    // Predefine content for dependencies usage
    item.content = asset;
    var dependKeys = item.dependKeys;
    pipeline.flowInDeps(item, depends, function (errors, items) {
      var item, missingAssetReporter;
      var itemsMap = items.map;

      for (var src in itemsMap) {
        item = itemsMap[src];

        if (item.uuid && item.content) {
          item.content._uuid = item.uuid;
        }
      }

      for (var i = 0; i < depends.length; i++) {
        // @ts-ignore
        var loadCallback = function loadCallback(item) {
          var value = item.content; // @ts-ignore

          if (this._stillUseUrl) {
            value = value ? value.nativeUrl : item.rawUrl;
          } // @ts-ignore


          this._owner[this._ownerProp] = value;

          if (item.uuid !== asset._uuid && dependKeys.indexOf(item.id) < 0) {
            dependKeys.push(item.id);
          }
        };

        var dep = depends[i];
        var dependSrc = dep.uuid;
        var dependUrl = dep.url;
        var dependObj = dep._owner;
        var dependProp = dep._ownerProp;
        item = itemsMap[dependUrl];

        if (!item) {
          continue;
        }

        var loadCallbackCtx = dep;

        if (item.complete || item.content) {
          if (item.error) {
            if (_defaultConstants.EDITOR && item.error.errorCode === 'db.NOTFOUND') {
              if (!missingAssetReporter) {
                missingAssetReporter = new EditorExtends.MissingReporter.object(asset);
              }

              missingAssetReporter.stashByOwner(dependObj, dependProp, EditorExtends.serialize.asAsset(dependSrc));
            } else {
              cc._throw(item.error);
            }
          } else {
            loadCallback.call(loadCallbackCtx, item);
          }
        } else {
          // item was removed from cache, but ready in pipeline actually
          var queue = _loadingItems.LoadingItems.getQueue(item);

          if (queue) {
            queue.addListener(dependSrc, loadCallback, loadCallbackCtx);
          }
        }
      } // Emit dependency errors in runtime, but not in editor,
      // because editor need to open the scene / prefab to let user fix missing asset issues


      if (_defaultConstants.EDITOR && missingAssetReporter) {
        missingAssetReporter.reportByOwner();
        callback(null, asset);
      } else {
        callback(errors, asset);
      }
    });
  } // can deferred load raw assets in runtime


  function canDeferredLoad(asset, item, isScene) {
    if (_defaultConstants.EDITOR) {
      return false;
    }

    var res = item.deferredLoadRaw;

    if (res) {
      // check if asset support deferred
      if (asset instanceof cc.Asset && asset.constructor.preventDeferredLoadDependents) {
        res = false;
      }
    } else if (isScene) {
      if (asset instanceof cc.SceneAsset || asset instanceof cc.Prefab) {
        res = asset.asyncLoadAssets; //if (res) {
        //    cc.log('deferred load raw assets for ' + item.id);
        //}
      }
    }

    return res;
  }

  var MissingClass;

  function loadUuid(item, callback) {
    if (_defaultConstants.EDITOR) {
      MissingClass = MissingClass || EditorExtends.MissingReporter.classInstance;
    }

    var json;

    if (typeof item.content === 'string') {
      try {
        json = JSON.parse(item.content);

        if (!_defaultConstants.DEBUG && json.keys && json.data) {
          var keys = json.keys;
          json = json.data;
          (0, _utils.decompressJson)(json, keys);
        }
      } catch (e) {
        return new Error((0, _debug.getError)(4923, item.id, e.stack));
      }
    } else if (_typeof(item.content) === 'object') {
      json = item.content;
    } else {
      return new Error((0, _debug.getError)(4924));
    }

    if (json === undefined || json === null) {
      return new Error((0, _debug.getError)(4923, item.id));
    }

    var classFinder;
    var isScene = isSceneObj(json);

    if (isScene) {
      if (_defaultConstants.EDITOR) {
        MissingClass.hasMissingClass = false;

        classFinder = function classFinder(type, data, owner, propName) {
          var res = MissingClass.classFinder(type, data, owner, propName);

          if (res) {
            return res;
          }

          return cc._MissingScript.getMissingWrapper(type, data);
        };

        classFinder.onDereferenced = MissingClass.classFinder.onDereferenced;
      } else {
        classFinder = cc._MissingScript.safeFindClass;
      }
    } else {
      classFinder = function classFinder(id) {
        var cls = js._getClassById(id);

        if (cls) {
          return cls;
        }

        cc.warnID(4903, id);
        return Object;
      };
    }

    var tdInfo = cc.deserialize.Details.pool.get();
    var asset;

    try {
      asset = cc.deserialize(json, tdInfo, {
        classFinder: classFinder,
        target: item.existingAsset,
        customEnv: item
      });
    } catch (e) {
      cc.deserialize.Details.pool.put(tdInfo);
      console.error(e);
      return new Error("Failed to load asset ".concat(item.id, ", exception occurs during deserialization: ").concat(_defaultConstants.JSB ? e + '\n' + e.stack : e.stack, ".")); // return new Error(debug.getError(4925, item.id, err));
    }

    asset._uuid = item.uuid;

    if (_defaultConstants.EDITOR && isScene && MissingClass.hasMissingClass) {
      MissingClass.reportMissingClass(asset);
    }

    var deferredLoad = canDeferredLoad(asset, item, isScene);
    var depends = parseDepends(item, asset, tdInfo, deferredLoad);
    cc.deserialize.Details.pool.put(tdInfo);

    var wrappedCallback = function wrappedCallback(err, asset) {
      if (!err && asset.onLoaded) {
        try {
          asset.onLoaded();
        } catch (error) {
          err = error;
        }
      }

      if (_defaultConstants.EDITOR && !isScene) {
        // @ts-ignore
        var propSetter = function propSetter(asset, obj, propName, oldAsset, newAsset) {
          if (oldAsset === newAsset || obj[propName] === newAsset) {
            return;
          }

          if (asset instanceof cc.Material && newAsset instanceof cc.Texture2D) {
            for (var i = 0, l = asset.passes.length; i < l; i++) {
              if (asset.getProperty(propName, i) === oldAsset) {
                asset.setProperty(propName, newAsset, i);
              }
            }
          } else {
            obj[propName] = newAsset;
            asset.onLoaded && asset.onLoaded();
          }

          dependListener.emit(asset._uuid, asset);
          assetListener.emit(asset._uuid, asset);
        };

        var dependListener = cc.AssetLibrary.dependListener;
        var assetListener = cc.AssetLibrary.assetListener;
        ;

        if (dependListener) {
          item.references = {};

          for (var i = 0, l = depends.length; i < l; i++) {
            var dep = depends[i];
            var dependSrc = dep.uuid;

            if (dependSrc) {
              var dependObj = dep._owner;
              var dependProp = dep._ownerProp;
              var onDirty = propSetter.bind(null, asset, dependObj, dependProp);
              dependListener.on(dependSrc, onDirty);
              item.references[dependSrc] = onDirty;
            }
          }
        }
      }

      callback(err, asset);
    };

    if (depends.length === 0) {
      return wrappedCallback(null, asset);
    } // @ts-ignore


    loadDepends(this.pipeline, item, asset, depends, wrappedCallback);
  }

  loadUuid.isSceneObj = isSceneObj;
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkY6L2plbmtpbnMvd29ya3NwYWNlL0NyZWF0b3JfM0QvZWRpdG9yLTNkL3Jlc291cmNlcy8zZC9lbmdpbmUvY29jb3MvY29yZS9sb2FkLXBpcGVsaW5lL3V1aWQtbG9hZGVyLnRzIl0sIm5hbWVzIjpbImlzU2NlbmVPYmoiLCJqc29uIiwiU0NFTkVfSUQiLCJQUkVGQUJfSUQiLCJfX3R5cGVfXyIsInBhcnNlRGVwZW5kcyIsIml0ZW0iLCJhc3NldCIsInRkSW5mbyIsImRlZmVycmVkTG9hZFJhd0Fzc2V0c0luUnVudGltZSIsInV1aWRMaXN0Iiwib2JqTGlzdCIsInV1aWRPYmpMaXN0IiwicHJvcExpc3QiLCJ1dWlkUHJvcExpc3QiLCJzdGlsbFVzZVVybCIsIl9zdGlsbFVzZVVybCIsImRlcGVuZHMiLCJpIiwiZGVwZW5kVXVpZCIsImRlcGVuZEtleXMiLCJsZW5ndGgiLCJvYmoiLCJwcm9wIiwiaW5mbyIsImNjIiwiQXNzZXRMaWJyYXJ5IiwiX2dldEFzc2V0SW5mb0luUnVudGltZSIsInJhdyIsInVybCIsInB1c2giLCJ0eXBlIiwidXVpZCIsImRlZmVycmVkTG9hZFJhdyIsIl9vd25lciIsIl9vd25lclByb3AiLCJBcnJheSIsIl9uYXRpdmUiLCJjb25zdHJ1Y3RvciIsInByZXZlbnRQcmVsb2FkTmF0aXZlT2JqZWN0IiwibmF0aXZlVXJsIiwibG9hZERlcGVuZHMiLCJwaXBlbGluZSIsImNhbGxiYWNrIiwiY29udGVudCIsImZsb3dJbkRlcHMiLCJlcnJvcnMiLCJpdGVtcyIsIm1pc3NpbmdBc3NldFJlcG9ydGVyIiwiaXRlbXNNYXAiLCJtYXAiLCJzcmMiLCJfdXVpZCIsImxvYWRDYWxsYmFjayIsInZhbHVlIiwicmF3VXJsIiwiaW5kZXhPZiIsImlkIiwiZGVwIiwiZGVwZW5kU3JjIiwiZGVwZW5kVXJsIiwiZGVwZW5kT2JqIiwiZGVwZW5kUHJvcCIsImxvYWRDYWxsYmFja0N0eCIsImNvbXBsZXRlIiwiZXJyb3IiLCJFRElUT1IiLCJlcnJvckNvZGUiLCJFZGl0b3JFeHRlbmRzIiwiTWlzc2luZ1JlcG9ydGVyIiwib2JqZWN0Iiwic3Rhc2hCeU93bmVyIiwic2VyaWFsaXplIiwiYXNBc3NldCIsIl90aHJvdyIsImNhbGwiLCJxdWV1ZSIsIkxvYWRpbmdJdGVtcyIsImdldFF1ZXVlIiwiYWRkTGlzdGVuZXIiLCJyZXBvcnRCeU93bmVyIiwiY2FuRGVmZXJyZWRMb2FkIiwiaXNTY2VuZSIsInJlcyIsIkFzc2V0IiwicHJldmVudERlZmVycmVkTG9hZERlcGVuZGVudHMiLCJTY2VuZUFzc2V0IiwiUHJlZmFiIiwiYXN5bmNMb2FkQXNzZXRzIiwiTWlzc2luZ0NsYXNzIiwibG9hZFV1aWQiLCJjbGFzc0luc3RhbmNlIiwiSlNPTiIsInBhcnNlIiwiREVCVUciLCJrZXlzIiwiZGF0YSIsImUiLCJFcnJvciIsInN0YWNrIiwidW5kZWZpbmVkIiwiY2xhc3NGaW5kZXIiLCJoYXNNaXNzaW5nQ2xhc3MiLCJvd25lciIsInByb3BOYW1lIiwiX01pc3NpbmdTY3JpcHQiLCJnZXRNaXNzaW5nV3JhcHBlciIsIm9uRGVyZWZlcmVuY2VkIiwic2FmZUZpbmRDbGFzcyIsImNscyIsImpzIiwiX2dldENsYXNzQnlJZCIsIndhcm5JRCIsIk9iamVjdCIsImRlc2VyaWFsaXplIiwiRGV0YWlscyIsInBvb2wiLCJnZXQiLCJ0YXJnZXQiLCJleGlzdGluZ0Fzc2V0IiwiY3VzdG9tRW52IiwicHV0IiwiY29uc29sZSIsIkpTQiIsInJlcG9ydE1pc3NpbmdDbGFzcyIsImRlZmVycmVkTG9hZCIsIndyYXBwZWRDYWxsYmFjayIsImVyciIsIm9uTG9hZGVkIiwicHJvcFNldHRlciIsIm9sZEFzc2V0IiwibmV3QXNzZXQiLCJNYXRlcmlhbCIsIlRleHR1cmUyRCIsImwiLCJwYXNzZXMiLCJnZXRQcm9wZXJ0eSIsInNldFByb3BlcnR5IiwiZGVwZW5kTGlzdGVuZXIiLCJlbWl0IiwiYXNzZXRMaXN0ZW5lciIsInJlZmVyZW5jZXMiLCJvbkRpcnR5IiwiYmluZCIsIm9uIl0sIm1h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UixLQUFtQixDQUF2QixFQUEwQjtBQUN0QixhQUFPeUcsZUFBZSxDQUFDLElBQUQsRUFBT3ZILEtBQVAsQ0FBdEI7QUFDSCxLQTNJcUMsQ0E2SXRDOzs7QUFDQWtDLElBQUFBLFdBQVcsQ0FBQyxLQUFLQyxRQUFOLEVBQWdCcEMsSUFBaEIsRUFBc0JDLEtBQXRCLEVBQTZCVSxPQUE3QixFQUFzQzZHLGVBQXRDLENBQVg7QUFDSDs7QUFFRHBDLEVBQUFBLFFBQVEsQ0FBQzFGLFVBQVQsR0FBc0JBLFVBQXRCIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuIENvcHlyaWdodCAoYykgMjAxMy0yMDE2IENodWtvbmcgVGVjaG5vbG9naWVzIEluYy5cclxuIENvcHlyaWdodCAoYykgMjAxNy0yMDE4IFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLlxyXG5cclxuIGh0dHA6Ly93d3cuY29jb3MuY29tXHJcblxyXG4gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxyXG4gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBlbmdpbmUgc291cmNlIGNvZGUgKHRoZSBcIlNvZnR3YXJlXCIpLCBhIGxpbWl0ZWQsXHJcbiAgd29ybGR3aWRlLCByb3lhbHR5LWZyZWUsIG5vbi1hc3NpZ25hYmxlLCByZXZvY2FibGUgYW5kIG5vbi1leGNsdXNpdmUgbGljZW5zZVxyXG4gdG8gdXNlIENvY29zIENyZWF0b3Igc29sZWx5IHRvIGRldmVsb3AgZ2FtZXMgb24geW91ciB0YXJnZXQgcGxhdGZvcm1zLiBZb3Ugc2hhbGxcclxuICBub3QgdXNlIENvY29zIENyZWF0b3Igc29mdHdhcmUgZm9yIGRldmVsb3Bpbmcgb3RoZXIgc29mdHdhcmUgb3IgdG9vbHMgdGhhdCdzXHJcbiAgdXNlZCBmb3IgZGV2ZWxvcGluZyBnYW1lcy4gWW91IGFyZSBub3QgZ3JhbnRlZCB0byBwdWJsaXNoLCBkaXN0cmlidXRlLFxyXG4gIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiBDb2NvcyBDcmVhdG9yLlxyXG5cclxuIFRoZSBzb2Z0d2FyZSBvciB0b29scyBpbiB0aGlzIExpY2Vuc2UgQWdyZWVtZW50IGFyZSBsaWNlbnNlZCwgbm90IHNvbGQuXHJcbiBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC4gcmVzZXJ2ZXMgYWxsIHJpZ2h0cyBub3QgZXhwcmVzc2x5IGdyYW50ZWQgdG8geW91LlxyXG5cclxuIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcclxuIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxyXG4gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXHJcbiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXHJcbiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxyXG4gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxyXG4gVEhFIFNPRlRXQVJFLlxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiBAaGlkZGVuXHJcbiAqL1xyXG5cclxuaW1wb3J0ICogYXMganMgZnJvbSAnLi4vdXRpbHMvanMnO1xyXG5pbXBvcnQge19nZXRDbGFzc0J5SWR9IGZyb20gJy4uL3V0aWxzL2pzJztcclxuaW1wb3J0IHsgZ2V0RXJyb3IgfSBmcm9tICcuLi9wbGF0Zm9ybS9kZWJ1Zyc7XHJcbmltcG9ydCB7IExvYWRpbmdJdGVtcyB9IGZyb20gJy4vbG9hZGluZy1pdGVtcyc7XHJcbmltcG9ydCB7IGRlY29tcHJlc3NKc29uIH0gZnJvbSAnLi91dGlscyc7XHJcbmltcG9ydCB7IEVESVRPUiwgREVCVUcsIEpTQiB9IGZyb20gJ2ludGVybmFsOmNvbnN0YW50cyc7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNTY2VuZU9iaiAoanNvbikge1xyXG4gICAgbGV0IFNDRU5FX0lEID0gJ2NjLlNjZW5lJztcclxuICAgIGxldCBQUkVGQUJfSUQgPSAnY2MuUHJlZmFiJztcclxuICAgIHJldHVybiBqc29uICYmIChcclxuICAgICAgICAgICAgICAgKGpzb25bMF0gJiYganNvblswXS5fX3R5cGVfXyA9PT0gU0NFTkVfSUQpIHx8XHJcbiAgICAgICAgICAgICAgIChqc29uWzFdICYmIGpzb25bMV0uX190eXBlX18gPT09IFNDRU5FX0lEKSB8fFxyXG4gICAgICAgICAgICAgICAoanNvblswXSAmJiBqc29uWzBdLl9fdHlwZV9fID09PSBQUkVGQUJfSUQpXHJcbiAgICAgICAgICAgKTtcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VEZXBlbmRzIChpdGVtLCBhc3NldCwgdGRJbmZvLCBkZWZlcnJlZExvYWRSYXdBc3NldHNJblJ1bnRpbWUpIHtcclxuICAgIGxldCB1dWlkTGlzdCA9IHRkSW5mby51dWlkTGlzdDtcclxuICAgIGxldCBvYmpMaXN0ID0gdGRJbmZvLnV1aWRPYmpMaXN0O1xyXG4gICAgbGV0IHByb3BMaXN0ID0gdGRJbmZvLnV1aWRQcm9wTGlzdDtcclxuICAgIGxldCBzdGlsbFVzZVVybCA9IHRkSW5mby5fc3RpbGxVc2VVcmw7XHJcbiAgICBsZXQgZGVwZW5kcztcclxuICAgIGxldCBpLCBkZXBlbmRVdWlkO1xyXG4gICAgLy8gY2FjaGUgZGVwZW5kZW5jaWVzIGZvciBhdXRvIHJlbGVhc2VcclxuICAgIGxldCBkZXBlbmRLZXlzOiBBcnJheTxzdHJpbmc+ID0gaXRlbS5kZXBlbmRLZXlzID0gW107XHJcblxyXG4gICAgaWYgKGRlZmVycmVkTG9hZFJhd0Fzc2V0c0luUnVudGltZSkge1xyXG4gICAgICAgIGRlcGVuZHMgPSBbXTtcclxuICAgICAgICAvLyBwYXJzZSBkZXBlbmRzIGFzc2V0c1xyXG4gICAgICAgIGZvciAoaSA9IDA7IGkgPCB1dWlkTGlzdC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBkZXBlbmRVdWlkID0gdXVpZExpc3RbaV07XHJcbiAgICAgICAgICAgIGxldCBvYmogPSBvYmpMaXN0W2ldO1xyXG4gICAgICAgICAgICBsZXQgcHJvcCA9IHByb3BMaXN0W2ldO1xyXG4gICAgICAgICAgICBsZXQgaW5mbyA9IGNjLkFzc2V0TGlicmFyeS5fZ2V0QXNzZXRJbmZvSW5SdW50aW1lKGRlcGVuZFV1aWQpO1xyXG4gICAgICAgICAgICBpZiAoaW5mby5yYXcpIHtcclxuICAgICAgICAgICAgICAgIC8vIHNraXAgcHJlbG9hZGluZyByYXcgYXNzZXRzXHJcbiAgICAgICAgICAgICAgICBsZXQgdXJsID0gaW5mby51cmw7XHJcbiAgICAgICAgICAgICAgICBvYmpbcHJvcF0gPSB1cmw7XHJcbiAgICAgICAgICAgICAgICBkZXBlbmRLZXlzLnB1c2godXJsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIGRlY2xhcmUgZGVwZW5kcyBhc3NldHNcclxuICAgICAgICAgICAgICAgIGRlcGVuZHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3V1aWQnLFxyXG4gICAgICAgICAgICAgICAgICAgIHV1aWQ6IGRlcGVuZFV1aWQsXHJcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWRMb2FkUmF3OiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIF9vd25lcjogb2JqLFxyXG4gICAgICAgICAgICAgICAgICAgIF9vd25lclByb3A6IHByb3AsXHJcbiAgICAgICAgICAgICAgICAgICAgX3N0aWxsVXNlVXJsOiBzdGlsbFVzZVVybFtpXVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBkZXBlbmRzID0gbmV3IEFycmF5KHV1aWRMaXN0Lmxlbmd0aCk7XHJcblxyXG4gICAgICAgIC8vIGRlY2xhcmUgZGVwZW5kcyBhc3NldHNcclxuICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdXVpZExpc3QubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgZGVwZW5kVXVpZCA9IHV1aWRMaXN0W2ldO1xyXG4gICAgICAgICAgICBkZXBlbmRzW2ldID0ge1xyXG4gICAgICAgICAgICAgICAgdHlwZTogJ3V1aWQnLFxyXG4gICAgICAgICAgICAgICAgdXVpZDogZGVwZW5kVXVpZCxcclxuICAgICAgICAgICAgICAgIF9vd25lcjogb2JqTGlzdFtpXSxcclxuICAgICAgICAgICAgICAgIF9vd25lclByb3A6IHByb3BMaXN0W2ldLFxyXG4gICAgICAgICAgICAgICAgX3N0aWxsVXNlVXJsOiBzdGlsbFVzZVVybFtpXVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gbG9hZCBuYXRpdmUgb2JqZWN0IChJbWFnZS9BdWRpbykgYXMgZGVwZW5kc1xyXG4gICAgICAgIGlmIChhc3NldC5fbmF0aXZlICYmICFhc3NldC5jb25zdHJ1Y3Rvci5wcmV2ZW50UHJlbG9hZE5hdGl2ZU9iamVjdCkge1xyXG4gICAgICAgICAgICBkZXBlbmRzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgdXJsOiBhc3NldC5uYXRpdmVVcmwsXHJcbiAgICAgICAgICAgICAgICBfb3duZXI6IGFzc2V0LFxyXG4gICAgICAgICAgICAgICAgX293bmVyUHJvcDogJ19uYXRpdmVBc3NldCcsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZGVwZW5kcztcclxufVxyXG5cclxuZnVuY3Rpb24gbG9hZERlcGVuZHMgKHBpcGVsaW5lLCBpdGVtLCBhc3NldCwgZGVwZW5kcywgY2FsbGJhY2spIHtcclxuICAgIC8vIFByZWRlZmluZSBjb250ZW50IGZvciBkZXBlbmRlbmNpZXMgdXNhZ2VcclxuICAgIGl0ZW0uY29udGVudCA9IGFzc2V0O1xyXG4gICAgbGV0IGRlcGVuZEtleXMgPSBpdGVtLmRlcGVuZEtleXM7XHJcbiAgICBwaXBlbGluZS5mbG93SW5EZXBzKGl0ZW0sIGRlcGVuZHMsIGZ1bmN0aW9uIChlcnJvcnMsIGl0ZW1zKSB7XHJcbiAgICAgICAgbGV0IGl0ZW0sIG1pc3NpbmdBc3NldFJlcG9ydGVyO1xyXG4gICAgICAgIGxldCBpdGVtc01hcCA9IGl0ZW1zLm1hcDtcclxuICAgICAgICBmb3IgKGxldCBzcmMgaW4gaXRlbXNNYXApIHtcclxuICAgICAgICAgICAgaXRlbSA9IGl0ZW1zTWFwW3NyY107XHJcbiAgICAgICAgICAgIGlmIChpdGVtLnV1aWQgJiYgaXRlbS5jb250ZW50KSB7XHJcbiAgICAgICAgICAgICAgICBpdGVtLmNvbnRlbnQuX3V1aWQgPSBpdGVtLnV1aWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXBlbmRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGxldCBkZXAgPSBkZXBlbmRzW2ldO1xyXG4gICAgICAgICAgICBsZXQgZGVwZW5kU3JjID0gZGVwLnV1aWQ7XHJcbiAgICAgICAgICAgIGxldCBkZXBlbmRVcmwgPSBkZXAudXJsO1xyXG4gICAgICAgICAgICBsZXQgZGVwZW5kT2JqID0gZGVwLl9vd25lcjtcclxuICAgICAgICAgICAgbGV0IGRlcGVuZFByb3AgPSBkZXAuX293bmVyUHJvcDtcclxuICAgICAgICAgICAgaXRlbSA9IGl0ZW1zTWFwW2RlcGVuZFVybF07XHJcbiAgICAgICAgICAgIGlmICghaXRlbSkge1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCBsb2FkQ2FsbGJhY2tDdHggPSBkZXA7XHJcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgZnVuY3Rpb24gbG9hZENhbGxiYWNrIChpdGVtKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgdmFsdWUgPSBpdGVtLmNvbnRlbnQ7XHJcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fc3RpbGxVc2VVcmwpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlID8gdmFsdWUubmF0aXZlVXJsIDogaXRlbS5yYXdVcmw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICB0aGlzLl9vd25lclt0aGlzLl9vd25lclByb3BdID0gdmFsdWU7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbS51dWlkICE9PSBhc3NldC5fdXVpZCAmJiBkZXBlbmRLZXlzLmluZGV4T2YoaXRlbS5pZCkgPCAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVwZW5kS2V5cy5wdXNoKGl0ZW0uaWQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoaXRlbS5jb21wbGV0ZSB8fCBpdGVtLmNvbnRlbnQpIHtcclxuICAgICAgICAgICAgICAgIGlmIChpdGVtLmVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKEVESVRPUiAmJiBpdGVtLmVycm9yLmVycm9yQ29kZSA9PT0gJ2RiLk5PVEZPVU5EJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW1pc3NpbmdBc3NldFJlcG9ydGVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaXNzaW5nQXNzZXRSZXBvcnRlciA9IG5ldyBFZGl0b3JFeHRlbmRzLk1pc3NpbmdSZXBvcnRlci5vYmplY3QoYXNzZXQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1pc3NpbmdBc3NldFJlcG9ydGVyLnN0YXNoQnlPd25lcihkZXBlbmRPYmosIGRlcGVuZFByb3AsIEVkaXRvckV4dGVuZHMuc2VyaWFsaXplLmFzQXNzZXQoZGVwZW5kU3JjKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYy5fdGhyb3coaXRlbS5lcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9hZENhbGxiYWNrLmNhbGwobG9hZENhbGxiYWNrQ3R4LCBpdGVtKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIGl0ZW0gd2FzIHJlbW92ZWQgZnJvbSBjYWNoZSwgYnV0IHJlYWR5IGluIHBpcGVsaW5lIGFjdHVhbGx5XHJcbiAgICAgICAgICAgICAgICBsZXQgcXVldWUgPSBMb2FkaW5nSXRlbXMuZ2V0UXVldWUoaXRlbSk7XHJcbiAgICAgICAgICAgICAgICBpZiAocXVldWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBxdWV1ZS5hZGRMaXN0ZW5lcihkZXBlbmRTcmMsIGxvYWRDYWxsYmFjaywgbG9hZENhbGxiYWNrQ3R4KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBFbWl0IGRlcGVuZGVuY3kgZXJyb3JzIGluIHJ1bnRpbWUsIGJ1dCBub3QgaW4gZWRpdG9yLFxyXG4gICAgICAgIC8vIGJlY2F1c2UgZWRpdG9yIG5lZWQgdG8gb3BlbiB0aGUgc2NlbmUgLyBwcmVmYWIgdG8gbGV0IHVzZXIgZml4IG1pc3NpbmcgYXNzZXQgaXNzdWVzXHJcbiAgICAgICAgaWYgKEVESVRPUiAmJiBtaXNzaW5nQXNzZXRSZXBvcnRlcikge1xyXG4gICAgICAgICAgICBtaXNzaW5nQXNzZXRSZXBvcnRlci5yZXBvcnRCeU93bmVyKCk7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGFzc2V0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKGVycm9ycywgYXNzZXQpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59XHJcblxyXG4vLyBjYW4gZGVmZXJyZWQgbG9hZCByYXcgYXNzZXRzIGluIHJ1bnRpbWVcclxuZnVuY3Rpb24gY2FuRGVmZXJyZWRMb2FkIChhc3NldCwgaXRlbSwgaXNTY2VuZSkge1xyXG4gICAgaWYgKEVESVRPUikge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGxldCByZXMgPSBpdGVtLmRlZmVycmVkTG9hZFJhdztcclxuICAgIGlmIChyZXMpIHtcclxuICAgICAgICAvLyBjaGVjayBpZiBhc3NldCBzdXBwb3J0IGRlZmVycmVkXHJcbiAgICAgICAgaWYgKChhc3NldCBpbnN0YW5jZW9mIGNjLkFzc2V0KSAmJiBhc3NldC5jb25zdHJ1Y3Rvci5wcmV2ZW50RGVmZXJyZWRMb2FkRGVwZW5kZW50cykge1xyXG4gICAgICAgICAgICByZXMgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmIChpc1NjZW5lKSB7XHJcbiAgICAgICAgaWYgKGFzc2V0IGluc3RhbmNlb2YgY2MuU2NlbmVBc3NldCB8fCBhc3NldCBpbnN0YW5jZW9mIGNjLlByZWZhYikge1xyXG4gICAgICAgICAgICByZXMgPSBhc3NldC5hc3luY0xvYWRBc3NldHM7XHJcbiAgICAgICAgICAgIC8vaWYgKHJlcykge1xyXG4gICAgICAgICAgICAvLyAgICBjYy5sb2coJ2RlZmVycmVkIGxvYWQgcmF3IGFzc2V0cyBmb3IgJyArIGl0ZW0uaWQpO1xyXG4gICAgICAgICAgICAvL31cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzO1xyXG59XHJcblxyXG5sZXQgTWlzc2luZ0NsYXNzO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRVdWlkIChpdGVtLCBjYWxsYmFjaykge1xyXG4gICAgaWYgKEVESVRPUikge1xyXG4gICAgICAgIE1pc3NpbmdDbGFzcyA9IE1pc3NpbmdDbGFzcyB8fCBFZGl0b3JFeHRlbmRzLk1pc3NpbmdSZXBvcnRlci5jbGFzc0luc3RhbmNlO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBqc29uO1xyXG4gICAgaWYgKHR5cGVvZiBpdGVtLmNvbnRlbnQgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAganNvbiA9IEpTT04ucGFyc2UoaXRlbS5jb250ZW50KTtcclxuICAgICAgICAgICAgaWYgKCFERUJVRyAmJiBqc29uLmtleXMgJiYganNvbi5kYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQga2V5cyA9IGpzb24ua2V5cztcclxuICAgICAgICAgICAgICAgIGpzb24gPSBqc29uLmRhdGE7XHJcbiAgICAgICAgICAgICAgICBkZWNvbXByZXNzSnNvbihqc29uLCBrZXlzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IEVycm9yKGdldEVycm9yKDQ5MjMsIGl0ZW0uaWQsIGUuc3RhY2spKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICh0eXBlb2YgaXRlbS5jb250ZW50ID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgIGpzb24gPSBpdGVtLmNvbnRlbnQ7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICByZXR1cm4gbmV3IEVycm9yKGdldEVycm9yKDQ5MjQpKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoanNvbiA9PT0gdW5kZWZpbmVkIHx8IGpzb24gPT09IG51bGwpIHtcclxuICAgICAgICByZXR1cm4gbmV3IEVycm9yKGdldEVycm9yKDQ5MjMsIGl0ZW0uaWQpKTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgY2xhc3NGaW5kZXI7XHJcbiAgICBsZXQgaXNTY2VuZSA9IGlzU2NlbmVPYmooanNvbik7XHJcbiAgICBpZiAoaXNTY2VuZSkge1xyXG4gICAgICAgIGlmIChFRElUT1IpIHtcclxuICAgICAgICAgICAgTWlzc2luZ0NsYXNzLmhhc01pc3NpbmdDbGFzcyA9IGZhbHNlO1xyXG4gICAgICAgICAgICBjbGFzc0ZpbmRlciA9IGZ1bmN0aW9uICh0eXBlLCBkYXRhLCBvd25lciwgcHJvcE5hbWUpIHtcclxuICAgICAgICAgICAgICAgIGxldCByZXMgPSBNaXNzaW5nQ2xhc3MuY2xhc3NGaW5kZXIodHlwZSwgZGF0YSwgb3duZXIsIHByb3BOYW1lKTtcclxuICAgICAgICAgICAgICAgIGlmIChyZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNjLl9NaXNzaW5nU2NyaXB0LmdldE1pc3NpbmdXcmFwcGVyKHR5cGUsIGRhdGEpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjbGFzc0ZpbmRlci5vbkRlcmVmZXJlbmNlZCA9IE1pc3NpbmdDbGFzcy5jbGFzc0ZpbmRlci5vbkRlcmVmZXJlbmNlZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGNsYXNzRmluZGVyID0gY2MuX01pc3NpbmdTY3JpcHQuc2FmZUZpbmRDbGFzcztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBjbGFzc0ZpbmRlciA9IGZ1bmN0aW9uIChpZCkge1xyXG4gICAgICAgICAgICBsZXQgY2xzID0ganMuX2dldENsYXNzQnlJZChpZCk7XHJcbiAgICAgICAgICAgIGlmIChjbHMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBjbHM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2Mud2FybklEKDQ5MDMsIGlkKTtcclxuICAgICAgICAgICAgcmV0dXJuIE9iamVjdDtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGxldCB0ZEluZm8gPSBjYy5kZXNlcmlhbGl6ZS5EZXRhaWxzLnBvb2wuZ2V0KCk7XHJcblxyXG4gICAgbGV0IGFzc2V0O1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBhc3NldCA9IGNjLmRlc2VyaWFsaXplKGpzb24sIHRkSW5mbywge1xyXG4gICAgICAgICAgICBjbGFzc0ZpbmRlcjogY2xhc3NGaW5kZXIsXHJcbiAgICAgICAgICAgIHRhcmdldDogaXRlbS5leGlzdGluZ0Fzc2V0LFxyXG4gICAgICAgICAgICBjdXN0b21FbnY6IGl0ZW1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgY2MuZGVzZXJpYWxpemUuRGV0YWlscy5wb29sLnB1dCh0ZEluZm8pO1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBFcnJvcihgRmFpbGVkIHRvIGxvYWQgYXNzZXQgJHtpdGVtLmlkfSwgZXhjZXB0aW9uIG9jY3VycyBkdXJpbmcgZGVzZXJpYWxpemF0aW9uOiAke0pTQiA/IChlICsgJ1xcbicgKyBlLnN0YWNrKSA6IGUuc3RhY2t9LmApO1xyXG4gICAgICAgIC8vIHJldHVybiBuZXcgRXJyb3IoZGVidWcuZ2V0RXJyb3IoNDkyNSwgaXRlbS5pZCwgZXJyKSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXNzZXQuX3V1aWQgPSBpdGVtLnV1aWQ7XHJcblxyXG4gICAgaWYgKEVESVRPUiAmJiBpc1NjZW5lICYmIE1pc3NpbmdDbGFzcy5oYXNNaXNzaW5nQ2xhc3MpIHtcclxuICAgICAgICBNaXNzaW5nQ2xhc3MucmVwb3J0TWlzc2luZ0NsYXNzKGFzc2V0KTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgZGVmZXJyZWRMb2FkID0gY2FuRGVmZXJyZWRMb2FkKGFzc2V0LCBpdGVtLCBpc1NjZW5lKTtcclxuICAgIGxldCBkZXBlbmRzID0gcGFyc2VEZXBlbmRzKGl0ZW0sIGFzc2V0LCB0ZEluZm8sIGRlZmVycmVkTG9hZCk7XHJcblxyXG4gICAgY2MuZGVzZXJpYWxpemUuRGV0YWlscy5wb29sLnB1dCh0ZEluZm8pO1xyXG5cclxuICAgIGxldCB3cmFwcGVkQ2FsbGJhY2sgPSBmdW5jdGlvbihlcnIsIGFzc2V0KSB7XHJcbiAgICAgICAgaWYgKCFlcnIgJiYgYXNzZXQub25Mb2FkZWQpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGFzc2V0Lm9uTG9hZGVkKCk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2goZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIGVyciA9IGVycm9yO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChFRElUT1IgJiYgIWlzU2NlbmUpIHtcclxuICAgICAgICAgICAgbGV0IGRlcGVuZExpc3RlbmVyID0gY2MuQXNzZXRMaWJyYXJ5LmRlcGVuZExpc3RlbmVyO1xyXG4gICAgICAgICAgICBsZXQgYXNzZXRMaXN0ZW5lciA9IGNjLkFzc2V0TGlicmFyeS5hc3NldExpc3RlbmVyO1xyXG5cclxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICBmdW5jdGlvbiBwcm9wU2V0dGVyIChhc3NldCwgb2JqLCBwcm9wTmFtZSwgb2xkQXNzZXQsIG5ld0Fzc2V0KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAob2xkQXNzZXQgPT09IG5ld0Fzc2V0IHx8IG9ialtwcm9wTmFtZV0gPT09IG5ld0Fzc2V0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGFzc2V0IGluc3RhbmNlb2YgY2MuTWF0ZXJpYWwgJiYgbmV3QXNzZXQgaW5zdGFuY2VvZiBjYy5UZXh0dXJlMkQpIHtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGFzc2V0LnBhc3Nlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFzc2V0LmdldFByb3BlcnR5KHByb3BOYW1lLCBpKSA9PT0gb2xkQXNzZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0LnNldFByb3BlcnR5KHByb3BOYW1lLCBuZXdBc3NldCwgaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIG9ialtwcm9wTmFtZV0gPSBuZXdBc3NldDtcclxuICAgICAgICAgICAgICAgICAgICBhc3NldC5vbkxvYWRlZCAmJiBhc3NldC5vbkxvYWRlZCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGRlcGVuZExpc3RlbmVyLmVtaXQoYXNzZXQuX3V1aWQsIGFzc2V0KTtcclxuICAgICAgICAgICAgICAgIGFzc2V0TGlzdGVuZXIuZW1pdChhc3NldC5fdXVpZCwgYXNzZXQpO1xyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgaWYgKGRlcGVuZExpc3RlbmVyKSB7XHJcbiAgICAgICAgICAgICAgICBpdGVtLnJlZmVyZW5jZXMgPSB7fTtcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gZGVwZW5kcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgZGVwID0gZGVwZW5kc1tpXTtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgZGVwZW5kU3JjID0gZGVwLnV1aWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRlcGVuZFNyYykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGVwZW5kT2JqID0gZGVwLl9vd25lcjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRlcGVuZFByb3AgPSBkZXAuX293bmVyUHJvcDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG9uRGlydHkgPSBwcm9wU2V0dGVyLmJpbmQobnVsbCwgYXNzZXQsIGRlcGVuZE9iaiwgZGVwZW5kUHJvcCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlcGVuZExpc3RlbmVyLm9uKGRlcGVuZFNyYywgb25EaXJ0eSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0ucmVmZXJlbmNlc1tkZXBlbmRTcmNdID0gb25EaXJ0eTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY2FsbGJhY2soZXJyLCBhc3NldCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGlmIChkZXBlbmRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIHJldHVybiB3cmFwcGVkQ2FsbGJhY2sobnVsbCwgYXNzZXQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEB0cy1pZ25vcmVcclxuICAgIGxvYWREZXBlbmRzKHRoaXMucGlwZWxpbmUsIGl0ZW0sIGFzc2V0LCBkZXBlbmRzLCB3cmFwcGVkQ2FsbGJhY2spO1xyXG59XHJcblxyXG5sb2FkVXVpZC5pc1NjZW5lT2JqID0gaXNTY2VuZU9iajtcclxuIl19