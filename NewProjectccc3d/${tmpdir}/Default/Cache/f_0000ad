(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../utils/js.js", "../assets/raw-asset.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../utils/js.js"), require("../assets/raw-asset.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.js, global.rawAsset);
    global.autoReleaseUtils = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _js, _rawAsset) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.autoRelease = autoRelease;
  _exports.getDependsRecursively = getDependsRecursively;

  function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

  function parseDepends(key, parsed) {
    var item = cc.loader.getItem(key);

    if (item) {
      var depends = item.dependKeys;

      if (depends) {
        for (var i = 0; i < depends.length; i++) {
          var depend = depends[i];

          if (!parsed[depend]) {
            parsed[depend] = true;
            parseDepends(depend, parsed);
          }
        }
      }
    }
  }

  function visitAsset(asset, excludeMap) {
    // Skip assets generated programmatically or by user (e.g. label texture)
    if (!asset._uuid) {
      return;
    }

    var key = cc.loader._getReferenceKey(asset);

    if (!excludeMap[key]) {
      excludeMap[key] = true;
      parseDepends(key, excludeMap);
    }
  }

  function visitComponent(comp, excludeMap) {
    var props = Object.getOwnPropertyNames(comp);

    for (var i = 0; i < props.length; i++) {
      var value = comp[props[i]];

      if (_typeof(value) === 'object' && value) {
        if (Array.isArray(value)) {
          for (var j = 0; j < value.length; j++) {
            var val = value[j];

            if (val instanceof _rawAsset.RawAsset) {
              visitAsset(val, excludeMap);
            }
          }
        } else if (!value.constructor || value.constructor === Object) {
          var keys = Object.getOwnPropertyNames(value);

          for (var _j = 0; _j < keys.length; _j++) {
            var _val = value[keys[_j]];

            if (_val instanceof _rawAsset.RawAsset) {
              visitAsset(_val, excludeMap);
            }
          }
        } else if (value instanceof _rawAsset.RawAsset) {
          visitAsset(value, excludeMap);
        }
      }
    }
  }

  function visitNode(node, excludeMap) {
    for (var i = 0; i < node._components.length; i++) {
      visitComponent(node._components[i], excludeMap);
    }

    for (var _i = 0; _i < node._children.length; _i++) {
      visitNode(node._children[_i], excludeMap);
    }
  } // do auto release


  function autoRelease(oldSceneAssets, nextSceneAssets, persistNodes) {
    var releaseSettings = cc.loader._autoReleaseSetting;
    var excludeMap = (0, _js.createMap)(); // collect next scene assets

    if (nextSceneAssets) {
      for (var i = 0; i < nextSceneAssets.length; i++) {
        excludeMap[nextSceneAssets[i]] = true;
      }
    } // collect assets used by persist nodes


    for (var _i2 = 0; _i2 < persistNodes.length; _i2++) {
      visitNode(persistNodes[_i2], excludeMap);
    } // remove ununsed scene assets


    if (oldSceneAssets) {
      for (var _i3 = 0; _i3 < oldSceneAssets.length; _i3++) {
        var key = oldSceneAssets[_i3];

        if (releaseSettings[key] !== false && !excludeMap[key]) {
          cc.loader.release(key);
        }
      }
    } // remove auto release assets
    // (releasing asset will change _autoReleaseSetting, so don't use for-in)


    var keys = Object.keys(releaseSettings);

    for (var _i4 = 0; _i4 < keys.length; _i4++) {
      var _key = keys[_i4];

      if (releaseSettings[_key] === true && !excludeMap[_key]) {
        cc.loader.release(_key);
      }
    }
  } // get dependencies not including self


  function getDependsRecursively(key) {
    var depends = {};
    parseDepends(key, depends);
    return Object.keys(depends);
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkY6L2plbmtpbnMvd29ya3NwYWNlL0NyZWF0b3JfM0QvZWRpdG9yLTNkL3Jlc291cmNlcy8zZC9lbmdpbmUvY29jb3MvY29yZS9sb2FkLXBpcGVsaW5lL2F1dG8tcmVsZWFzZS11dGlscy50cyJdLCJuYW1lcyI6WyJwYXJzZURlcGVuZHMiLCJrZXkiLCJwYXJzZWQiLCJpdGVtIiwiY2MiLCJsb2FkZXIiLCJnZXRJdGVtIiwiZGVwZW5kcyIsImRlcGVuZEtleXMiLCJpIiwibGVuZ3RoIiwiZGVwZW5kIiwidmlzaXRBc3NldCIsImFzc2V0IiwiZXhjbHVkZU1hcCIsIl91dWlkIiwiX2dldFJlZmVyZW5jZUtleSIsInZpc2l0Q29tcG9uZW50IiwiY29tcCIsInByb3BzIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlOYW1lcyIsInZhbHVlIiwiQXJyYXkiLCJpc0FycmF5IiwiaiIsInZhbCIsIlJhd0Fzc2V0IiwiY29uc3RydWN0b3IiLCJrZXlzIiwidmlzaXROb2RlIiwibm9kZSIsIl9jb21wb25lbnRzIiwiX2NoaWxkcmVuIiwiYXV0b1JlbGVhc2UiLCJvbGRTY2VuZUFzc2V0cyIsIm5leHRTY2VuZUFzc2V0cyIsInBlcnNpc3ROb2RlcyIsInJlbGVhc2VTZXR0aW5ncyIsIl9hdXRvUmVsZWFzZVNldHRpbmciLCJyZWxlYXNlIiwiZ2V0RGVwZW5kc1JlY3Vyc2l2ZWx5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWdDQSxXQUFTQSxZQUFULENBQXVCQyxHQUF2QixFQUE0QkMsTUFBNUIsRUFBb0M7QUFDaEMsUUFBSUMsSUFBSSxHQUFHQyxFQUFFLENBQUNDLE1BQUgsQ0FBVUMsT0FBVixDQUFrQkwsR0FBbEIsQ0FBWDs7QUFDQSxRQUFJRSxJQUFKLEVBQVU7QUFDTixVQUFJSSxPQUFPLEdBQUdKLElBQUksQ0FBQ0ssVUFBbkI7O0FBQ0EsVUFBSUQsT0FBSixFQUFhO0FBQ1QsYUFBSyxJQUFJRSxDQUFDLEdBQUcsQ0FBYixFQUFnQkEs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LEdBQUMsR0FBRzBCLGNBQWMsQ0FBQ3pCLE1BQW5DLEVBQTJDRCxHQUFDLEVBQTVDLEVBQWdEO0FBQzVDLFlBQUlSLEdBQUcsR0FBR2tDLGNBQWMsQ0FBQzFCLEdBQUQsQ0FBeEI7O0FBQ0EsWUFBSTZCLGVBQWUsQ0FBQ3JDLEdBQUQsQ0FBZixLQUF5QixLQUF6QixJQUFrQyxDQUFDYSxVQUFVLENBQUNiLEdBQUQsQ0FBakQsRUFBd0Q7QUFDcERHLFVBQUFBLEVBQUUsQ0FBQ0MsTUFBSCxDQUFVbUMsT0FBVixDQUFrQnZDLEdBQWxCO0FBQ0g7QUFDSjtBQUNKLEtBeEJ1RSxDQTBCeEU7QUFDQTs7O0FBQ0EsUUFBSTRCLElBQUksR0FBR1QsTUFBTSxDQUFDUyxJQUFQLENBQVlTLGVBQVosQ0FBWDs7QUFDQSxTQUFLLElBQUk3QixHQUFDLEdBQUcsQ0FBYixFQUFnQkEsR0FBQyxHQUFHb0IsSUFBSSxDQUFDbkIsTUFBekIsRUFBaUNELEdBQUMsRUFBbEMsRUFBc0M7QUFDbEMsVUFBSVIsSUFBRyxHQUFHNEIsSUFBSSxDQUFDcEIsR0FBRCxDQUFkOztBQUNBLFVBQUk2QixlQUFlLENBQUNyQyxJQUFELENBQWYsS0FBeUIsSUFBekIsSUFBaUMsQ0FBQ2EsVUFBVSxDQUFDYixJQUFELENBQWhELEVBQXVEO0FBQ25ERyxRQUFBQSxFQUFFLENBQUNDLE1BQUgsQ0FBVW1DLE9BQVYsQ0FBa0J2QyxJQUFsQjtBQUNIO0FBQ0o7QUFDSixHLENBRUQ7OztBQUNPLFdBQVN3QyxxQkFBVCxDQUFnQ3hDLEdBQWhDLEVBQXFDO0FBQ3hDLFFBQUlNLE9BQU8sR0FBRyxFQUFkO0FBQ0FQLElBQUFBLFlBQVksQ0FBQ0MsR0FBRCxFQUFNTSxPQUFOLENBQVo7QUFDQSxXQUFPYSxNQUFNLENBQUNTLElBQVAsQ0FBWXRCLE9BQVosQ0FBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuIENvcHlyaWdodCAoYykgMjAxNiBDaHVrb25nIFRlY2hub2xvZ2llcyBJbmMuXHJcbiBDb3B5cmlnaHQgKGMpIDIwMTctMjAxOCBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC5cclxuXHJcbiBodHRwOi8vd3d3LmNvY29zLmNvbVxyXG5cclxuIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcclxuIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZW5naW5lIHNvdXJjZSBjb2RlICh0aGUgXCJTb2Z0d2FyZVwiKSwgYSBsaW1pdGVkLFxyXG4gIHdvcmxkd2lkZSwgcm95YWx0eS1mcmVlLCBub24tYXNzaWduYWJsZSwgcmV2b2NhYmxlIGFuZCBub24tZXhjbHVzaXZlIGxpY2Vuc2VcclxuIHRvIHVzZSBDb2NvcyBDcmVhdG9yIHNvbGVseSB0byBkZXZlbG9wIGdhbWVzIG9uIHlvdXIgdGFyZ2V0IHBsYXRmb3Jtcy4gWW91IHNoYWxsXHJcbiAgbm90IHVzZSBDb2NvcyBDcmVhdG9yIHNvZnR3YXJlIGZvciBkZXZlbG9waW5nIG90aGVyIHNvZnR3YXJlIG9yIHRvb2xzIHRoYXQnc1xyXG4gIHVzZWQgZm9yIGRldmVsb3BpbmcgZ2FtZXMuIFlvdSBhcmUgbm90IGdyYW50ZWQgdG8gcHVibGlzaCwgZGlzdHJpYnV0ZSxcclxuICBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgQ29jb3MgQ3JlYXRvci5cclxuXHJcbiBUaGUgc29mdHdhcmUgb3IgdG9vbHMgaW4gdGhpcyBMaWNlbnNlIEFncmVlbWVudCBhcmUgbGljZW5zZWQsIG5vdCBzb2xkLlxyXG4gWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuIHJlc2VydmVzIGFsbCByaWdodHMgbm90IGV4cHJlc3NseSBncmFudGVkIHRvIHlvdS5cclxuXHJcbiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXHJcbiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcclxuIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxyXG4gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxyXG4gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcclxuIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cclxuIFRIRSBTT0ZUV0FSRS5cclxuICovXHJcbi8qKlxyXG4gKiBAaGlkZGVuXHJcbiAqL1xyXG5cclxuaW1wb3J0IHtjcmVhdGVNYXB9IGZyb20gJy4uL3V0aWxzL2pzJztcclxuaW1wb3J0IHsgUmF3QXNzZXQgfSBmcm9tICcuLi9hc3NldHMvcmF3LWFzc2V0JztcclxuXHJcbmZ1bmN0aW9uIHBhcnNlRGVwZW5kcyAoa2V5LCBwYXJzZWQpIHtcclxuICAgIGxldCBpdGVtID0gY2MubG9hZGVyLmdldEl0ZW0oa2V5KTtcclxuICAgIGlmIChpdGVtKSB7XHJcbiAgICAgICAgbGV0IGRlcGVuZHMgPSBpdGVtLmRlcGVuZEtleXM7XHJcbiAgICAgICAgaWYgKGRlcGVuZHMpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXBlbmRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZGVwZW5kID0gZGVwZW5kc1tpXTtcclxuICAgICAgICAgICAgICAgIGlmICggIXBhcnNlZFtkZXBlbmRdICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcnNlZFtkZXBlbmRdID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJzZURlcGVuZHMoZGVwZW5kLCBwYXJzZWQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiB2aXNpdEFzc2V0IChhc3NldCwgZXhjbHVkZU1hcCkge1xyXG4gICAgLy8gU2tpcCBhc3NldHMgZ2VuZXJhdGVkIHByb2dyYW1tYXRpY2FsbHkgb3IgYnkgdXNlciAoZS5nLiBsYWJlbCB0ZXh0dXJlKVxyXG4gICAgaWYgKCFhc3NldC5fdXVpZCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGxldCBrZXkgPSBjYy5sb2FkZXIuX2dldFJlZmVyZW5jZUtleShhc3NldCk7XHJcbiAgICBpZiAoICFleGNsdWRlTWFwW2tleV0gKSB7XHJcbiAgICAgICAgZXhjbHVkZU1hcFtrZXldID0gdHJ1ZTtcclxuICAgICAgICBwYXJzZURlcGVuZHMoa2V5LCBleGNsdWRlTWFwKTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gdmlzaXRDb21wb25lbnQgKGNvbXAsIGV4Y2x1ZGVNYXApIHtcclxuICAgIGxldCBwcm9wcyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGNvbXApO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGxldCB2YWx1ZSA9IGNvbXBbcHJvcHNbaV1dO1xyXG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIHZhbHVlKSB7XHJcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB2YWx1ZS5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCB2YWwgPSB2YWx1ZVtqXTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodmFsIGluc3RhbmNlb2YgUmF3QXNzZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmlzaXRBc3NldCh2YWwsIGV4Y2x1ZGVNYXApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICghdmFsdWUuY29uc3RydWN0b3IgfHwgdmFsdWUuY29uc3RydWN0b3IgPT09IE9iamVjdCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGtleXMubGVuZ3RoOyBqKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgdmFsID0gdmFsdWVba2V5c1tqXV07XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCBpbnN0YW5jZW9mIFJhd0Fzc2V0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZpc2l0QXNzZXQodmFsLCBleGNsdWRlTWFwKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBSYXdBc3NldCkge1xyXG4gICAgICAgICAgICAgICAgdmlzaXRBc3NldCh2YWx1ZSwgZXhjbHVkZU1hcCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHZpc2l0Tm9kZSAobm9kZSwgZXhjbHVkZU1hcCkge1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLl9jb21wb25lbnRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgdmlzaXRDb21wb25lbnQobm9kZS5fY29tcG9uZW50c1tpXSwgZXhjbHVkZU1hcCk7XHJcbiAgICB9XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuX2NoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgdmlzaXROb2RlKG5vZGUuX2NoaWxkcmVuW2ldLCBleGNsdWRlTWFwKTtcclxuICAgIH1cclxufVxyXG5cclxuLy8gZG8gYXV0byByZWxlYXNlXHJcbmV4cG9ydCBmdW5jdGlvbiBhdXRvUmVsZWFzZSAob2xkU2NlbmVBc3NldHMsIG5leHRTY2VuZUFzc2V0cywgcGVyc2lzdE5vZGVzKSB7XHJcbiAgICBsZXQgcmVsZWFzZVNldHRpbmdzID0gY2MubG9hZGVyLl9hdXRvUmVsZWFzZVNldHRpbmc7XHJcbiAgICBsZXQgZXhjbHVkZU1hcCA9IGNyZWF0ZU1hcCgpO1xyXG5cclxuICAgIC8vIGNvbGxlY3QgbmV4dCBzY2VuZSBhc3NldHNcclxuICAgIGlmIChuZXh0U2NlbmVBc3NldHMpIHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5leHRTY2VuZUFzc2V0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBleGNsdWRlTWFwW25leHRTY2VuZUFzc2V0c1tpXV0gPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBjb2xsZWN0IGFzc2V0cyB1c2VkIGJ5IHBlcnNpc3Qgbm9kZXNcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGVyc2lzdE5vZGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgdmlzaXROb2RlKHBlcnNpc3ROb2Rlc1tpXSwgZXhjbHVkZU1hcClcclxuICAgIH1cclxuXHJcbiAgICAvLyByZW1vdmUgdW51bnNlZCBzY2VuZSBhc3NldHNcclxuICAgIGlmIChvbGRTY2VuZUFzc2V0cykge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb2xkU2NlbmVBc3NldHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgbGV0IGtleSA9IG9sZFNjZW5lQXNzZXRzW2ldO1xyXG4gICAgICAgICAgICBpZiAocmVsZWFzZVNldHRpbmdzW2tleV0gIT09IGZhbHNlICYmICFleGNsdWRlTWFwW2tleV0pIHtcclxuICAgICAgICAgICAgICAgIGNjLmxvYWRlci5yZWxlYXNlKGtleSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gcmVtb3ZlIGF1dG8gcmVsZWFzZSBhc3NldHNcclxuICAgIC8vIChyZWxlYXNpbmcgYXNzZXQgd2lsbCBjaGFuZ2UgX2F1dG9SZWxlYXNlU2V0dGluZywgc28gZG9uJ3QgdXNlIGZvci1pbilcclxuICAgIGxldCBrZXlzID0gT2JqZWN0LmtleXMocmVsZWFzZVNldHRpbmdzKTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGxldCBrZXkgPSBrZXlzW2ldO1xyXG4gICAgICAgIGlmIChyZWxlYXNlU2V0dGluZ3Nba2V5XSA9PT0gdHJ1ZSAmJiAhZXhjbHVkZU1hcFtrZXldKSB7XHJcbiAgICAgICAgICAgIGNjLmxvYWRlci5yZWxlYXNlKGtleSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG4vLyBnZXQgZGVwZW5kZW5jaWVzIG5vdCBpbmNsdWRpbmcgc2VsZlxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGVwZW5kc1JlY3Vyc2l2ZWx5IChrZXkpIHtcclxuICAgIGxldCBkZXBlbmRzID0ge307XHJcbiAgICBwYXJzZURlcGVuZHMoa2V5LCBkZXBlbmRzKTtcclxuICAgIHJldHVybiBPYmplY3Qua2V5cyhkZXBlbmRzKTtcclxufSJdfQ==