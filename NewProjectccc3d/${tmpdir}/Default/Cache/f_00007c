(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../platform/debug.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../platform/debug.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.debug);
    global.deprecated = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _debug) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.setDefaultLogTimes = setDefaultLogTimes;
  _exports.markAsWarning = _exports.removeProperty = _exports.replaceProperty = void 0;

  /**
   * @hidden
   */
  var defaultLogTimes = 10;

  function setDefaultLogTimes(times) {
    if (times > 0) {
      defaultLogTimes = times;
    }
  }

  ;
  var replaceProperty;
  _exports.replaceProperty = replaceProperty;
  var removeProperty;
  _exports.removeProperty = removeProperty;
  var markAsWarning;
  _exports.markAsWarning = markAsWarning;
  var replacePropertyLog;
  var markAsWarningLog;
  var removePropertyLog; // if (DEBUG) {

  var messageID = 0;
  var messageMap = new Map();

  replacePropertyLog = function replacePropertyLog(n, dp, n2, newp, f, id) {
    var item = messageMap.get(id);

    if (item && item.logTimes > item.count) {
      f('\'%s\' is deprecated, please use \'%s\' instead.', "".concat(n, ".").concat(dp), "".concat(n2, ".").concat(newp));
      item.count++;
    }
  };

  _exports.replaceProperty = replaceProperty = function replaceProperty(owner, ownerName, properties) {
    if (owner == null) return;
    properties.forEach(function (item) {
      var id = messageID++;
      messageMap.set(id, {
        id: id,
        count: 0,
        logTimes: item.logTimes !== undefined ? item.logTimes : defaultLogTimes
      });
      var target = item.target != null ? item.target : owner;
      var newName = item.newName != null ? item.newName : item.name;
      var targetName = item.targetName != null ? item.targetName : ownerName;
      var sameTarget = target == owner;

      if (item.customFunction != null) {
        owner[item.name] = function () {
          var _ref;

          replacePropertyLog(ownerName, item.name, targetName, newName, _debug.warn, id);
          return (_ref = item.customFunction).call.apply(_ref, [this].concat(Array.prototype.slice.call(arguments)));
        };
      } else if (item.customSetter != null || item.customGetter != null) {
        var hasSetter = item.customSetter != null;
        var hasGetter = item.customGetter != null;

        if (hasSetter && hasGetter) {
          Object.defineProperty(owner, item.name, {
            get: function get() {
              replacePropertyLog(ownerName, item.name, targetName, newName, _debug.warn, id);
              return item.customGetter.call(this);
            },
            set: function set(v) {
              replacePropertyLog(ownerName, item.name, targetName, newName, _debug.warn, id);
              item.customSetter.call(this, v);
            }
          });
        } else if (hasSetter) {
          Object.defineProperty(owner, item.name, {
            set: function set(v) {
              replacePropertyLog(ownerName, item.name, targetName, newName, _debug.warn, id);
              item.customSetter.call(this, v);
            }
          });
        } else if (hasGetter) {
          Object.defineProperty(owner, item.name, {
            get: function get() {
              replacePropertyLog(ownerName, item.name, targetName, newName, _debug.warn, id);
              return item.customGetter.call(this);
            }
          });
        }
      } else {
        Object.defineProperty(owner, item.name, {
          get: function get() {
            replacePropertyLog(ownerName, item.name, targetName, newName, _debug.warn, id);
            return sameTarget ? this[newName] : target[newName];
          },
          set: function set(v) {
            replacePropertyLog(ownerName, item.name, targetName, newName, _debug.warn, id);

            if (sameTarget) {
              this[newName] = v;
            } else {
              target[newName] = v;
            }
          }
        });
      }
    });
  };

  removePropertyLog = function removePropertyLog(n, dp, f, id, s) {
    var item = messageMap.get(id);
    var ss = s === undefined ? '' : '(' + s + ')';

    if (item && item.logTimes > item.count) {
      f('\'%s\' has been removed. ' + ss, "".concat(n, ".").concat(dp));
      item.count++;
    }
  };

  _exports.removeProperty = removeProperty = function removeProperty(owner, ownerName, properties) {
    if (owner == null) return;
    properties.forEach(function (item) {
      var id = messageID++;
      messageMap.set(id, {
        id: id,
        count: 0,
        logTimes: item.logTimes !== undefined ? item.logTimes : defaultLogTimes
      });
      Object.defineProperty(owner, item.name, {
        get: function get() {
          return removePropertyLog(ownerName, item.name, _debug.error, id, item.suggest);
        },
        set: function set() {
          removePropertyLog(ownerName, item.name, _debug.error, id, item.suggest);
        }
      });
    });
  };

  markAsWarningLog = function markAsWarningLog(n, dp, f, id, s) {
    var item = messageMap.get(id);
    var ss = s === undefined ? '' : '(' + s + ')';

    if (item && item.logTimes > item.count) {
      f('\'%s\' is deprecated. ' + ss, "".concat(n, ".").concat(dp));
      item.count++;
    }
  };

  _exports.markAsWarning = markAsWarning = function markAsWarning(owner, ownerName, properties) {
    if (owner == null) return;

    var _defaultGetSet = function _defaultGetSet(d, n, dp, f, id, s) {
      if (d.get) {
        var oldGet = d.get();

        d.get = function () {
          markAsWarningLog(n, dp, f, id, s);
          return oldGet.call(this);
        };
      }

      if (d.set) {
        var oldSet = Object.create(d.set);

        d.set = function (v) {
          markAsWarningLog(n, dp, f, id, s);
          oldSet.call(this, v);
        };
      }
    };

    properties.forEach(function (item) {
      var deprecatedProp = item.name;
      var descriptor = Object.getOwnPropertyDescriptor(owner, deprecatedProp);

      if (!descriptor) {
        return;
      }

      var id = messageID++;
      messageMap.set(id, {
        id: id,
        count: 0,
        logTimes: item.logTimes !== undefined ? item.logTimes : defaultLogTimes
      });

      if (descriptor.value != null) {
        if (typeof descriptor.value === 'function') {
          var oldValue = descriptor.value;

          owner[deprecatedProp] = function () {
            markAsWarningLog(ownerName, deprecatedProp, _debug.warn, id, item.suggest);
            return oldValue.call.apply(oldValue, [this].concat(Array.prototype.slice.call(arguments)));
          };
        } else {
          _defaultGetSet(descriptor, ownerName, deprecatedProp, _debug.warn, id, item.suggest);
        }
      } else {
        _defaultGetSet(descriptor, ownerName, deprecatedProp, _debug.warn, id, item.suggest);
      }
    });
  }; // } else {
  //     // for compatible
  //     replaceProperty = () => { };
  //     removeProperty = () => { };
  //     markAsWarning = () => { };
  //     replacePropertyLog = () => { };
  //     removePropertyLog = () => { };
  //     markAsWarningLog = () => { };
  // }

});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkY6L2plbmtpbnMvd29ya3NwYWNlL0NyZWF0b3JfM0QvZWRpdG9yLTNkL3Jlc291cmNlcy8zZC9lbmdpbmUvY29jb3MvY29yZS91dGlscy9kZXByZWNhdGVkLnRzIl0sIm5hbWVzIjpbImRlZmF1bHRMb2dUaW1lcyIsInNldERlZmF1bHRMb2dUaW1lcyIsInRpbWVzIiwicmVwbGFjZVByb3BlcnR5IiwicmVtb3ZlUHJvcGVydHkiLCJtYXJrQXNXYXJuaW5nIiwicmVwbGFjZVByb3BlcnR5TG9nIiwibWFya0FzV2FybmluZ0xvZyIsInJlbW92ZVByb3BlcnR5TG9nIiwibWVzc2FnZUlEIiwibWVzc2FnZU1hcCIsIk1hcCIsIm4iLCJkcCIsIm4yIiwibmV3cCIsImYiLCJpZCIsIml0ZW0iLCJnZXQiLCJsb2dUaW1lcyIsImNvdW50Iiwib3duZXIiLCJvd25lck5hbWUiLCJwcm9wZXJ0aWVzIiwiZm9yRWFjaCIsInNldCIsInVuZGVmaW5lZCIsInRhcmdldCIsIm5ld05hbWUiLCJuYW1lIiwidGFyZ2V0TmFtZSIsInNhbWVUYXJnZXQiLCJjdXN0b21GdW5jdGlvbiIsIndhcm4iLCJjYWxsIiwiYXJndW1lbnRzIiwiY3VzdG9tU2V0dGVyIiwiY3VzdG9tR2V0dGVyIiwiaGFzU2V0dGVyIiwiaGFzR2V0dGVyIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJ2IiwicyIsInNzIiwiZXJyb3IiLCJzdWdnZXN0IiwiX2RlZmF1bHRHZXRTZXQiLCJkIiwib2xkR2V0Iiwib2xkU2V0IiwiY3JlYXRlIiwiZGVwcmVjYXRlZFByb3AiLCJkZXNjcmlwdG9yIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwidmFsdWUiLCJvbGRWYWx1ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7OztBQU1BLE1BQUlBLGVBQWUsR0FBRyxFQUF0Qjs7QUFFTyxXQUFTQyxrQkFBVCxDQUE2QkMsS0FBN0IsRUFBa0Q7QUFDckQsUUFBSUEsS0FBSyxHQUFHLENB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QUFDQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBAaGlkZGVuXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgZXJyb3IsIHdhcm4gfSBmcm9tICcuLi9wbGF0Zm9ybS9kZWJ1Zyc7XHJcblxyXG5sZXQgZGVmYXVsdExvZ1RpbWVzID0gMTA7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gc2V0RGVmYXVsdExvZ1RpbWVzICh0aW1lczogbnVtYmVyKTogdm9pZCB7XHJcbiAgICBpZiAodGltZXMgPiAwKSB7XHJcbiAgICAgICAgZGVmYXVsdExvZ1RpbWVzID0gdGltZXM7XHJcbiAgICB9XHJcbn07XHJcblxyXG5pbnRlcmZhY2UgSVJlcGxhY2VtZW50IHtcclxuICAgIC8qKiDlup/lvIPlsZ7mgKfnmoTlkI3np7AgKi9cclxuICAgIG5hbWU6IHN0cmluZztcclxuICAgIC8qKiDorablkYrnmoTmrKHmlbAgKi9cclxuICAgIGxvZ1RpbWVzPzogbnVtYmVyO1xyXG4gICAgLyoqIOabv+aNouWxnuaAp+eahOWQjeensCAqL1xyXG4gICAgbmV3TmFtZT86IHN0cmluZztcclxuICAgIC8qKiDlup/lvIPlsZ7mgKfnmoTmiYDlsZ7lr7nosaEgKi9cclxuICAgIHRhcmdldD86IG9iamVjdDtcclxuICAgIC8qKiDlup/lvIPlsZ7mgKfnmoTmiYDlsZ7lr7nosaHnmoTlkI3np7AgKi9cclxuICAgIHRhcmdldE5hbWU/OiBzdHJpbmc7XHJcbiAgICAvKiog6Ieq5a6a5LmJ5pu/5o2i5bGe5oCn77yI5Ye95pWw77yJICovXHJcbiAgICBjdXN0b21GdW5jdGlvbj86IEZ1bmN0aW9uO1xyXG4gICAgLyoqIOiHquWumuS5ieabv+aNouWxnuaAp+eahCBzZXR0ZXIgKi9cclxuICAgIGN1c3RvbVNldHRlcj86ICh2OiBhbnkpID0+IHZvaWQ7XHJcbiAgICAvKiog6Ieq5a6a5LmJ5pu/5o2i5bGe5oCn55qEIGdldHRlciAqL1xyXG4gICAgY3VzdG9tR2V0dGVyPzogKCkgPT4gYW55O1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSVJlbW92ZUl0ZW0ge1xyXG4gICAgLyoqIOW6n+W8g+WxnuaAp+eahOWQjeensCAqL1xyXG4gICAgbmFtZTogc3RyaW5nO1xyXG4gICAgLyoqIOitpuWRiueahOasoeaVsCAqL1xyXG4gICAgbG9nVGltZXM/OiBudW1iZXI7XHJcbiAgICAvKiog6aKd5aSW5bu66K6uICovXHJcbiAgICBzdWdnZXN0Pzogc3RyaW5nO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSU1hcmtJdGVtIHtcclxuICAgIC8qKiDlup/lvIPlsZ7mgKfnmoTlkI3np7AgKi9cclxuICAgIG5hbWU6IHN0cmluZztcclxuICAgIC8qKiDorablkYrnmoTmrKHmlbAgKi9cclxuICAgIGxvZ1RpbWVzPzogbnVtYmVyO1xyXG4gICAgLyoqIOmineWkluW7uuiuriAqL1xyXG4gICAgc3VnZ2VzdD86IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGxldCByZXBsYWNlUHJvcGVydHk6IChvd25lcjogb2JqZWN0LCBvd25lck5hbWU6IHN0cmluZywgcHJvcGVydGllczogSVJlcGxhY2VtZW50W10pID0+IHZvaWQ7XHJcblxyXG5leHBvcnQgbGV0IHJlbW92ZVByb3BlcnR5OiAob3duZXI6IG9iamVjdCwgb3duZXJOYW1lOiBzdHJpbmcsIHByb3BlcnRpZXM6IElSZW1vdmVJdGVtW10pID0+IHZvaWQ7XHJcblxyXG5leHBvcnQgbGV0IG1hcmtBc1dhcm5pbmc6IChvd25lcjogb2JqZWN0LCBvd25lck5hbWU6IHN0cmluZywgcHJvcGVydGllczogSU1hcmtJdGVtW10pID0+IHZvaWQ7XHJcblxyXG5sZXQgcmVwbGFjZVByb3BlcnR5TG9nOiAobjogc3RyaW5nLCBkcDogc3RyaW5nLCBuMjogc3RyaW5nLCBuZXdwOiBzdHJpbmcsIGY6IEZ1bmN0aW9uLCBpZDogbnVtYmVyKSA9PiB2b2lkO1xyXG5cclxubGV0IG1hcmtBc1dhcm5pbmdMb2c6IChuOiBzdHJpbmcsIGRwOiBzdHJpbmcsIGY6IEZ1bmN0aW9uLCBpZDogbnVtYmVyLCBzPzogc3RyaW5nKSA9PiB2b2lkO1xyXG5cclxubGV0IHJlbW92ZVByb3BlcnR5TG9nOiAobjogc3RyaW5nLCBkcDogc3RyaW5nLCBmOiBGdW5jdGlvbiwgaWQ6IG51bWJlciwgcz86IHN0cmluZykgPT4gdm9pZDtcclxuXHJcbi8vIGlmIChERUJVRykge1xyXG5cclxuaW50ZXJmYWNlIElNZWVzc2FnZUl0ZW0ge1xyXG4gICAgaWQ6IFJlYWRvbmx5PG51bWJlcj47XHJcbiAgICBsb2dUaW1lczogUmVhZG9ubHk8bnVtYmVyPjtcclxuICAgIGNvdW50OiBudW1iZXI7XHJcbn1cclxuXHJcbmxldCBtZXNzYWdlSUQgPSAwO1xyXG5jb25zdCBtZXNzYWdlTWFwOiBNYXA8bnVtYmVyLCBJTWVlc3NhZ2VJdGVtPiA9IG5ldyBNYXA8bnVtYmVyLCBJTWVlc3NhZ2VJdGVtPigpO1xyXG5cclxucmVwbGFjZVByb3BlcnR5TG9nID0gKG46IHN0cmluZywgZHA6IHN0cmluZywgbjI6IHN0cmluZywgbmV3cDogc3RyaW5nLCBmOiBGdW5jdGlvbiwgaWQ6IG51bWJlcikgPT4ge1xyXG4gICAgY29uc3QgaXRlbSA9IG1lc3NhZ2VNYXAuZ2V0KGlkKTtcclxuICAgIGlmIChpdGVtICYmIGl0ZW0ubG9nVGltZXMgPiBpdGVtLmNvdW50KSB7XHJcbiAgICAgICAgZignXFwnJXNcXCcgaXMgZGVwcmVjYXRlZCwgcGxlYXNlIHVzZSBcXCclc1xcJyBpbnN0ZWFkLicsIGAke259LiR7ZHB9YCwgYCR7bjJ9LiR7bmV3cH1gKTtcclxuICAgICAgICBpdGVtLmNvdW50Kys7XHJcbiAgICB9XHJcbn07XHJcblxyXG5yZXBsYWNlUHJvcGVydHkgPSAob3duZXI6IG9iamVjdCwgb3duZXJOYW1lOiBzdHJpbmcsIHByb3BlcnRpZXM6IElSZXBsYWNlbWVudFtdKSA9PiB7XHJcbiAgICBpZiAob3duZXIgPT0gbnVsbCkgcmV0dXJuO1xyXG5cclxuICAgIHByb3BlcnRpZXMuZm9yRWFjaCgoaXRlbTogSVJlcGxhY2VtZW50KSA9PiB7XHJcblxyXG4gICAgICAgIGNvbnN0IGlkID0gbWVzc2FnZUlEKys7XHJcbiAgICAgICAgbWVzc2FnZU1hcC5zZXQoaWQsIHsgaWQsIGNvdW50OiAwLCBsb2dUaW1lczogaXRlbS5sb2dUaW1lcyAhPT0gdW5kZWZpbmVkID8gaXRlbS5sb2dUaW1lcyA6IGRlZmF1bHRMb2dUaW1lcywgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHRhcmdldCA9IGl0ZW0udGFyZ2V0ICE9IG51bGwgPyBpdGVtLnRhcmdldCA6IG93bmVyO1xyXG4gICAgICAgIGNvbnN0IG5ld05hbWUgPSBpdGVtLm5ld05hbWUgIT0gbnVsbCA/IGl0ZW0ubmV3TmFtZSA6IGl0ZW0ubmFtZTtcclxuICAgICAgICBjb25zdCB0YXJnZXROYW1lID0gaXRlbS50YXJnZXROYW1lICE9IG51bGwgPyBpdGVtLnRhcmdldE5hbWUgOiBvd25lck5hbWU7XHJcbiAgICAgICAgY29uc3Qgc2FtZVRhcmdldCA9IHRhcmdldCA9PSBvd25lcjtcclxuXHJcbiAgICAgICAgaWYgKGl0ZW0uY3VzdG9tRnVuY3Rpb24gIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBvd25lcltpdGVtLm5hbWVdID0gZnVuY3Rpb24gKHRoaXM6IGFueSkge1xyXG4gICAgICAgICAgICAgICAgcmVwbGFjZVByb3BlcnR5TG9nKG93bmVyTmFtZSwgaXRlbS5uYW1lLCB0YXJnZXROYW1lLCBuZXdOYW1lLCB3YXJuLCBpZCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaXRlbS5jdXN0b21GdW5jdGlvbiEuY2FsbCh0aGlzLCAuLi5hcmd1bWVudHMpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0gZWxzZSBpZiAoaXRlbS5jdXN0b21TZXR0ZXIgIT0gbnVsbCB8fCBpdGVtLmN1c3RvbUdldHRlciAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGhhc1NldHRlciA9IGl0ZW0uY3VzdG9tU2V0dGVyICE9IG51bGw7XHJcbiAgICAgICAgICAgIGNvbnN0IGhhc0dldHRlciA9IGl0ZW0uY3VzdG9tR2V0dGVyICE9IG51bGw7XHJcbiAgICAgICAgICAgIGlmIChoYXNTZXR0ZXIgJiYgaGFzR2V0dGVyKSB7XHJcbiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob3duZXIsIGl0ZW0ubmFtZSwge1xyXG4gICAgICAgICAgICAgICAgICAgIGdldCAodGhpcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlUHJvcGVydHlMb2cob3duZXJOYW1lLCBpdGVtLm5hbWUsIHRhcmdldE5hbWUsIG5ld05hbWUsIHdhcm4sIGlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGl0ZW0uY3VzdG9tR2V0dGVyIS5jYWxsKHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgc2V0ICh0aGlzLCB2OiBhbnkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVByb3BlcnR5TG9nKG93bmVyTmFtZSwgaXRlbS5uYW1lLCB0YXJnZXROYW1lLCBuZXdOYW1lLCB3YXJuLCBpZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uY3VzdG9tU2V0dGVyIS5jYWxsKHRoaXMsIHYpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGhhc1NldHRlcikge1xyXG4gICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG93bmVyLCBpdGVtLm5hbWUsIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXQgKHRoaXMsIHY6IGFueSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlUHJvcGVydHlMb2cob3duZXJOYW1lLCBpdGVtLm5hbWUsIHRhcmdldE5hbWUsIG5ld05hbWUsIHdhcm4sIGlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5jdXN0b21TZXR0ZXIhLmNhbGwodGhpcywgdik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzR2V0dGVyKSB7XHJcbiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob3duZXIsIGl0ZW0ubmFtZSwge1xyXG4gICAgICAgICAgICAgICAgICAgIGdldCAodGhpcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlUHJvcGVydHlMb2cob3duZXJOYW1lLCBpdGVtLm5hbWUsIHRhcmdldE5hbWUsIG5ld05hbWUsIHdhcm4sIGlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGl0ZW0uY3VzdG9tR2V0dGVyIS5jYWxsKHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG93bmVyLCBpdGVtLm5hbWUsIHtcclxuICAgICAgICAgICAgICAgIGdldCAodGhpcykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlcGxhY2VQcm9wZXJ0eUxvZyhvd25lck5hbWUsIGl0ZW0ubmFtZSwgdGFyZ2V0TmFtZSwgbmV3TmFtZSwgd2FybiwgaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzYW1lVGFyZ2V0ID8gdGhpc1tuZXdOYW1lXSA6IHRhcmdldFtuZXdOYW1lXTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBzZXQgKHRoaXMsIHY6IGFueSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlcGxhY2VQcm9wZXJ0eUxvZyhvd25lck5hbWUsIGl0ZW0ubmFtZSwgdGFyZ2V0TmFtZSwgbmV3TmFtZSwgd2FybiwgaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzYW1lVGFyZ2V0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbbmV3TmFtZV0gPSB2O1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtuZXdOYW1lXSA9IHY7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbn07XHJcblxyXG5yZW1vdmVQcm9wZXJ0eUxvZyA9IChuOiBzdHJpbmcsIGRwOiBzdHJpbmcsIGY6IEZ1bmN0aW9uLCBpZDogbnVtYmVyLCBzPzogc3RyaW5nKSA9PiB7XHJcbiAgICBjb25zdCBpdGVtID0gbWVzc2FnZU1hcC5nZXQoaWQpO1xyXG4gICAgY29uc3Qgc3MgPSBzID09PSB1bmRlZmluZWQgPyAnJyA6ICcoJyArIHMgKyAnKSc7XHJcbiAgICBpZiAoaXRlbSAmJiBpdGVtLmxvZ1RpbWVzID4gaXRlbS5jb3VudCkge1xyXG4gICAgICAgIGYoJ1xcJyVzXFwnIGhhcyBiZWVuIHJlbW92ZWQuICcgKyBzcywgYCR7bn0uJHtkcH1gKTtcclxuICAgICAgICBpdGVtLmNvdW50Kys7XHJcbiAgICB9XHJcbn07XHJcblxyXG5yZW1vdmVQcm9wZXJ0eSA9IChvd25lcjogb2JqZWN0LCBvd25lck5hbWU6IHN0cmluZywgcHJvcGVydGllczogSVJlbW92ZUl0ZW1bXSkgPT4ge1xyXG4gICAgaWYgKG93bmVyID09IG51bGwpIHJldHVybjtcclxuXHJcbiAgICBwcm9wZXJ0aWVzLmZvckVhY2goKGl0ZW06IElSZW1vdmVJdGVtKSA9PiB7XHJcbiAgICAgICAgY29uc3QgaWQgPSBtZXNzYWdlSUQrKztcclxuICAgICAgICBtZXNzYWdlTWFwLnNldChpZCwgeyBpZCwgY291bnQ6IDAsIGxvZ1RpbWVzOiBpdGVtLmxvZ1RpbWVzICE9PSB1bmRlZmluZWQgPyBpdGVtLmxvZ1RpbWVzIDogZGVmYXVsdExvZ1RpbWVzLCB9KTtcclxuXHJcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG93bmVyLCBpdGVtLm5hbWUsIHtcclxuICAgICAgICAgICAgZ2V0ICh0aGlzKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVtb3ZlUHJvcGVydHlMb2cob3duZXJOYW1lLCBpdGVtLm5hbWUsIGVycm9yLCBpZCwgaXRlbS5zdWdnZXN0KTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc2V0ICh0aGlzKSB7XHJcbiAgICAgICAgICAgICAgICByZW1vdmVQcm9wZXJ0eUxvZyhvd25lck5hbWUsIGl0ZW0ubmFtZSwgZXJyb3IsIGlkLCBpdGVtLnN1Z2dlc3QpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufTtcclxuXHJcbm1hcmtBc1dhcm5pbmdMb2cgPSAobjogc3RyaW5nLCBkcDogc3RyaW5nLCBmOiBGdW5jdGlvbiwgaWQ6IG51bWJlciwgcz86IHN0cmluZykgPT4ge1xyXG4gICAgY29uc3QgaXRlbSA9IG1lc3NhZ2VNYXAuZ2V0KGlkKTtcclxuICAgIGNvbnN0IHNzID0gcyA9PT0gdW5kZWZpbmVkID8gJycgOiAnKCcgKyBzICsgJyknO1xyXG4gICAgaWYgKGl0ZW0gJiYgaXRlbS5sb2dUaW1lcyA+IGl0ZW0uY291bnQpIHtcclxuICAgICAgICBmKCdcXCclc1xcJyBpcyBkZXByZWNhdGVkLiAnICsgc3MsIGAke259LiR7ZHB9YCk7XHJcbiAgICAgICAgaXRlbS5jb3VudCsrO1xyXG4gICAgfVxyXG59O1xyXG5cclxubWFya0FzV2FybmluZyA9IChvd25lcjogb2JqZWN0LCBvd25lck5hbWU6IHN0cmluZywgcHJvcGVydGllczogSU1hcmtJdGVtW10pID0+IHtcclxuICAgIGlmIChvd25lciA9PSBudWxsKSByZXR1cm47XHJcblxyXG4gICAgY29uc3QgX2RlZmF1bHRHZXRTZXQgPSAoZDogUHJvcGVydHlEZXNjcmlwdG9yLCBuOiBzdHJpbmcsIGRwOiBzdHJpbmcsIGY6IEZ1bmN0aW9uLCBpZDogbnVtYmVyLCBzPzogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgaWYgKGQuZ2V0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9sZEdldCA9IGQuZ2V0KCk7XHJcbiAgICAgICAgICAgIGQuZ2V0ID0gZnVuY3Rpb24gKHRoaXMpIHtcclxuICAgICAgICAgICAgICAgIG1hcmtBc1dhcm5pbmdMb2cobiwgZHAsIGYsIGlkLCBzKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBvbGRHZXQuY2FsbCh0aGlzKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGQuc2V0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9sZFNldCA9IE9iamVjdC5jcmVhdGUoZC5zZXQpO1xyXG4gICAgICAgICAgICBkLnNldCA9IGZ1bmN0aW9uICh0aGlzLCB2OiBhbnkpIHtcclxuICAgICAgICAgICAgICAgIG1hcmtBc1dhcm5pbmdMb2cobiwgZHAsIGYsIGlkLCBzKTtcclxuICAgICAgICAgICAgICAgIG9sZFNldC5jYWxsKHRoaXMsIHYpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgcHJvcGVydGllcy5mb3JFYWNoKChpdGVtOiBJTWFya0l0ZW0pID0+IHtcclxuICAgICAgICBjb25zdCBkZXByZWNhdGVkUHJvcCA9IGl0ZW0ubmFtZTtcclxuICAgICAgICBjb25zdCBkZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvd25lciwgZGVwcmVjYXRlZFByb3ApO1xyXG4gICAgICAgIGlmICghZGVzY3JpcHRvcikgeyByZXR1cm47IH1cclxuXHJcbiAgICAgICAgY29uc3QgaWQgPSBtZXNzYWdlSUQrKztcclxuICAgICAgICBtZXNzYWdlTWFwLnNldChpZCwgeyBpZCwgY291bnQ6IDAsIGxvZ1RpbWVzOiBpdGVtLmxvZ1RpbWVzICE9PSB1bmRlZmluZWQgPyBpdGVtLmxvZ1RpbWVzIDogZGVmYXVsdExvZ1RpbWVzLCB9KTtcclxuXHJcbiAgICAgICAgaWYgKGRlc2NyaXB0b3IudmFsdWUgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIGRlc2NyaXB0b3IudmFsdWUgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG9sZFZhbHVlID0gZGVzY3JpcHRvci52YWx1ZSBhcyBGdW5jdGlvbjtcclxuICAgICAgICAgICAgICAgIG93bmVyW2RlcHJlY2F0ZWRQcm9wXSA9IGZ1bmN0aW9uICh0aGlzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWFya0FzV2FybmluZ0xvZyhvd25lck5hbWUsIGRlcHJlY2F0ZWRQcm9wLCB3YXJuLCBpZCwgaXRlbS5zdWdnZXN0KTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2xkVmFsdWUuY2FsbCh0aGlzLCAuLi5hcmd1bWVudHMpO1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIF9kZWZhdWx0R2V0U2V0KGRlc2NyaXB0b3IsIG93bmVyTmFtZSwgZGVwcmVjYXRlZFByb3AsIHdhcm4sIGlkLCBpdGVtLnN1Z2dlc3QpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgX2RlZmF1bHRHZXRTZXQoZGVzY3JpcHRvciwgb3duZXJOYW1lLCBkZXByZWNhdGVkUHJvcCwgd2FybiwgaWQsIGl0ZW0uc3VnZ2VzdCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn07XHJcblxyXG4vLyB9IGVsc2Uge1xyXG4vLyAgICAgLy8gZm9yIGNvbXBhdGlibGVcclxuXHJcbi8vICAgICByZXBsYWNlUHJvcGVydHkgPSAoKSA9PiB7IH07XHJcbi8vICAgICByZW1vdmVQcm9wZXJ0eSA9ICgpID0+IHsgfTtcclxuLy8gICAgIG1hcmtBc1dhcm5pbmcgPSAoKSA9PiB7IH07XHJcblxyXG4vLyAgICAgcmVwbGFjZVByb3BlcnR5TG9nID0gKCkgPT4geyB9O1xyXG4vLyAgICAgcmVtb3ZlUHJvcGVydHlMb2cgPSAoKSA9PiB7IH07XHJcbi8vICAgICBtYXJrQXNXYXJuaW5nTG9nID0gKCkgPT4geyB9O1xyXG4vLyB9XHJcbiJdfQ==