(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../utils/js.js", "../assets/image-asset.js", "./plist-parser.js", "./pipeline.js", "./uuid-loader.js", "./font-loader.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../utils/js.js"), require("../assets/image-asset.js"), require("./plist-parser.js"), require("./pipeline.js"), require("./uuid-loader.js"), require("./font-loader.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.js, global.imageAsset, global.plistParser, global.pipeline, global.uuidLoader, global.fontLoader);
    global.loader = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _js, _imageAsset, _plistParser, _pipeline, _uuidLoader, _fontLoader) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.default = void 0;
  _plistParser = _interopRequireDefault(_plistParser);

  function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

  function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

  function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

  function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

  function loadNothing() {
    return null;
  }

  function loadJSON(item) {
    if (typeof item.content !== 'string') {
      return new Error('JSON Loader: Input item doesn\'t contain string content');
    }

    try {
      var result = JSON.parse(item.content);
      return result;
    } catch (e) {
      return new Error('JSON Loader: Parse json [' + item.id + '] failed : ' + e);
    }
  }

  function loadImage(item) {
    var loadByDeserializedAsset = item._owner instanceof cc.Asset;

    if (loadByDeserializedAsset) {
      // already has cc.Asset
      return null;
    }

    var image = item.content;

    if (cc.sys.platform !== cc.sys.FB_PLAYABLE_ADS && !(image instanceof Image)) {
      return new Error('Image Loader: Input item doesn\'t contain Image content');
    } // load cc.ImageAsset


    var rawUrl = item.rawUrl;
    var imageAsset = item.imageAsset || new _imageAsset.ImageAsset();
    imageAsset._uuid = item.uuid;
    imageAsset._url = rawUrl;

    imageAsset._setRawAsset(rawUrl, false);

    imageAsset._nativeAsset = image;
    return imageAsset;
  } // If audio is loaded by url directly, than this loader will wrap it into a new cc.AudioClip object.
  // If audio is loaded by deserialized AudioClip, than this loader will be skipped.


  function loadAudioAsAsset(item, callback) {
    var loadByDeserializedAsset = item._owner instanceof cc.Asset;

    if (loadByDeserializedAsset) {
      // already has cc.Asset
      return null;
    }

    var audioClip = new cc.AudioClip();

    audioClip._setRawAsset(item.rawUrl, false);

    audioClip._nativeAsset = item.content;
    return audioClip;
  }

  function loadPlist(item) {
    if (typeof item.content !== 'string') {
      return new Error('Plist Loader: Input item doesn\'t contain string content');
    }

    var result = _plistParser.default.parse(item.content);

    if (result) {
      return result;
    } else {
      return new Error('Plist Loader: Parse [' + item.id + '] failed');
    }
  }

  function loadBinary(item) {
    // Invoke custom handle
    if (item.load) {
      return item.load(item.content);
    } else {
      return item.content;
    }
  } //===============//
  // PVR constants //
  //===============//
  // https://github.com/toji/texture-tester/blob/master/js/webgl-texture-util.js#L424


  var PVR_HEADER_LENGTH = 13; // The header length in 32 bit ints.

  var PVR_MAGIC = 0x03525650; //0x50565203;
  // Offsets into the header array.

  var PVR_HEADER_MAGIC = 0;
  var PVR_HEADER_FORMAT = 2;
  var PVR_HEADER_HEIGHT = 6;
  var PVR_HEADER_WIDTH = 7;
  var PVR_HEADER_MIPMAPCOUNT = 11;
  var PVR_HEADER_METADATA = 12;

  function loadPVRTex(item) {
    var buffer = item.content instanceof ArrayBuffer ? item.content : item.content.buffer; // Get a view of the arrayBuffer that represents the DDS header.

    var header = new Int32Array(buffer, 0, PVR_HEADER_LENGTH); // Do some sanity checks to make sure this is a valid DDS file.

    if (header[PVR_HEADER_MAGIC] === PVR_MAGIC) {
      // Gather other basic metrics and a view of the raw the DXT data.
      var width = header[PVR_HEADER_WIDTH];
      var height = header[PVR_HEADER_HEIGHT];
      var dataOffset = header[PVR_HEADER_METADATA] + 52; // todo: use new Uint8Array(buffer, dataOffset) instead

      buffer = buffer.slice(dataOffset, buffer.byteLength);
      var pvrtcData = new Uint8Array(buffer);
      var pvrAsset = {
        _data: pvrtcData,
        _compressed: true,
        width: width,
        height: height
      };
      return pvrAsset;
    } else if (header[11] === 0x21525650) {
      var headerLength = header[0],
          _height = header[1],
          _width = header[2]; // todo: use new Uint8Array(buffer, headerLength) instead

      buffer = buffer.slice(headerLength, buffer.byteLength);

      var _pvrtcData = new Uint8Array(buffer);

      var _pvrAsset = {
        _data: _pvrtcData,
        _compressed: true,
        width: _width,
        height: _height
      };
      return _pvrAsset;
    } else {
      return new Error("Invalid magic number in PVR header");
    }
  } //===============//
  // ETC constants //
  //===============//


  var ETC_PKM_HEADER_SIZE = 16;
  var ETC_PKM_FORMAT_OFFSET = 6;
  var ETC_PKM_ENCODED_WIDTH_OFFSET = 8;
  var ETC_PKM_ENCODED_HEIGHT_OFFSET = 10;
  var ETC_PKM_WIDTH_OFFSET = 12;
  var ETC_PKM_HEIGHT_OFFSET = 14;
  var ETC1_RGB_NO_MIPMAPS = 0;
  var ETC2_RGB_NO_MIPMAPS = 1;
  var ETC2_RGBA_NO_MIPMAPS = 3;

  function readBEUint16(header, offset) {
    return header[offset] << 8 | header[offset + 1];
  }

  function loadPKMTex(item) {
    var buffer = item.content instanceof ArrayBuffer ? item.content : item.content.buffer;
    var header = new Uint8Array(buffer);
    var format = readBEUint16(header, ETC_PKM_FORMAT_OFFSET);

    if (format !== ETC1_RGB_NO_MIPMAPS && format !== ETC2_RGB_NO_MIPMAPS && format !== ETC2_RGBA_NO_MIPMAPS) {
      return new Error("Invalid magic number in ETC header");
    }

    var width = readBEUint16(header, ETC_PKM_WIDTH_OFFSET);
    var height = readBEUint16(header, ETC_PKM_HEIGHT_OFFSET);
    var encodedWidth = readBEUint16(header, ETC_PKM_ENCODED_WIDTH_OFFSET);
    var encodedHeight = readBEUint16(header, ETC_PKM_ENCODED_HEIGHT_OFFSET); // todo: use new Uint8Array(buffer, ETC_PKM_HEADER_SIZE) instead

    buffer = buffer.slice(ETC_PKM_HEADER_SIZE, buffer.byteLength);
    var etcData = new Uint8Array(buffer);
    var etcAsset = {
      _data: etcData,
      _compressed: true,
      width: width,
      height: height
    };
    return etcAsset;
  }

  var defaultMap = {
    // Images
    'png': loadImage,
    'jpg': loadImage,
    'bmp': loadImage,
    'jpeg': loadImage,
    'gif': loadImage,
    'ico': loadImage,
    'tiff': loadImage,
    'webp': loadImage,
    'image': loadImage,
    'pvr': loadPVRTex,
    'pkm': loadPKMTex,
    // Audio
    'mp3': loadAudioAsAsset,
    'ogg': loadAudioAsAsset,
    'wav': loadAudioAsAsset,
    'm4a': loadAudioAsAsset,
    // json
    'json': loadJSON,
    'ExportJson': loadJSON,
    // plist
    'plist': loadPlist,
    // asset
    'uuid': _uuidLoader.loadUuid,
    'prefab': _uuidLoader.loadUuid,
    'fire': _uuidLoader.loadUuid,
    'scene': _uuidLoader.loadUuid,
    // binary
    'binary': loadBinary,
    'bin': loadBinary,
    // Font
    'font': _fontLoader.loadFont,
    'eot': _fontLoader.loadFont,
    'ttf': _fontLoader.loadFont,
    'woff': _fontLoader.loadFont,
    'svg': _fontLoader.loadFont,
    'ttc': _fontLoader.loadFont,
    'default': loadNothing
  };
  var ID = 'Loader';
  /**
   * @en The loader pipe in {{loader}}, it can load several types of files:
   * 1. Images
   * 2. JSON
   * 3. Plist
   * 4. Audio
   * 5. Font
   * 6. Binary
   * 7. Cocos Assets
   * It will not interfere with items of unknown type.
   * You can pass custom supported types in the {{loader.addLoadHandlers}}.
   * @zh {{loader}} 中的解析加载管线，可以解析加载下列类型的资源：
   * 1. Images
   * 2. JSON
   * 3. Plist
   * 4. Audio
   * 5. Font
   * 6. Binary
   * 7. Cocos Assets
   * 所有未知类型不会被处理，也可以通过 {{loader.addLoadHandlers}} 来定制加载行为
   */

  var Loader = /*#__PURE__*/function () {
    function Loader(extMap) {
      _classCallCheck(this, Loader);

      this.id = ID;
      this.async = true;
      this.pipeline = null;
      this.extMap = void 0;
      this.extMap = (0, _js.mixin)(extMap, defaultMap);
    }
    /**
     * @en Add custom supported types handler or modify existing type handler.
     * @zh 添加自定义支持的类型处理程序或修改现有的类型处理程序。
     * @param extMap Custom supported types with corresponded handler
     * @param extMap Custom supported types with corresponded handler
     */


    _createClass(Loader, [{
      key: "addHandlers",
      value: function addHandlers(extMap) {
        this.extMap = (0, _js.mixin)(this.extMap, extMap);
      }
    }, {
      key: "handle",
      value: function handle(item, callback) {
        var loadFunc = this.extMap[item.type] || this.extMap['default'];
        return loadFunc.call(this, item, callback);
      }
    }]);

    return Loader;
  }(); // @ts-ignore


  _exports.default = Loader;
  Loader.ID = ID;
  _pipeline.Pipeline.Loader = Loader;
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkY6L2plbmtpbnMvd29ya3NwYWNlL0NyZWF0b3JfM0QvZWRpdG9yLTNkL3Jlc291cmNlcy8zZC9lbmdpbmUvY29jb3MvY29yZS9sb2FkLXBpcGVsaW5lL2xvYWRlci50cyJdLCJuYW1lcyI6WyJsb2FkTm90aGluZyIsImxvYWRKU09OIiwiaXRlbSIsImNvbnRlbnQiLCJFcnJvciIsInJlc3VsdCIsIkpTT04iLCJwYXJzZSIsImUiLCJpZCIsImxvYWRJbWFnZSIsImxvYWRCeURlc2VyaWFsaXplZEFzc2V0IiwiX293bmVyIiwiY2MiLCJBc3NldCIsImltYWdlIiwic3lzIiwicGxhdGZvcm0iLCJGQl9QTEFZQUJMRV9BRFMiLCJJbWFnZSIsInJhd1VybCIsImltYWdlQXNzZXQiLCJJbWFnZUFzc2V0IiwiX3V1aWQiLCJ1dWlkIiwiX3VybCIsIl9zZXRSYXdBc3NldCIsIl9uYXRpdmVBc3NldCIsImxvYWRBdWRpb0FzQXNzZXQiLCJjYWxsYmFjayIsImF1ZGlvQ2xpcCIsIkF1ZGlvQ2xpcCIsImxvYWRQbGlzdCIsInBsaXN0UGFyc2VyIiwibG9hZEJpbmFyeSIsImxvYWQiLCJQVlJfSEVBREVSX0xFTkdUSCIsIlBWUl9NQUdJQyIsIlBWUl9IRUFERVJfTUFHSUMiLCJQVlJfSEVBREVSX0ZPUk1BVCIsIlBWUl9IRUFERVJfSEVJR0hUIiwiUFZSX0hFQURFUl9XSURUSCIsIlBWUl9IRUFERVJfTUlQTUFQQ09VTlQiLCJQVlJfSEVBREVSX01FVEFEQVRBIiwibG9hZFBWUlRleCIsImJ1ZmZlciIsIkFycmF5QnVmZmVyIiwiaGVhZGVyIiwiSW50MzJBcnJheSIsIndpZHRoIiwiaGVpZ2h0IiwiZGF0YU9mZnNldCIsInNsaWNlIiwiYnl0ZUxlbmd0aCIsInB2cnRjRGF0YSIsIlVpbnQ4QXJyYXkiLCJwdnJBc3NldCIsIl9kYXRhIiwiX2NvbXByZXNzZWQiLCJoZWFkZXJMZW5ndGgiLCJFVENfUEtNX0hFQURFUl9TSVpFIiwiRVRDX1BLTV9GT1JNQVRfT0ZGU0VUIiwiRVRDX1BLTV9FTkNPREVEX1dJRFRIX09GRlNFVCIsIkVUQ19QS01fRU5DT0RFRF9IRUlHSFRfT0ZGU0VUIiwiRVRDX1BLTV9XSURUSF9PRkZTRVQiLCJFVENfUEtNX0hFSUdIVF9PRkZTRVQiLCJFVEMxX1JHQl9OT19NSVBNQVBTIiwiRVRDMl9SR0JfTk9fTUlQTUFQUyIsIkVUQzJfUkdCQV9OT19NSVBNQVBTIiwicmVhZEJFVWludDE2Iiwib2Zmc2V0IiwibG9hZFBLTVRleCIsImZvcm1hdCIsImVuY29kZWRXaWR0aCIsImVuY29kZWRIZWlnaHQiLCJldGNEYXRhIiwiZXRjQXNzZXQiLCJkZWZhdWx0TWFwIiwibG9hZFV1aWQiLCJsb2FkRm9udCIsIklEIiwiTG9hZGVyIiwiZXh0TWFwIiwiYXN5bmMiLCJwaXBlbGluZSIsImxvYWRGdW5jIiwidHlwZSIsImNhbGwiLCJQaXBlbGluZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFxQ0EsV0FBU0EsV0FBVCxHQUF3QjtBQUNwQixXQUFPLElBQVA7QUFDSDs7QUFFRCxXQUFTQyxRQUFULENBQW1CQyxJQUFuQixFQUF5QjtBQUNyQixRQUFJLE9BQU9BLElBQUksQ0FBQ0MsT0FBWixLQUF3QixRQUE1QixFQUFzQztBQUNsQyxhQUFPLElBQUlDLEtBQUosQ0FBVSx5REFBVixDQUFQO0FBQ0g7O0FBRUQsUUFBSTtBQUNBLFVBQUlDLE1BQU0sR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVdMLElBQUksQ0FBQ0MsT0FBaEIsQ0FBYjtBQUNBLGFBQU9FLE1BQVA7QUFDSCxLQUhELENBSUEsT0FBT0csQ0FBUCxFQUFVO0FBQ04sYUFBTyxJQUFJSixLQUFKLENBQVUsOEJBQThCRixJQUFJLENBQUNPLEVBQW5DLEdBQXdDLGFBQXhDLEdBQXdERCxDQUFsRSxDQUFQO0FBQ0g7QUFDSjs7QUFFRCxXQUFTRSxTQUFULENBQW9CUixJQUFwQixFQUEwQjtBQUN0QixRQUFJUyx1QkFBdUIsR0FBSVQsSUFBSSxDQUFDVSxNQUFMLFlBQXVC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RUFBVTtBQUNwQixZQUFJd0QsUUFBUSxHQUFHLEtBQUtILE1BQUwsQ0FBWWhGLElBQUksQ0FBQ29GLElBQWpCLEtBQTBCLEtBQUtKLE1BQUwsQ0FBWSxTQUFaLENBQXpDO0FBQ0EsZUFBT0csUUFBUSxDQUFDRSxJQUFULENBQWMsSUFBZCxFQUFvQnJGLElBQXBCLEVBQTBCMkIsUUFBMUIsQ0FBUDtBQUNIOzs7O09BR0w7Ozs7QUEzQnFCb0QsRUFBQUEsTSxDQUNWRCxFLEdBQUtBLEU7QUEyQmhCUSxxQkFBU1AsTUFBVCxHQUFrQkEsTUFBbEIiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gQ29weXJpZ2h0IChjKSAyMDEzLTIwMTYgQ2h1a29uZyBUZWNobm9sb2dpZXMgSW5jLlxyXG4gQ29weXJpZ2h0IChjKSAyMDE3LTIwMTggWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuXHJcblxyXG4gaHR0cDovL3d3dy5jb2Nvcy5jb21cclxuXHJcbiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XHJcbiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGVuZ2luZSBzb3VyY2UgY29kZSAodGhlIFwiU29mdHdhcmVcIiksIGEgbGltaXRlZCxcclxuICB3b3JsZHdpZGUsIHJveWFsdHktZnJlZSwgbm9uLWFzc2lnbmFibGUsIHJldm9jYWJsZSBhbmQgbm9uLWV4Y2x1c2l2ZSBsaWNlbnNlXHJcbiB0byB1c2UgQ29jb3MgQ3JlYXRvciBzb2xlbHkgdG8gZGV2ZWxvcCBnYW1lcyBvbiB5b3VyIHRhcmdldCBwbGF0Zm9ybXMuIFlvdSBzaGFsbFxyXG4gIG5vdCB1c2UgQ29jb3MgQ3JlYXRvciBzb2Z0d2FyZSBmb3IgZGV2ZWxvcGluZyBvdGhlciBzb2Z0d2FyZSBvciB0b29scyB0aGF0J3NcclxuICB1c2VkIGZvciBkZXZlbG9waW5nIGdhbWVzLiBZb3UgYXJlIG5vdCBncmFudGVkIHRvIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsXHJcbiAgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIENvY29zIENyZWF0b3IuXHJcblxyXG4gVGhlIHNvZnR3YXJlIG9yIHRvb2xzIGluIHRoaXMgTGljZW5zZSBBZ3JlZW1lbnQgYXJlIGxpY2Vuc2VkLCBub3Qgc29sZC5cclxuIFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLiByZXNlcnZlcyBhbGwgcmlnaHRzIG5vdCBleHByZXNzbHkgZ3JhbnRlZCB0byB5b3UuXHJcblxyXG4gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxyXG4gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXHJcbiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcclxuIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcclxuIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXHJcbiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXHJcbiBUSEUgU09GVFdBUkUuXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIEBjYXRlZ29yeSBsb2FkZXJcclxuICovXHJcblxyXG5pbXBvcnQge21peGlufSBmcm9tICcuLi91dGlscy9qcyc7XHJcbmltcG9ydCB7SW1hZ2VBc3NldH0gZnJvbSAnLi4vYXNzZXRzL2ltYWdlLWFzc2V0JztcclxuaW1wb3J0IHBsaXN0UGFyc2VyIGZyb20gJy4vcGxpc3QtcGFyc2VyJztcclxuaW1wb3J0IHsgUGlwZWxpbmUsIElQaXBlIH0gZnJvbSAnLi9waXBlbGluZSc7XHJcbmltcG9ydCB7bG9hZFV1aWR9IGZyb20gJy4vdXVpZC1sb2FkZXInO1xyXG5pbXBvcnQge2xvYWRGb250fSBmcm9tICcuL2ZvbnQtbG9hZGVyJztcclxuXHJcbmZ1bmN0aW9uIGxvYWROb3RoaW5nICgpIHtcclxuICAgIHJldHVybiBudWxsO1xyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkSlNPTiAoaXRlbSkge1xyXG4gICAgaWYgKHR5cGVvZiBpdGVtLmNvbnRlbnQgIT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBFcnJvcignSlNPTiBMb2FkZXI6IElucHV0IGl0ZW0gZG9lc25cXCd0IGNvbnRhaW4gc3RyaW5nIGNvbnRlbnQnKTtcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIGxldCByZXN1bHQgPSBKU09OLnBhcnNlKGl0ZW0uY29udGVudCk7XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBFcnJvcignSlNPTiBMb2FkZXI6IFBhcnNlIGpzb24gWycgKyBpdGVtLmlkICsgJ10gZmFpbGVkIDogJyArIGUpO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkSW1hZ2UgKGl0ZW0pIHtcclxuICAgIGxldCBsb2FkQnlEZXNlcmlhbGl6ZWRBc3NldCA9IChpdGVtLl9vd25lciBpbnN0YW5jZW9mIGNjLkFzc2V0KTtcclxuICAgIGlmIChsb2FkQnlEZXNlcmlhbGl6ZWRBc3NldCkge1xyXG4gICAgICAgIC8vIGFscmVhZHkgaGFzIGNjLkFzc2V0XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGltYWdlID0gaXRlbS5jb250ZW50O1xyXG4gICAgaWYgKGNjLnN5cy5wbGF0Zm9ybSAhPT0gY2Muc3lzLkZCX1BMQVlBQkxFX0FEUyAmJiAhKGltYWdlIGluc3RhbmNlb2YgSW1hZ2UpKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBFcnJvcignSW1hZ2UgTG9hZGVyOiBJbnB1dCBpdGVtIGRvZXNuXFwndCBjb250YWluIEltYWdlIGNvbnRlbnQnKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBsb2FkIGNjLkltYWdlQXNzZXRcclxuICAgIGxldCByYXdVcmwgPSBpdGVtLnJhd1VybDtcclxuICAgIGxldCBpbWFnZUFzc2V0ID0gaXRlbS5pbWFnZUFzc2V0IHx8IG5ldyBJbWFnZUFzc2V0KCk7XHJcbiAgICBpbWFnZUFzc2V0Ll91dWlkID0gaXRlbS51dWlkO1xyXG4gICAgaW1hZ2VBc3NldC5fdXJsID0gcmF3VXJsO1xyXG4gICAgaW1hZ2VBc3NldC5fc2V0UmF3QXNzZXQocmF3VXJsLCBmYWxzZSk7XHJcbiAgICBpbWFnZUFzc2V0Ll9uYXRpdmVBc3NldCA9IGltYWdlO1xyXG4gICAgcmV0dXJuIGltYWdlQXNzZXQ7XHJcbn1cclxuXHJcbi8vIElmIGF1ZGlvIGlzIGxvYWRlZCBieSB1cmwgZGlyZWN0bHksIHRoYW4gdGhpcyBsb2FkZXIgd2lsbCB3cmFwIGl0IGludG8gYSBuZXcgY2MuQXVkaW9DbGlwIG9iamVjdC5cclxuLy8gSWYgYXVkaW8gaXMgbG9hZGVkIGJ5IGRlc2VyaWFsaXplZCBBdWRpb0NsaXAsIHRoYW4gdGhpcyBsb2FkZXIgd2lsbCBiZSBza2lwcGVkLlxyXG5mdW5jdGlvbiBsb2FkQXVkaW9Bc0Fzc2V0IChpdGVtLCBjYWxsYmFjaykge1xyXG4gICAgbGV0IGxvYWRCeURlc2VyaWFsaXplZEFzc2V0ID0gKGl0ZW0uX293bmVyIGluc3RhbmNlb2YgY2MuQXNzZXQpO1xyXG4gICAgaWYgKGxvYWRCeURlc2VyaWFsaXplZEFzc2V0KSB7XHJcbiAgICAgICAgLy8gYWxyZWFkeSBoYXMgY2MuQXNzZXRcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgYXVkaW9DbGlwID0gbmV3IGNjLkF1ZGlvQ2xpcCgpO1xyXG4gICAgYXVkaW9DbGlwLl9zZXRSYXdBc3NldChpdGVtLnJhd1VybCwgZmFsc2UpO1xyXG4gICAgYXVkaW9DbGlwLl9uYXRpdmVBc3NldCA9IGl0ZW0uY29udGVudDtcclxuICAgIHJldHVybiBhdWRpb0NsaXA7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGxvYWRQbGlzdCAoaXRlbSkge1xyXG4gICAgaWYgKHR5cGVvZiBpdGVtLmNvbnRlbnQgIT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBFcnJvcignUGxpc3QgTG9hZGVyOiBJbnB1dCBpdGVtIGRvZXNuXFwndCBjb250YWluIHN0cmluZyBjb250ZW50Jyk7XHJcbiAgICB9XHJcbiAgICBsZXQgcmVzdWx0ID0gcGxpc3RQYXJzZXIucGFyc2UoaXRlbS5jb250ZW50KTtcclxuICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBFcnJvcignUGxpc3QgTG9hZGVyOiBQYXJzZSBbJyArIGl0ZW0uaWQgKyAnXSBmYWlsZWQnKTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gbG9hZEJpbmFyeSAoaXRlbSkge1xyXG4gICAgLy8gSW52b2tlIGN1c3RvbSBoYW5kbGVcclxuICAgIGlmIChpdGVtLmxvYWQpIHtcclxuICAgICAgICByZXR1cm4gaXRlbS5sb2FkKGl0ZW0uY29udGVudCk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICByZXR1cm4gaXRlbS5jb250ZW50O1xyXG4gICAgfVxyXG59XHJcblxyXG4vLz09PT09PT09PT09PT09PS8vXHJcbi8vIFBWUiBjb25zdGFudHMgLy9cclxuLy89PT09PT09PT09PT09PT0vL1xyXG4vLyBodHRwczovL2dpdGh1Yi5jb20vdG9qaS90ZXh0dXJlLXRlc3Rlci9ibG9iL21hc3Rlci9qcy93ZWJnbC10ZXh0dXJlLXV0aWwuanMjTDQyNFxyXG5jb25zdCBQVlJfSEVBREVSX0xFTkdUSCA9IDEzOyAvLyBUaGUgaGVhZGVyIGxlbmd0aCBpbiAzMiBiaXQgaW50cy5cclxuY29uc3QgUFZSX01BR0lDID0gMHgwMzUyNTY1MDsgLy8weDUwNTY1MjAzO1xyXG5cclxuLy8gT2Zmc2V0cyBpbnRvIHRoZSBoZWFkZXIgYXJyYXkuXHJcbmNvbnN0IFBWUl9IRUFERVJfTUFHSUMgPSAwO1xyXG5jb25zdCBQVlJfSEVBREVSX0ZPUk1BVCA9IDI7XHJcbmNvbnN0IFBWUl9IRUFERVJfSEVJR0hUID0gNjtcclxuY29uc3QgUFZSX0hFQURFUl9XSURUSCA9IDc7XHJcbmNvbnN0IFBWUl9IRUFERVJfTUlQTUFQQ09VTlQgPSAxMTtcclxuY29uc3QgUFZSX0hFQURFUl9NRVRBREFUQSA9IDEyO1xyXG5cclxuZnVuY3Rpb24gbG9hZFBWUlRleCAoaXRlbSkge1xyXG4gICAgbGV0IGJ1ZmZlciA9IGl0ZW0uY29udGVudCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyID8gaXRlbS5jb250ZW50IDogaXRlbS5jb250ZW50LmJ1ZmZlcjtcclxuICAgIC8vIEdldCBhIHZpZXcgb2YgdGhlIGFycmF5QnVmZmVyIHRoYXQgcmVwcmVzZW50cyB0aGUgRERTIGhlYWRlci5cclxuICAgIGxldCBoZWFkZXIgPSBuZXcgSW50MzJBcnJheShidWZmZXIsIDAsIFBWUl9IRUFERVJfTEVOR1RIKTtcclxuXHJcbiAgICAvLyBEbyBzb21lIHNhbml0eSBjaGVja3MgdG8gbWFrZSBzdXJlIHRoaXMgaXMgYSB2YWxpZCBERFMgZmlsZS5cclxuICAgIGlmKGhlYWRlcltQVlJfSEVBREVSX01BR0lDXSA9PT0gUFZSX01BR0lDKSB7XHJcbiAgICAgIC8vIEdhdGhlciBvdGhlciBiYXNpYyBtZXRyaWNzIGFuZCBhIHZpZXcgb2YgdGhlIHJhdyB0aGUgRFhUIGRhdGEuXHJcbiAgICAgICAgbGV0IHdpZHRoID0gaGVhZGVyW1BWUl9IRUFERVJfV0lEVEhdO1xyXG4gICAgICAgIGxldCBoZWlnaHQgPSBoZWFkZXJbUFZSX0hFQURFUl9IRUlHSFRdO1xyXG4gICAgICAgIGxldCBkYXRhT2Zmc2V0ID0gaGVhZGVyW1BWUl9IRUFERVJfTUVUQURBVEFdICsgNTI7XHJcbiAgICAgICAgLy8gdG9kbzogdXNlIG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgZGF0YU9mZnNldCkgaW5zdGVhZFxyXG4gICAgICAgIGJ1ZmZlciA9IGJ1ZmZlci5zbGljZShkYXRhT2Zmc2V0LCBidWZmZXIuYnl0ZUxlbmd0aCk7XHJcbiAgICAgICAgbGV0IHB2cnRjRGF0YSA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7XHJcbiAgICAgICAgbGV0IHB2ckFzc2V0ID0ge1xyXG4gICAgICAgICAgICBfZGF0YTogcHZydGNEYXRhLFxyXG4gICAgICAgICAgICBfY29tcHJlc3NlZDogdHJ1ZSxcclxuICAgICAgICAgICAgd2lkdGg6IHdpZHRoLFxyXG4gICAgICAgICAgICBoZWlnaHQ6IGhlaWdodCxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBwdnJBc3NldDtcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKGhlYWRlclsxMV0gPT09IDB4MjE1MjU2NTApIHtcclxuICAgICAgICBsZXQgaGVhZGVyTGVuZ3RoID0gaGVhZGVyWzBdLFxyXG5cdFx0aGVpZ2h0ID0gaGVhZGVyWzFdLFxyXG4gICAgICAgIHdpZHRoID0gaGVhZGVyWzJdXHJcbiAgICAgICAgLy8gdG9kbzogdXNlIG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgaGVhZGVyTGVuZ3RoKSBpbnN0ZWFkXHJcbiAgICAgICAgYnVmZmVyID0gYnVmZmVyLnNsaWNlKGhlYWRlckxlbmd0aCwgYnVmZmVyLmJ5dGVMZW5ndGgpO1xyXG4gICAgICAgIGxldCBwdnJ0Y0RhdGEgPSBuZXcgVWludDhBcnJheShidWZmZXIpO1xyXG4gICAgICAgIGxldCBwdnJBc3NldCA9IHtcclxuICAgICAgICAgICAgX2RhdGE6IHB2cnRjRGF0YSxcclxuICAgICAgICAgICAgX2NvbXByZXNzZWQ6IHRydWUsXHJcbiAgICAgICAgICAgIHdpZHRoOiB3aWR0aCxcclxuICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQsXHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXR1cm4gcHZyQXNzZXQ7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICByZXR1cm4gbmV3IEVycm9yKFwiSW52YWxpZCBtYWdpYyBudW1iZXIgaW4gUFZSIGhlYWRlclwiKTtcclxuICAgIH1cclxufVxyXG5cclxuLy89PT09PT09PT09PT09PT0vL1xyXG4vLyBFVEMgY29uc3RhbnRzIC8vXHJcbi8vPT09PT09PT09PT09PT09Ly9cclxuXHJcbmNvbnN0IEVUQ19QS01fSEVBREVSX1NJWkUgPSAxNjtcclxuXHJcbmNvbnN0IEVUQ19QS01fRk9STUFUX09GRlNFVCA9IDY7XHJcbmNvbnN0IEVUQ19QS01fRU5DT0RFRF9XSURUSF9PRkZTRVQgPSA4O1xyXG5jb25zdCBFVENfUEtNX0VOQ09ERURfSEVJR0hUX09GRlNFVCA9IDEwO1xyXG5jb25zdCBFVENfUEtNX1dJRFRIX09GRlNFVCA9IDEyO1xyXG5jb25zdCBFVENfUEtNX0hFSUdIVF9PRkZTRVQgPSAxNDtcclxuXHJcbmNvbnN0IEVUQzFfUkdCX05PX01JUE1BUFMgICA9IDA7XHJcbmNvbnN0IEVUQzJfUkdCX05PX01JUE1BUFMgICA9IDE7XHJcbmNvbnN0IEVUQzJfUkdCQV9OT19NSVBNQVBTICA9IDM7XHJcblxyXG5cclxuZnVuY3Rpb24gcmVhZEJFVWludDE2KGhlYWRlciwgb2Zmc2V0KSB7XHJcbiAgICByZXR1cm4gKGhlYWRlcltvZmZzZXRdIDw8IDgpIHwgaGVhZGVyW29mZnNldCsxXTtcclxufVxyXG5mdW5jdGlvbiBsb2FkUEtNVGV4KGl0ZW0pIHtcclxuICAgIGxldCBidWZmZXIgPSBpdGVtLmNvbnRlbnQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlciA/IGl0ZW0uY29udGVudCA6IGl0ZW0uY29udGVudC5idWZmZXI7XHJcbiAgICBsZXQgaGVhZGVyID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyKTtcclxuICAgIGxldCBmb3JtYXQgPSByZWFkQkVVaW50MTYoaGVhZGVyLCBFVENfUEtNX0ZPUk1BVF9PRkZTRVQpO1xyXG4gICAgaWYgKGZvcm1hdCAhPT0gRVRDMV9SR0JfTk9fTUlQTUFQUyAmJiBmb3JtYXQgIT09IEVUQzJfUkdCX05PX01JUE1BUFMgJiYgZm9ybWF0ICE9PSBFVEMyX1JHQkFfTk9fTUlQTUFQUykge1xyXG4gICAgICAgIHJldHVybiBuZXcgRXJyb3IoXCJJbnZhbGlkIG1hZ2ljIG51bWJlciBpbiBFVEMgaGVhZGVyXCIpO1xyXG4gICAgfVxyXG4gICAgbGV0IHdpZHRoID0gcmVhZEJFVWludDE2KGhlYWRlciwgRVRDX1BLTV9XSURUSF9PRkZTRVQpO1xyXG4gICAgbGV0IGhlaWdodCA9IHJlYWRCRVVpbnQxNihoZWFkZXIsIEVUQ19QS01fSEVJR0hUX09GRlNFVCk7XHJcbiAgICBsZXQgZW5jb2RlZFdpZHRoID0gcmVhZEJFVWludDE2KGhlYWRlciwgRVRDX1BLTV9FTkNPREVEX1dJRFRIX09GRlNFVCk7XHJcbiAgICBsZXQgZW5jb2RlZEhlaWdodCA9IHJlYWRCRVVpbnQxNihoZWFkZXIsIEVUQ19QS01fRU5DT0RFRF9IRUlHSFRfT0ZGU0VUKTtcclxuICAgIC8vIHRvZG86IHVzZSBuZXcgVWludDhBcnJheShidWZmZXIsIEVUQ19QS01fSEVBREVSX1NJWkUpIGluc3RlYWRcclxuICAgIGJ1ZmZlciA9IGJ1ZmZlci5zbGljZShFVENfUEtNX0hFQURFUl9TSVpFLCBidWZmZXIuYnl0ZUxlbmd0aCk7XHJcbiAgICBsZXQgZXRjRGF0YSA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7XHJcblxyXG4gICAgbGV0IGV0Y0Fzc2V0ID0ge1xyXG4gICAgICAgIF9kYXRhOiBldGNEYXRhLFxyXG4gICAgICAgIF9jb21wcmVzc2VkOiB0cnVlLFxyXG4gICAgICAgIHdpZHRoOiB3aWR0aCxcclxuICAgICAgICBoZWlnaHQ6IGhlaWdodFxyXG4gICAgfTtcclxuICAgIHJldHVybiBldGNBc3NldDtcclxufVxyXG5cclxubGV0IGRlZmF1bHRNYXAgPSB7XHJcbiAgICAvLyBJbWFnZXNcclxuICAgICdwbmcnIDogbG9hZEltYWdlLFxyXG4gICAgJ2pwZycgOiBsb2FkSW1hZ2UsXHJcbiAgICAnYm1wJyA6IGxvYWRJbWFnZSxcclxuICAgICdqcGVnJyA6IGxvYWRJbWFnZSxcclxuICAgICdnaWYnIDogbG9hZEltYWdlLFxyXG4gICAgJ2ljbycgOiBsb2FkSW1hZ2UsXHJcbiAgICAndGlmZicgOiBsb2FkSW1hZ2UsXHJcbiAgICAnd2VicCcgOiBsb2FkSW1hZ2UsXHJcbiAgICAnaW1hZ2UnIDogbG9hZEltYWdlLFxyXG4gICAgJ3B2cicgOiBsb2FkUFZSVGV4LFxyXG4gICAgJ3BrbScgOiBsb2FkUEtNVGV4LFxyXG5cclxuICAgIC8vIEF1ZGlvXHJcbiAgICAnbXAzJyA6IGxvYWRBdWRpb0FzQXNzZXQsXHJcbiAgICAnb2dnJyA6IGxvYWRBdWRpb0FzQXNzZXQsXHJcbiAgICAnd2F2JyA6IGxvYWRBdWRpb0FzQXNzZXQsXHJcbiAgICAnbTRhJyA6IGxvYWRBdWRpb0FzQXNzZXQsXHJcblxyXG4gICAgLy8ganNvblxyXG4gICAgJ2pzb24nIDogbG9hZEpTT04sXHJcbiAgICAnRXhwb3J0SnNvbicgOiBsb2FkSlNPTixcclxuXHJcbiAgICAvLyBwbGlzdFxyXG4gICAgJ3BsaXN0JyA6IGxvYWRQbGlzdCxcclxuXHJcbiAgICAvLyBhc3NldFxyXG4gICAgJ3V1aWQnIDogbG9hZFV1aWQsXHJcbiAgICAncHJlZmFiJyA6IGxvYWRVdWlkLFxyXG4gICAgJ2ZpcmUnIDogbG9hZFV1aWQsXHJcbiAgICAnc2NlbmUnIDogbG9hZFV1aWQsXHJcblxyXG4gICAgLy8gYmluYXJ5XHJcbiAgICAnYmluYXJ5JyA6IGxvYWRCaW5hcnksXHJcbiAgICAnYmluJzogbG9hZEJpbmFyeSxcclxuXHJcbiAgICAvLyBGb250XHJcbiAgICAnZm9udCcgOiBsb2FkRm9udCxcclxuICAgICdlb3QnIDogbG9hZEZvbnQsXHJcbiAgICAndHRmJyA6IGxvYWRGb250LFxyXG4gICAgJ3dvZmYnIDogbG9hZEZvbnQsXHJcbiAgICAnc3ZnJyA6IGxvYWRGb250LFxyXG4gICAgJ3R0YycgOiBsb2FkRm9udCxcclxuXHJcbiAgICAnZGVmYXVsdCcgOiBsb2FkTm90aGluZ1xyXG59O1xyXG5cclxubGV0IElEID0gJ0xvYWRlcic7XHJcblxyXG4vKipcclxuICogQGVuIFRoZSBsb2FkZXIgcGlwZSBpbiB7e2xvYWRlcn19LCBpdCBjYW4gbG9hZCBzZXZlcmFsIHR5cGVzIG9mIGZpbGVzOlxyXG4gKiAxLiBJbWFnZXNcclxuICogMi4gSlNPTlxyXG4gKiAzLiBQbGlzdFxyXG4gKiA0LiBBdWRpb1xyXG4gKiA1LiBGb250XHJcbiAqIDYuIEJpbmFyeVxyXG4gKiA3LiBDb2NvcyBBc3NldHNcclxuICogSXQgd2lsbCBub3QgaW50ZXJmZXJlIHdpdGggaXRlbXMgb2YgdW5rbm93biB0eXBlLlxyXG4gKiBZb3UgY2FuIHBhc3MgY3VzdG9tIHN1cHBvcnRlZCB0eXBlcyBpbiB0aGUge3tsb2FkZXIuYWRkTG9hZEhhbmRsZXJzfX0uXHJcbiAqIEB6aCB7e2xvYWRlcn19IOS4reeahOino+aekOWKoOi9veeuoee6v++8jOWPr+S7peino+aekOWKoOi9veS4i+WIl+exu+Wei+eahOi1hOa6kO+8mlxyXG4gKiAxLiBJbWFnZXNcclxuICogMi4gSlNPTlxyXG4gKiAzLiBQbGlzdFxyXG4gKiA0LiBBdWRpb1xyXG4gKiA1LiBGb250XHJcbiAqIDYuIEJpbmFyeVxyXG4gKiA3LiBDb2NvcyBBc3NldHNcclxuICog5omA5pyJ5pyq55+l57G75Z6L5LiN5Lya6KKr5aSE55CG77yM5Lmf5Y+v5Lul6YCa6L+HIHt7bG9hZGVyLmFkZExvYWRIYW5kbGVyc319IOadpeWumuWItuWKoOi9veihjOS4ulxyXG4gKi9cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTG9hZGVyIGltcGxlbWVudHMgSVBpcGUge1xyXG4gICAgc3RhdGljIElEID0gSUQ7XHJcblxyXG4gICAgcHVibGljIGlkID0gSUQ7XHJcbiAgICBwdWJsaWMgYXN5bmMgPSB0cnVlO1xyXG4gICAgcHVibGljIHBpcGVsaW5lOiBQaXBlbGluZSB8IG51bGwgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBleHRNYXA6IG9iamVjdDtcclxuICAgIGNvbnN0cnVjdG9yIChleHRNYXA/KSB7XHJcbiAgICAgICAgdGhpcy5leHRNYXAgPSBtaXhpbihleHRNYXAsIGRlZmF1bHRNYXApO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQGVuIEFkZCBjdXN0b20gc3VwcG9ydGVkIHR5cGVzIGhhbmRsZXIgb3IgbW9kaWZ5IGV4aXN0aW5nIHR5cGUgaGFuZGxlci5cclxuICAgICAqIEB6aCDmt7vliqDoh6rlrprkuYnmlK/mjIHnmoTnsbvlnovlpITnkIbnqIvluo/miJbkv67mlLnnjrDmnInnmoTnsbvlnovlpITnkIbnqIvluo/jgIJcclxuICAgICAqIEBwYXJhbSBleHRNYXAgQ3VzdG9tIHN1cHBvcnRlZCB0eXBlcyB3aXRoIGNvcnJlc3BvbmRlZCBoYW5kbGVyXHJcbiAgICAgKiBAcGFyYW0gZXh0TWFwIEN1c3RvbSBzdXBwb3J0ZWQgdHlwZXMgd2l0aCBjb3JyZXNwb25kZWQgaGFuZGxlclxyXG4gICAgICovXHJcbiAgICBhZGRIYW5kbGVycyAoZXh0TWFwOiBNYXA8c3RyaW5nLCBGdW5jdGlvbj4pIHtcclxuICAgICAgICB0aGlzLmV4dE1hcCA9IG1peGluKHRoaXMuZXh0TWFwLCBleHRNYXApO1xyXG4gICAgfVxyXG5cclxuICAgIGhhbmRsZSAoaXRlbSwgY2FsbGJhY2spIHtcclxuICAgICAgICBsZXQgbG9hZEZ1bmMgPSB0aGlzLmV4dE1hcFtpdGVtLnR5cGVdIHx8IHRoaXMuZXh0TWFwWydkZWZhdWx0J107XHJcbiAgICAgICAgcmV0dXJuIGxvYWRGdW5jLmNhbGwodGhpcywgaXRlbSwgY2FsbGJhY2spO1xyXG4gICAgfVxyXG59XHJcblxyXG4vLyBAdHMtaWdub3JlXHJcblBpcGVsaW5lLkxvYWRlciA9IExvYWRlcjtcclxuIl19