(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../math/index.js", "./target-path.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../math/index.js"), require("./target-path.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.index, global.targetPath);
    global.skeletalAnimationDataHub = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _index, _targetPath) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.SkelAnimDataHub = void 0;

  function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

  function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

  function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

  /**
   * 骨骼动画数据转换中心。
   */
  var SkelAnimDataHub = /*#__PURE__*/function () {
    function SkelAnimDataHub() {
      _classCallCheck(this, SkelAnimDataHub);
    }

    _createClass(SkelAnimDataHub, null, [{
      key: "getOrExtract",
      value: function getOrExtract(clip) {
        var data = SkelAnimDataHub.pool.get(clip);

        if (!data || data.info.sample !== clip.sample) {
          // release outdated render data
          if (data) {
            cc.director.root.dataPoolManager.releaseAnimationClip(clip);
          }

          data = convertToSkeletalCurves(clip);
          SkelAnimDataHub.pool.set(clip, data);
        }

        return data;
      }
    }, {
      key: "destroy",
      value: function destroy(clip) {
        SkelAnimDataHub.pool["delete"](clip);
      }
    }]);

    return SkelAnimDataHub;
  }();

  _exports.SkelAnimDataHub = SkelAnimDataHub;
  SkelAnimDataHub.pool = new Map();

  function convertToSkeletalCurves(clip) {
    var data = {};
    clip.curves.forEach(function (curve) {
      if (!curve.valueAdapter && (0, _targetPath.isCustomPath)(curve.modifiers[0], _targetPath.HierarchyPath) && (0, _targetPath.isPropertyPath)(curve.modifiers[1])) {
        var path = curve.modifiers[0].path;
        var cs = data[path];

        if (!cs) {
          cs = data[path] = {};
        }

        var property = curve.modifiers[1];
        cs[property] = {
          values: curve.data.values,
          keys: curve.data.keys
        }; // don't use curve.data directly
      }
    });
    var frames = Math.ceil(clip.sample * clip.duration) + 1; // lazy eval the conversion due to memory-heavy ops
    // many animation paths may not be actually in-use

    var _loop = function _loop() {
      var path = _Object$keys[_i];
      var props = data[path];

      if (!props) {
        return "continue";
      }

      Object.defineProperty(props, 'worldMatrix', {
        get: function get() {
          if (!props._worldMatrix) {
            var position = props.position,
                rotation = props.rotation,
                scale = props.scale; // fixed step pre-sample

            convertToUniformSample(clip, position, frames);
            convertToUniformSample(clip, rotation, frames);
            convertToUniformSample(clip, scale, frames); // transform to world space

            convertToWorldSpace(data, path, props);
          }

          return props._worldMatrix;
        }
      });
    };

    for (var _i = 0, _Object$keys = Object.keys(data); _i < _Object$keys.length; _i++) {
      var _ret = _loop();

      if (_ret === "continue") continue;
    }

    var info = {
      frames: frames,
      sample: clip.sample
    };
    return {
      info: info,
      data: data
    };
  }

  function convertToUniformSample(clip, curve, frames) {
    var keys = clip.keys[curve.keys];
    var values = [];

    if (!keys || keys.length === 1) {
      for (var i = 0; i < frames; i++) {
        values[i] = curve.values[0].clone(); // never forget to clone
      }
    } else {
      var isQuat = curve.values[0] instanceof _index.Quat;

      for (var _i2 = 0, idx = 0; _i2 < frames; _i2++) {
        var time = _i2 / clip.sample;

        while (keys[idx] <= time) {
          idx++;
        }

        if (idx > keys.length - 1) {
          idx = keys.length - 1;
          time = keys[idx];
        } else if (idx === 0) {
          idx = 1;
        }

        var from = curve.values[idx - 1].clone();
        var denom = keys[idx] - keys[idx - 1];
        var ratio = denom ? (0, _index.clamp01)((time - keys[idx - 1]) / denom) : 1;

        if (isQuat) {
          from.slerp(curve.values[idx], ratio);
        } else {
          from.lerp(curve.values[idx], ratio);
        }

        values[_i2] = from;
      }
    }

    curve.values = values;
  }

  function convertToWorldSpace(convertedProps, path, props) {
    var oPos = props.position.values;
    var oRot = props.rotation.values;
    var oScale = props.scale.values;
    var matrix = oPos.map(function () {
      return new _index.Mat4();
    });
    var idx = path.lastIndexOf('/');
    var pMatrix = null;

    if (idx > 0) {
      var name = path.substring(0, idx);
      var data = convertedProps[name];

      if (!data) {
        console.warn('no data for parent bone?');
        return;
      }

      pMatrix = data.worldMatrix.values;
    } // all props should have the same length now


    for (var i = 0; i < oPos.length; i++) {
      var oT = oPos[i];
      var oR = oRot[i];
      var oS = oScale[i];
      var m = matrix[i];

      _index.Mat4.fromRTS(m, oR, oT, oS);

      if (pMatrix) {
        _index.Mat4.multiply(m, pMatrix[i], m);
      }
    }

    Object.keys(props).forEach(function (k) {
      return delete props[k];
    });
    props._worldMatrix = {
      keys: 0,
      interpolate: false,
      values: matrix
    };
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkY6L2plbmtpbnMvd29ya3NwYWNlL0NyZWF0b3JfM0QvZWRpdG9yLTNkL3Jlc291cmNlcy8zZC9lbmdpbmUvY29jb3MvY29yZS9hbmltYXRpb24vc2tlbGV0YWwtYW5pbWF0aW9uLWRhdGEtaHViLnRzIl0sIm5hbWVzIjpbIlNrZWxBbmltRGF0YUh1YiIsImNsaXAiLCJkYXRhIiwicG9vbCIsImdldCIsImluZm8iLCJzYW1wbGUiLCJjYyIsImRpcmVjdG9yIiwicm9vdCIsImRhdGFQb29sTWFuYWdlciIsInJlbGVhc2VBbmltYXRpb25DbGlwIiwiY29udmVydFRvU2tlbGV0YWxDdXJ2ZXMiLCJzZXQiLCJNYXAiLCJjdXJ2ZXMiLCJmb3JFYWNoIiwiY3VydmUiLCJ2YWx1ZUFkYXB0ZXIiLCJtb2RpZmllcnMiLCJIaWVyYXJjaHlQYXRoIiwicGF0aCIsImNzIiwicHJvcGVydHkiLCJ2YWx1ZXMiLCJrZXlzIiwiZnJhbWVzIiwiTWF0aCIsImNlaWwiLCJkdXJhdGlvbiIsInByb3BzIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJfd29ybGRNYXRyaXgiLCJwb3NpdGlvbiIsInJvdGF0aW9uIiwic2NhbGUiLCJjb252ZXJ0VG9Vbmlmb3JtU2FtcGxlIiwiY29udmVydFRvV29ybGRTcGFjZSIsImxlbmd0aCIsImkiLCJjbG9uZSIsImlzUXVhdCIsIlF1YXQiLCJpZHgiLCJ0aW1lIiwiZnJvbSIsImRlbm9tIiwicmF0aW8iLCJzbGVycCIsImxlcnAiLCJjb252ZXJ0ZWRQcm9wcyIsIm9Qb3MiLCJvUm90Iiwib1NjYWxlIiwibWF0cml4IiwibWFwIiwiTWF0NCIsImxhc3RJbmRleE9mIiwicE1hdHJpeCIsIm5hbWUiLCJzdWJzdHJpbmciLCJjb25zb2xlIiwid2FybiIsIndvcmxkTWF0cml4Iiwib1QiLCJvUiIsIm9TIiwibSIsImZyb21SVFMiLCJtdWx0aXBseSIsImsiLCJpbnRlcnBvbGF0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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MEM7QUFBUzs7QUFDaEVKLE1BQUFBLE9BQU8sR0FBR3pELElBQUksQ0FBQzhELFdBQUwsQ0FBaUJ4QyxNQUEzQjtBQUNILEtBWmdILENBYWpIOzs7QUFDQSxTQUFLLElBQUlnQixDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHWSxJQUFJLENBQUNiLE1BQXpCLEVBQWlDQyxDQUFDLEVBQWxDLEVBQXNDO0FBQ2xDLFVBQU15QixFQUFFLEdBQUdiLElBQUksQ0FBQ1osQ0FBRCxDQUFmO0FBQ0EsVUFBTTBCLEVBQUUsR0FBR2IsSUFBSSxDQUFDYixDQUFELENBQWY7QUFDQSxVQUFNMkIsRUFBRSxHQUFHYixNQUFNLENBQUNkLENBQUQsQ0FBakI7QUFDQSxVQUFNNEIsQ0FBQyxHQUFHYixNQUFNLENBQUNmLENBQUQsQ0FBaEI7O0FBQ0FpQixrQkFBS1ksT0FBTCxDQUFhRCxDQUFiLEVBQWdCRixFQUFoQixFQUFvQkQsRUFBcEIsRUFBd0JFLEVBQXhCOztBQUNBLFVBQUlSLE9BQUosRUFBYTtBQUFFRixvQkFBS2EsUUFBTCxDQUFjRixDQUFkLEVBQWlCVCxPQUFPLENBQUNuQixDQUFELENBQXhCLEVBQTZCNEIsQ0FBN0I7QUFBa0M7QUFDcEQ7O0FBQ0RyQyxJQUFBQSxNQUFNLENBQUNOLElBQVAsQ0FBWUssS0FBWixFQUFtQmQsT0FBbkIsQ0FBMkIsVUFBQ3VELENBQUQ7QUFBQSxhQUFPLE9BQU96QyxLQUFLLENBQUN5QyxDQUFELENBQW5CO0FBQUEsS0FBM0I7QUFDQXpDLElBQUFBLEtBQUssQ0FBQ0csWUFBTixHQUFxQjtBQUFFUixNQUFBQSxJQUFJLEVBQUUsQ0FBUjtBQUFXK0MsTUFBQUEsV0FBVyxFQUFFLEtBQXhCO0FBQStCaEQsTUFBQUEsTUFBTSxFQUFFK0I7QUFBdkMsS0FBckI7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiBDb3B5cmlnaHQgKGMpIDIwMTctMjAxOCBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC5cclxuXHJcbiBodHRwOi8vd3d3LmNvY29zLmNvbVxyXG5cclxuIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcclxuIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZW5naW5lIHNvdXJjZSBjb2RlICh0aGUgXCJTb2Z0d2FyZVwiKSwgYSBsaW1pdGVkLFxyXG4gIHdvcmxkd2lkZSwgcm95YWx0eS1mcmVlLCBub24tYXNzaWduYWJsZSwgcmV2b2NhYmxlIGFuZCBub24tZXhjbHVzaXZlIGxpY2Vuc2VcclxuIHRvIHVzZSBDb2NvcyBDcmVhdG9yIHNvbGVseSB0byBkZXZlbG9wIGdhbWVzIG9uIHlvdXIgdGFyZ2V0IHBsYXRmb3Jtcy4gWW91IHNoYWxsXHJcbiAgbm90IHVzZSBDb2NvcyBDcmVhdG9yIHNvZnR3YXJlIGZvciBkZXZlbG9waW5nIG90aGVyIHNvZnR3YXJlIG9yIHRvb2xzIHRoYXQnc1xyXG4gIHVzZWQgZm9yIGRldmVsb3BpbmcgZ2FtZXMuIFlvdSBhcmUgbm90IGdyYW50ZWQgdG8gcHVibGlzaCwgZGlzdHJpYnV0ZSxcclxuICBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgQ29jb3MgQ3JlYXRvci5cclxuXHJcbiBUaGUgc29mdHdhcmUgb3IgdG9vbHMgaW4gdGhpcyBMaWNlbnNlIEFncmVlbWVudCBhcmUgbGljZW5zZWQsIG5vdCBzb2xkLlxyXG4gWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuIHJlc2VydmVzIGFsbCByaWdodHMgbm90IGV4cHJlc3NseSBncmFudGVkIHRvIHlvdS5cclxuXHJcbiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXHJcbiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcclxuIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxyXG4gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxyXG4gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcclxuIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cclxuIFRIRSBTT0ZUV0FSRS5cclxuKi9cclxuXHJcbi8qKlxyXG4gKiBAY2F0ZWdvcnkgYW5pbWF0aW9uXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgY2xhbXAwMSwgTWF0NCwgUXVhdCwgVmVjMyB9IGZyb20gJy4uL21hdGgnO1xyXG5pbXBvcnQgeyBEYXRhUG9vbE1hbmFnZXIgfSBmcm9tICcuLi9yZW5kZXJlci9kYXRhLXBvb2wtbWFuYWdlcic7XHJcbmltcG9ydCB7IEFuaW1hdGlvbkNsaXAsIElPYmplY3RDdXJ2ZURhdGEgfSBmcm9tICcuL2FuaW1hdGlvbi1jbGlwJztcclxuaW1wb3J0IHsgSGllcmFyY2h5UGF0aCwgaXNDdXN0b21QYXRoLCBpc1Byb3BlcnR5UGF0aCB9IGZyb20gJy4vdGFyZ2V0LXBhdGgnO1xyXG5cclxudHlwZSBDdXJ2ZURhdGEgPSBWZWMzW10gfCBRdWF0W10gfCBNYXQ0W107XHJcbnR5cGUgQ29udmVydGVkUHJvcHMgPSBSZWNvcmQ8c3RyaW5nLCBJUHJvcGVydHlDdXJ2ZT47XHJcblxyXG5pbnRlcmZhY2UgSVByb3BlcnR5Q3VydmUge1xyXG4gICAga2V5czogbnVtYmVyO1xyXG4gICAgdmFsdWVzOiBDdXJ2ZURhdGE7XHJcbn1cclxuaW50ZXJmYWNlIElTa2VsZXRhbEN1cnZlSW5mbyB7XHJcbiAgICBmcmFtZXM6IG51bWJlcjtcclxuICAgIHNhbXBsZTogbnVtYmVyO1xyXG59XHJcbmludGVyZmFjZSBJQ29udmVydGVkRGF0YSB7XHJcbiAgICBpbmZvOiBJU2tlbGV0YWxDdXJ2ZUluZm87XHJcbiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBDb252ZXJ0ZWRQcm9wcz47XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDpqqjpqrzliqjnlLvmlbDmja7ovazmjaLkuK3lv4PjgIJcclxuICovXHJcbmV4cG9ydCBjbGFzcyBTa2VsQW5pbURhdGFIdWIge1xyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0T3JFeHRyYWN0IChjbGlwOiBBbmltYXRpb25DbGlwKSB7XHJcbiAgICAgICAgbGV0IGRhdGEgPSBTa2VsQW5pbURhdGFIdWIucG9vbC5nZXQoY2xpcCk7XHJcbiAgICAgICAgaWYgKCFkYXRhIHx8IGRhdGEuaW5mby5zYW1wbGUgIT09IGNsaXAuc2FtcGxlKSB7XHJcbiAgICAgICAgICAgIC8vIHJlbGVhc2Ugb3V0ZGF0ZWQgcmVuZGVyIGRhdGFcclxuICAgICAgICAgICAgaWYgKGRhdGEpIHsgKGNjLmRpcmVjdG9yLnJvb3QuZGF0YVBvb2xNYW5hZ2VyIGFzIERhdGFQb29sTWFuYWdlcikucmVsZWFzZUFuaW1hdGlvbkNsaXAoY2xpcCk7IH1cclxuICAgICAgICAgICAgZGF0YSA9IGNvbnZlcnRUb1NrZWxldGFsQ3VydmVzKGNsaXApO1xyXG4gICAgICAgICAgICBTa2VsQW5pbURhdGFIdWIucG9vbC5zZXQoY2xpcCwgZGF0YSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBkYXRhO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgZGVzdHJveSAoY2xpcDogQW5pbWF0aW9uQ2xpcCkge1xyXG4gICAgICAgIFNrZWxBbmltRGF0YUh1Yi5wb29sLmRlbGV0ZShjbGlwKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgc3RhdGljIHBvb2wgPSBuZXcgTWFwPEFuaW1hdGlvbkNsaXAsIElDb252ZXJ0ZWREYXRhPigpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb252ZXJ0VG9Ta2VsZXRhbEN1cnZlcyAoY2xpcDogQW5pbWF0aW9uQ2xpcCk6IElDb252ZXJ0ZWREYXRhIHtcclxuICAgIGNvbnN0IGRhdGE6IFJlY29yZDxzdHJpbmcsIENvbnZlcnRlZFByb3BzPiA9IHt9O1xyXG4gICAgY2xpcC5jdXJ2ZXMuZm9yRWFjaCgoY3VydmUpID0+IHtcclxuICAgICAgICBpZiAoIWN1cnZlLnZhbHVlQWRhcHRlciAmJlxyXG4gICAgICAgICAgICBpc0N1c3RvbVBhdGgoY3VydmUubW9kaWZpZXJzWzBdLCBIaWVyYXJjaHlQYXRoKSAmJlxyXG4gICAgICAgICAgICBpc1Byb3BlcnR5UGF0aChjdXJ2ZS5tb2RpZmllcnNbMV0pKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhdGggPSAoY3VydmUubW9kaWZpZXJzWzBdIGFzIEhpZXJhcmNoeVBhdGgpLnBhdGg7XHJcbiAgICAgICAgICAgIGxldCBjcyA9IGRhdGFbcGF0aF07XHJcbiAgICAgICAgICAgIGlmICghY3MpIHsgY3MgPSBkYXRhW3BhdGhdID0ge307IH1cclxuICAgICAgICAgICAgY29uc3QgcHJvcGVydHkgPSBjdXJ2ZS5tb2RpZmllcnNbMV0gYXMgc3RyaW5nO1xyXG4gICAgICAgICAgICBjc1twcm9wZXJ0eV0gPSB7IHZhbHVlczogY3VydmUuZGF0YS52YWx1ZXMsIGtleXM6IGN1cnZlLmRhdGEua2V5cyB9OyAvLyBkb24ndCB1c2UgY3VydmUuZGF0YSBkaXJlY3RseVxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgY29uc3QgZnJhbWVzID0gTWF0aC5jZWlsKGNsaXAuc2FtcGxlICogY2xpcC5kdXJhdGlvbikgKyAxO1xyXG4gICAgLy8gbGF6eSBldmFsIHRoZSBjb252ZXJzaW9uIGR1ZSB0byBtZW1vcnktaGVhdnkgb3BzXHJcbiAgICAvLyBtYW55IGFuaW1hdGlvbiBwYXRocyBtYXkgbm90IGJlIGFjdHVhbGx5IGluLXVzZVxyXG4gICAgZm9yIChjb25zdCBwYXRoIG9mIE9iamVjdC5rZXlzKGRhdGEpKSB7XHJcbiAgICAgICAgY29uc3QgcHJvcHMgPSBkYXRhW3BhdGhdO1xyXG4gICAgICAgIGlmICghcHJvcHMpIHsgY29udGludWU7IH1cclxuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICd3b3JsZE1hdHJpeCcsIHtcclxuICAgICAgICAgICAgZ2V0OiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXByb3BzLl93b3JsZE1hdHJpeCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgcG9zaXRpb24sIHJvdGF0aW9uLCBzY2FsZSB9ID0gcHJvcHM7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gZml4ZWQgc3RlcCBwcmUtc2FtcGxlXHJcbiAgICAgICAgICAgICAgICAgICAgY29udmVydFRvVW5pZm9ybVNhbXBsZShjbGlwLCBwb3NpdGlvbiwgZnJhbWVzKTtcclxuICAgICAgICAgICAgICAgICAgICBjb252ZXJ0VG9Vbmlmb3JtU2FtcGxlKGNsaXAsIHJvdGF0aW9uLCBmcmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnZlcnRUb1VuaWZvcm1TYW1wbGUoY2xpcCwgc2NhbGUsIGZyYW1lcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdHJhbnNmb3JtIHRvIHdvcmxkIHNwYWNlXHJcbiAgICAgICAgICAgICAgICAgICAgY29udmVydFRvV29ybGRTcGFjZShkYXRhLCBwYXRoLCBwcm9wcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJvcHMuX3dvcmxkTWF0cml4O1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaW5mbzogSVNrZWxldGFsQ3VydmVJbmZvID0ge1xyXG4gICAgICAgIGZyYW1lcyxcclxuICAgICAgICBzYW1wbGU6IGNsaXAuc2FtcGxlLFxyXG4gICAgfTtcclxuICAgIHJldHVybiB7IGluZm8sIGRhdGEgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gY29udmVydFRvVW5pZm9ybVNhbXBsZSAoY2xpcDogQW5pbWF0aW9uQ2xpcCwgY3VydmU6IElQcm9wZXJ0eUN1cnZlLCBmcmFtZXM6IG51bWJlcikge1xyXG4gICAgY29uc3Qga2V5cyA9IGNsaXAua2V5c1tjdXJ2ZS5rZXlzXTtcclxuICAgIGNvbnN0IHZhbHVlczogQ3VydmVEYXRhID0gW107XHJcbiAgICBpZiAoIWtleXMgfHwga2V5cy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZyYW1lczsgaSsrKSB7XHJcbiAgICAgICAgICAgIHZhbHVlc1tpXSA9IGN1cnZlLnZhbHVlc1swXS5jbG9uZSgpOyAvLyBuZXZlciBmb3JnZXQgdG8gY2xvbmVcclxuICAgICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IGlzUXVhdCA9IGN1cnZlLnZhbHVlc1swXSBpbnN0YW5jZW9mIFF1YXQ7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGlkeCA9IDA7IGkgPCBmcmFtZXM7IGkrKykge1xyXG4gICAgICAgICAgICBsZXQgdGltZSA9IGkgLyBjbGlwLnNhbXBsZTtcclxuICAgICAgICAgICAgd2hpbGUgKGtleXNbaWR4XSA8PSB0aW1lKSB7IGlkeCsrOyB9XHJcbiAgICAgICAgICAgIGlmIChpZHggPiBrZXlzLmxlbmd0aCAtIDEpIHsgaWR4ID0ga2V5cy5sZW5ndGggLSAxOyB0aW1lID0ga2V5c1tpZHhdOyB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKGlkeCA9PT0gMCkgeyBpZHggPSAxOyB9XHJcbiAgICAgICAgICAgIGNvbnN0IGZyb20gPSBjdXJ2ZS52YWx1ZXNbaWR4IC0gMV0uY2xvbmUoKTtcclxuICAgICAgICAgICAgY29uc3QgZGVub20gPSBrZXlzW2lkeF0gLSBrZXlzW2lkeCAtIDFdO1xyXG4gICAgICAgICAgICBjb25zdCByYXRpbyA9IGRlbm9tID8gY2xhbXAwMSgodGltZSAtIGtleXNbaWR4IC0gMV0pIC8gZGVub20pIDogMTtcclxuICAgICAgICAgICAgaWYgKGlzUXVhdCkge1xyXG4gICAgICAgICAgICAgICAgKGZyb20gYXMgUXVhdCkuc2xlcnAoY3VydmUudmFsdWVzW2lkeF0gYXMgUXVhdCwgcmF0aW8pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgKGZyb20gYXMgVmVjMykubGVycChjdXJ2ZS52YWx1ZXNbaWR4XSBhcyBWZWMzLCByYXRpbyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFsdWVzW2ldID0gZnJvbTtcclxuICAgICAgIH1cclxuICAgIH1cclxuICAgIGN1cnZlLnZhbHVlcyA9IHZhbHVlcztcclxufVxyXG5cclxuZnVuY3Rpb24gY29udmVydFRvV29ybGRTcGFjZSAoY29udmVydGVkUHJvcHM6IFJlY29yZDxzdHJpbmcsIENvbnZlcnRlZFByb3BzPiwgcGF0aDogc3RyaW5nLCBwcm9wczogSU9iamVjdEN1cnZlRGF0YSkge1xyXG4gICAgY29uc3Qgb1BvcyA9IHByb3BzLnBvc2l0aW9uLnZhbHVlcztcclxuICAgIGNvbnN0IG9Sb3QgPSBwcm9wcy5yb3RhdGlvbi52YWx1ZXM7XHJcbiAgICBjb25zdCBvU2NhbGUgPSBwcm9wcy5zY2FsZS52YWx1ZXM7XHJcbiAgICBjb25zdCBtYXRyaXggPSBvUG9zLm1hcCgoKSA9PiBuZXcgTWF0NCgpKTtcclxuICAgIGNvbnN0IGlkeCA9IHBhdGgubGFzdEluZGV4T2YoJy8nKTtcclxuICAgIGxldCBwTWF0cml4OiBNYXQ0W10gfCBudWxsID0gbnVsbDtcclxuICAgIGlmIChpZHggPiAwKSB7XHJcbiAgICAgICAgY29uc3QgbmFtZSA9IHBhdGguc3Vic3RyaW5nKDAsIGlkeCk7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IGNvbnZlcnRlZFByb3BzW25hbWVdO1xyXG4gICAgICAgIGlmICghZGF0YSkgeyBjb25zb2xlLndhcm4oJ25vIGRhdGEgZm9yIHBhcmVudCBib25lPycpOyByZXR1cm47IH1cclxuICAgICAgICBwTWF0cml4ID0gZGF0YS53b3JsZE1hdHJpeC52YWx1ZXMgYXMgTWF0NFtdO1xyXG4gICAgfVxyXG4gICAgLy8gYWxsIHByb3BzIHNob3VsZCBoYXZlIHRoZSBzYW1lIGxlbmd0aCBub3dcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb1Bvcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGNvbnN0IG9UID0gb1Bvc1tpXTtcclxuICAgICAgICBjb25zdCBvUiA9IG9Sb3RbaV07XHJcbiAgICAgICAgY29uc3Qgb1MgPSBvU2NhbGVbaV07XHJcbiAgICAgICAgY29uc3QgbSA9IG1hdHJpeFtpXTtcclxuICAgICAgICBNYXQ0LmZyb21SVFMobSwgb1IsIG9ULCBvUyk7XHJcbiAgICAgICAgaWYgKHBNYXRyaXgpIHsgTWF0NC5tdWx0aXBseShtLCBwTWF0cml4W2ldLCBtKTsgfVxyXG4gICAgfVxyXG4gICAgT2JqZWN0LmtleXMocHJvcHMpLmZvckVhY2goKGspID0+IGRlbGV0ZSBwcm9wc1trXSk7XHJcbiAgICBwcm9wcy5fd29ybGRNYXRyaXggPSB7IGtleXM6IDAsIGludGVycG9sYXRlOiBmYWxzZSwgdmFsdWVzOiBtYXRyaXggfTtcclxufVxyXG4iXX0=