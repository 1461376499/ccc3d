(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../../assets/material.js", "../../geometry/index.js", "../../math/index.js", "../../pipeline/define.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../../assets/material.js"), require("../../geometry/index.js"), require("../../math/index.js"), require("../../pipeline/define.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.material, global.index, global.index, global.define);
    global.planarShadows = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _material, _index, _index2, _define) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.PlanarShadows = void 0;

  function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

  function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

  function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

  var _forward = new _index2.Vec3(0, 0, -1);

  var _v3 = new _index2.Vec3();

  var _ab = new _index.aabb();

  var _qt = new _index2.Quat();

  var PlanarShadows = /*#__PURE__*/function () {
    _createClass(PlanarShadows, [{
      key: "enabled",
      set: function set(enable) {
        this._enabled = enable;

        if (this._scene.mainLight) {
          this.updateDirLight(this._scene.mainLight);
        }
      },
      get: function get() {
        return this._enabled;
      }
    }, {
      key: "normal",
      set: function set(val) {
        _index2.Vec3.copy(this._normal, val);

        if (this._scene.mainLight) {
          this.updateDirLight(this._scene.mainLight);
        }
      },
      get: function get() {
        return this._normal;
      }
    }, {
      key: "distance",
      set: function set(val) {
        this._distance = val;

        if (this._scene.mainLight) {
          this.updateDirLight(this._scene.mainLight);
        }
      },
      get: function get() {
        return this._distance;
      }
    }, {
      key: "shadowColor",
      set: function set(color) {
        _index2.Color.toArray(this._data, color, _define.UBOShadow.SHADOW_COLOR_OFFSET);

        this._globalBindings.buffer.update(this.data);
      }
    }, {
      key: "matLight",
      get: function get() {
        return this._matLight;
      }
    }, {
      key: "data",
      get: function get() {
        return this._data;
      }
    }]);

    function PlanarShadows(scene) {
      _classCallCheck(this, PlanarShadows);

      this._scene = void 0;
      this._enabled = false;
      this._normal = new _index2.Vec3(0, 1, 0);
      this._distance = 0;
      this._matLight = new _index2.Mat4();
      this._data = Float32Array.from([1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, // matLightPlaneProj
      0.0, 0.0, 0.0, 0.3 // shadowColor
      ]);
      this._globalBindings = void 0;
      this._record = new Map();
      this._pendingModels = [];
      this._material = void 0;
      this._instancingMaterial = void 0;
      this._scene = scene;
      this._globalBindings = scene.root.pipeline.globalBindings.get(_define.UBOShadow.BLOCK.name);
      this._material = new _material.Material();

      this._material.initialize({
        effectName: 'pipeline/planar-shadow'
      });

      this._instancingMaterial = new _material.Material();

      this._instancingMaterial.initialize({
        effectName: 'pipeline/planar-shadow',
        defines: {
          USE_INSTANCING: true
        }
      });
    }

    _createClass(PlanarShadows, [{
      key: "updateSphereLight",
      value: function updateSphereLight(light) {
        light.node.getWorldPosition(_v3);
        var n = this._normal;
        var d = this._distance + 0.001; // avoid z-fighting

        var NdL = _index2.Vec3.dot(n, _v3);

        var lx = _v3.x;
        var ly = _v3.y;
        var lz = _v3.z;
        var nx = n.x;
        var ny = n.y;
        var nz = n.z;
        var m = this._matLight;
        m.m00 = NdL - d - lx * nx;
        m.m01 = -ly * nx;
        m.m02 = -lz * nx;
        m.m03 = -nx;
        m.m04 = -lx * ny;
        m.m05 = NdL - d - ly * ny;
        m.m06 = -lz * ny;
        m.m07 = -ny;
        m.m08 = -lx * nz;
        m.m09 = -ly * nz;
        m.m10 = NdL - d - lz * nz;
        m.m11 = -nz;
        m.m12 = lx * d;
        m.m13 = ly * d;
        m.m14 = lz * d;
        m.m15 = NdL;

        _index2.Mat4.toArray(this.data, this._matLight);

        this._globalBindings.buffer.update(this.data);
      }
    }, {
      key: "updateDirLight",
      value: function updateDirLight(light) {
        light.node.getWorldRotation(_qt);

        _index2.Vec3.transformQuat(_v3, _forward, _qt);

        var n = this._normal;
        var d = this._distance + 0.001; // avoid z-fighting

        var NdL = _index2.Vec3.dot(n, _v3);

        var scale = 1 / NdL;
        var lx = _v3.x * scale;
        var ly = _v3.y * scale;
        var lz = _v3.z * scale;
        var nx = n.x;
        var ny = n.y;
        var nz = n.z;
        var m = this._matLight;
        m.m00 = 1 - nx * lx;
        m.m01 = -nx * ly;
        m.m02 = -nx * lz;
        m.m03 = 0;
        m.m04 = -ny * lx;
        m.m05 = 1 - ny * ly;
        m.m06 = -ny * lz;
        m.m07 = 0;
        m.m08 = -nz * lx;
        m.m09 = -nz * ly;
        m.m10 = 1 - nz * lz;
        m.m11 = 0;
        m.m12 = lx * d;
        m.m13 = ly * d;
        m.m14 = lz * d;
        m.m15 = 1;

        _index2.Mat4.toArray(this.data, this._matLight, _define.UBOShadow.MAT_LIGHT_PLANE_PROJ_OFFSET);

        this._globalBindings.buffer.update(this.data);
      }
    }, {
      key: "updateCommandBuffers",
      value: function updateCommandBuffers(frstm, stamp) {
        this._pendingModels.length = 0;

        if (!this._scene.mainLight) {
          return;
        }

        var models = this._scene.models;

        for (var i = 0; i < models.length; i++) {
          var model = models[i];

          if (!model.enabled || !model.node || !model.castShadow) {
            continue;
          }

          if (model.worldBounds) {
            _index.aabb.transform(_ab, model.worldBounds, this._matLight);

            if (!_index.intersect.aabb_frustum(_ab, frstm)) {
              continue;
            }
          }

          var data = this._record.get(model);

          if (data && !!data.instancedBuffer !== model.isInstancingEnabled) {
            this.destroyShadowData(model);
            data = undefined;
          }

          if (!data) {
            data = this.createShadowData(model);

            this._record.set(model, data);
          }

          if (model.updateStamp !== stamp) {
            model.updateUBOs(stamp);
          } // for those outside the frustum


          this._pendingModels.push(data);
        }
      }
    }, {
      key: "recordCommandBuffer",
      value: function recordCommandBuffer(cmdBuff) {
        var models = this._pendingModels;
        var modelLen = models.length;
        var buffer = this._instancingMaterial.passes[0].instancedBuffer;

        if (buffer) {
          buffer.clear();
        }

        for (var i = 0; i < modelLen; i++) {
          var _models$i = models[i],
              model = _models$i.model,
              psos = _models$i.psos,
              instancedBuffer = _models$i.instancedBuffer;

          for (var j = 0; j < psos.length; j++) {
            var submodel = model.getSubModel(j);
            var pso = psos[j];

            if (instancedBuffer) {
              instancedBuffer.merge(submodel, model.instancedAttributes, pso);
            } else {
              var ia = submodel.inputAssembler;
              cmdBuff.bindPipelineState(pso);
              cmdBuff.bindBindingLayout(pso.pipelineLayout.layouts[0]);
              cmdBuff.bindInputAssembler(ia);
              cmdBuff.draw(ia);
            }
          }
        }

        if (buffer && buffer.pso) {
          buffer.uploadBuffers();
          cmdBuff.bindPipelineState(buffer.pso);
          cmdBuff.bindBindingLayout(buffer.pso.pipelineLayout.layouts[0]);

          for (var b = 0; b < buffer.instances.length; ++b) {
            var instance = buffer.instances[b];

            if (!instance.count) {
              continue;
            }

            cmdBuff.bindInputAssembler(instance.ia);
            cmdBuff.draw(instance.ia);
          }
        }
      }
    }, {
      key: "createShadowData",
      value: function createShadowData(model) {
        var psos = [];
        var material = model.isInstancingEnabled ? this._instancingMaterial : this._material;

        for (var i = 0; i < model.subModelNum; i++) {
          // @ts-ignore TS2445
          var pso = model.createPipelineState(material.passes[0], i);
          model.insertImplantPSO(pso); // add back to model to sync binding layouts

          pso.pipelineLayout.layouts[0].update();
          psos.push(pso);
        }

        return {
          model: model,
          psos: psos,
          instancedBuffer: material.passes[0].instancedBuffer
        };
      }
    }, {
      key: "destroyShadowData",
      value: function destroyShadowData(model) {
        var data = this._record.get(model);

        if (!data) {
          return;
        }

        var material = data.instancedBuffer ? this._instancingMaterial : this._material;

        for (var i = 0; i < data.psos.length; i++) {
          var pso = data.psos[i];
          model.removeImplantPSO(pso);
          material.passes[0].destroyPipelineState(pso);
        }

        this._record["delete"](model);
      }
    }, {
      key: "onGlobalPipelineStateChanged",
      value: function onGlobalPipelineStateChanged() {
        var it = this._record.keys();

        var res = it.next();

        while (!res.done) {
          this.destroyShadowData(res.value);
          res = it.next();
        }

        this._record.clear();
      }
    }, {
      key: "destroy",
      value: function destroy() {
        this.onGlobalPipelineStateChanged();

        this._material.destroy();
      }
    }]);

    return PlanarShadows;
  }();

  _exports.PlanarShadows = PlanarShadows;
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkY6L2plbmtpbnMvd29ya3NwYWNlL0NyZWF0b3JfM0QvZWRpdG9yLTNkL3Jlc291cmNlcy8zZC9lbmdpbmUvY29jb3MvY29yZS9yZW5kZXJlci9zY2VuZS9wbGFuYXItc2hhZG93cy50cyJdLCJuYW1lcyI6WyJfZm9yd2FyZCIsIlZlYzMiLCJfdjMiLCJfYWIiLCJhYWJiIiwiX3F0IiwiUXVhdCIsIlBsYW5hclNoYWRvd3MiLCJlbmFibGUiLCJfZW5hYmxlZCIsIl9zY2VuZSIsIm1haW5MaWdodCIsInVwZGF0ZURpckxpZ2h0IiwidmFsIiwiY29weSIsIl9ub3JtYWwiLCJfZGlzdGFuY2UiLCJjb2xvciIsIkNvbG9yIiwidG9BcnJheSIsIl9kYXRhIiwiVUJPU2hhZG93IiwiU0hBRE9XX0NPTE9SX09GRlNFVCIsIl9nbG9iYWxCaW5kaW5ncyIsImJ1ZmZlciIsInVwZGF0ZSIsImRhdGEiLCJfbWF0TGlnaHQiLCJzY2VuZSIsIk1hdDQiLCJGbG9hdDMyQXJyYXkiLCJmcm9tIiwiX3JlY29yZCIsIk1hcCIsIl9wZW5kaW5nTW9kZWxzIiwiX21hdGVyaWFsIiwiX2luc3RhbmNpbmdNYXRlcmlhbCIsInJvb3QiLCJwaXBlbGluZSIsImdsb2JhbEJpbmRpbmdzIiwiZ2V0IiwiQkxPQ0siLCJuYW1lIiwiTWF0ZXJpYWwiLCJpbml0aWFsaXplIiwiZWZmZWN0TmFtZSIsImRlZmluZXMiLCJVU0VfSU5TVEFOQ0lORyIsImxpZ2h0Iiwibm9kZSIsImdldFdvcmxkUG9zaXRpb24iLCJuIiwiZCIsIk5kTCIsImRvdCIsImx4IiwieCIsImx5IiwieSIsImx6IiwieiIsIm54IiwibnkiLCJueiIsIm0iLCJtMDAiLCJtMDEiLCJtMDIiLCJtMDMiLCJtMDQiLCJtMDUiLCJtMDYiLCJtMDciLCJtMDgiLCJtMDkiLCJtMTAiLCJtMTEiLCJtMTIiLCJtMTMiLCJtMTQiLCJtMTUiLCJnZXRXb3JsZFJvdGF0aW9uIiwidHJhbnNmb3JtUXVhdCIsInNjYWxlIiwiTUFUX0xJR0hUX1BMQU5FX1BST0pfT0ZGU0VUIiwiZnJzdG0iLCJzdGFtcCIsImxlbmd0aCIsIm1vZGVscyIsImkiLCJtb2RlbCIsImVuYWJsZWQiLCJjYXN0U2hhZG93Iiwid29ybGRCb3VuZHMiLCJ0cmFuc2Zvcm0iLCJpbnRlcnNlY3QiLCJhYWJiX2ZydXN0dW0iLCJpbnN0YW5jZWRCdWZmZXIiLCJpc0luc3RhbmNpbmdFbmFibGVkIiwiZGVzdHJveVNoYWRvd0RhdGEiLCJ1bmRlZmluZWQiLCJjcmVhdGVTaGFkb3dEYXRhIiwic2V0IiwidXBkYXRlU3RhbXAiLCJ1cGRhdGVVQk9zIiwicHVzaCIsImNtZEJ1ZmYiLCJtb2RlbExlbiIsInBhc3NlcyIsImNsZWFyIiwicHNvcyIsImoiLCJzdWJtb2RlbCIsImdldFN1Yk1vZGVsIiwicHNvIiwibWVyZ2UiLCJpbnN0YW5jZWRBdHRyaWJ1dGVzIiwiaWEiLCJpbnB1dEFzc2VtYmxlciIsImJpbmRQaXBlbGluZVN0YXRlIiwiYmluZEJpbmRpbmdMYXlvdXQiLCJwaXBlbGluZUxheW91dCIsImxheW91dHMiLCJiaW5kSW5wdXRBc3NlbWJsZXIiLCJkcmF3IiwidXBsb2FkQnVmZmVycyIsImIiLCJpbnN0YW5jZXMiLCJpbnN0YW5jZSIsImNvdW50IiwibWF0ZXJpYWwiLCJzdWJNb2RlbE51bSIsImNyZWF0ZVBpcGVsaW5lU3RhdGUiLCJpbnNlcnRJbXBsYW50UFNPIiwicmVtb3ZlSW1wbGFudFBTTyIsImRlc3Ryb3lQaXBlbGluZVN0YXRlIiwiaXQiLCJrZXlzIiwicmVzIiwibmV4dCIsImRvbmUiLCJ2YWx1ZSIsIm9uR2xvYmFsUGlwZWxpbmVTdGF0ZUNoYW5nZWQiLCJkZXN0cm95Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWFBLE1BQU1BLFFBQVEsR0FBRyxJQUFJQyxZQUFKLENBQVMsQ0FBVCxFQUFZLENBQVosRUFBZSxDQUFDLENBQWhCLENBQWpCOztBQUNBLE1BQU1DLEdBQUcsR0FBRyxJQUFJRCxZQUFKLEVBQVo7O0FBQ0EsTUFBTUUs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R0FBR0YsRUFBRSxDQUFDRyxJQUFILEVBQVY7O0FBQ2hDLGVBQU8sQ0FBQ0QsR0FBRyxDQUFDRSxJQUFaLEVBQWtCO0FBQ2QsZUFBS3pDLGlCQUFMLENBQXVCdUMsR0FBRyxDQUFDRyxLQUEzQjtBQUNBSCxVQUFBQSxHQUFHLEdBQUdGLEVBQUUsQ0FBQ0csSUFBSCxFQUFOO0FBQ0g7O0FBQ0QsYUFBSzNHLE9BQUwsQ0FBYTZFLEtBQWI7QUFDSDs7O2dDQUVpQjtBQUNkLGFBQUtpQyw0QkFBTDs7QUFDQSxhQUFLM0csU0FBTCxDQUFlNEcsT0FBZjtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IE1hdGVyaWFsIH0gZnJvbSAnLi4vLi4vYXNzZXRzL21hdGVyaWFsJztcclxuaW1wb3J0IHsgYWFiYiwgZnJ1c3R1bSwgaW50ZXJzZWN0IH0gZnJvbSAnLi4vLi4vZ2VvbWV0cnknO1xyXG5pbXBvcnQgeyBHRlhQaXBlbGluZVN0YXRlIH0gZnJvbSAnLi4vLi4vZ2Z4L3BpcGVsaW5lLXN0YXRlJztcclxuaW1wb3J0IHsgQ29sb3IsIE1hdDQsIFF1YXQsIFZlYzMgfSBmcm9tICcuLi8uLi9tYXRoJztcclxuaW1wb3J0IHsgSUludGVybmFsQmluZGluZ0luc3QsIFVCT1NoYWRvdyB9IGZyb20gJy4uLy4uL3BpcGVsaW5lL2RlZmluZSc7XHJcbmltcG9ydCB7IERpcmVjdGlvbmFsTGlnaHQgfSBmcm9tICcuL2RpcmVjdGlvbmFsLWxpZ2h0JztcclxuaW1wb3J0IHsgTW9kZWwgfSBmcm9tICcuL21vZGVsJztcclxuaW1wb3J0IHsgUmVuZGVyU2NlbmUgfSBmcm9tICcuL3JlbmRlci1zY2VuZSc7XHJcbmltcG9ydCB7IFNwaGVyZUxpZ2h0IH0gZnJvbSAnLi9zcGhlcmUtbGlnaHQnO1xyXG5pbXBvcnQgeyBHRlhDb21tYW5kQnVmZmVyIH0gZnJvbSAnLi4vLi4vZ2Z4JztcclxuaW1wb3J0IHsgSW5zdGFuY2VkQnVmZmVyIH0gZnJvbSAnLi4vLi4vcGlwZWxpbmUvaW5zdGFuY2VkLWJ1ZmZlcic7XHJcblxyXG5jb25zdCBfZm9yd2FyZCA9IG5ldyBWZWMzKDAsIDAsIC0xKTtcclxuY29uc3QgX3YzID0gbmV3IFZlYzMoKTtcclxuY29uc3QgX2FiID0gbmV3IGFhYmIoKTtcclxuY29uc3QgX3F0ID0gbmV3IFF1YXQoKTtcclxuXHJcbmludGVyZmFjZSBJU2hhZG93UmVuZGVyRGF0YSB7XHJcbiAgICBtb2RlbDogTW9kZWw7XHJcbiAgICBwc29zOiBHRlhQaXBlbGluZVN0YXRlW107XHJcbiAgICBpbnN0YW5jZWRCdWZmZXI6IEluc3RhbmNlZEJ1ZmZlciB8IG51bGw7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBQbGFuYXJTaGFkb3dzIHtcclxuXHJcbiAgICBzZXQgZW5hYmxlZCAoZW5hYmxlOiBib29sZWFuKSB7XHJcbiAgICAgICAgdGhpcy5fZW5hYmxlZCA9IGVuYWJsZTtcclxuICAgICAgICBpZiAodGhpcy5fc2NlbmUubWFpbkxpZ2h0KSB7IHRoaXMudXBkYXRlRGlyTGlnaHQodGhpcy5fc2NlbmUubWFpbkxpZ2h0KTsgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldCBlbmFibGVkICgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZW5hYmxlZDtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgbm9ybWFsICh2YWw6IFZlYzMpIHtcclxuICAgICAgICBWZWMzLmNvcHkodGhpcy5fbm9ybWFsLCB2YWwpO1xyXG4gICAgICAgIGlmICh0aGlzLl9zY2VuZS5tYWluTGlnaHQpIHsgdGhpcy51cGRhdGVEaXJMaWdodCh0aGlzLl9zY2VuZS5tYWluTGlnaHQpOyB9XHJcbiAgICB9XHJcbiAgICBnZXQgbm9ybWFsICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fbm9ybWFsO1xyXG4gICAgfVxyXG5cclxuICAgIHNldCBkaXN0YW5jZSAodmFsOiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLl9kaXN0YW5jZSA9IHZhbDtcclxuICAgICAgICBpZiAodGhpcy5fc2NlbmUubWFpbkxpZ2h0KSB7IHRoaXMudXBkYXRlRGlyTGlnaHQodGhpcy5fc2NlbmUubWFpbkxpZ2h0KTsgfVxyXG4gICAgfVxyXG4gICAgZ2V0IGRpc3RhbmNlICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZGlzdGFuY2U7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0IHNoYWRvd0NvbG9yIChjb2xvcjogQ29sb3IpIHtcclxuICAgICAgICBDb2xvci50b0FycmF5KHRoaXMuX2RhdGEsIGNvbG9yLCBVQk9TaGFkb3cuU0hBRE9XX0NPTE9SX09GRlNFVCk7XHJcbiAgICAgICAgdGhpcy5fZ2xvYmFsQmluZGluZ3MuYnVmZmVyIS51cGRhdGUodGhpcy5kYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgbWF0TGlnaHQgKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9tYXRMaWdodDtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgZGF0YSAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RhdGE7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIF9zY2VuZTogUmVuZGVyU2NlbmU7XHJcbiAgICBwcm90ZWN0ZWQgX2VuYWJsZWQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHByb3RlY3RlZCBfbm9ybWFsID0gbmV3IFZlYzMoMCwgMSwgMCk7XHJcbiAgICBwcm90ZWN0ZWQgX2Rpc3RhbmNlID0gMDtcclxuICAgIHByb3RlY3RlZCBfbWF0TGlnaHQgPSBuZXcgTWF0NCgpO1xyXG4gICAgcHJvdGVjdGVkIF9kYXRhID0gRmxvYXQzMkFycmF5LmZyb20oW1xyXG4gICAgICAgIDEsIDAsIDAsIDAsIDAsIDEsIDAsIDAsIDAsIDAsIDEsIDAsIDAsIDAsIDAsIDEsIC8vIG1hdExpZ2h0UGxhbmVQcm9qXHJcbiAgICAgICAgMC4wLCAwLjAsIDAuMCwgMC4zLCAvLyBzaGFkb3dDb2xvclxyXG4gICAgXSk7XHJcbiAgICBwcm90ZWN0ZWQgX2dsb2JhbEJpbmRpbmdzOiBJSW50ZXJuYWxCaW5kaW5nSW5zdDtcclxuICAgIHByb3RlY3RlZCBfcmVjb3JkID0gbmV3IE1hcDxNb2RlbCwgSVNoYWRvd1JlbmRlckRhdGE+KCk7XHJcbiAgICBwcm90ZWN0ZWQgX3BlbmRpbmdNb2RlbHM6IElTaGFkb3dSZW5kZXJEYXRhW10gPSBbXTtcclxuICAgIHByb3RlY3RlZCBfbWF0ZXJpYWw6IE1hdGVyaWFsO1xyXG4gICAgcHJvdGVjdGVkIF9pbnN0YW5jaW5nTWF0ZXJpYWw6IE1hdGVyaWFsO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yIChzY2VuZTogUmVuZGVyU2NlbmUpIHtcclxuICAgICAgICB0aGlzLl9zY2VuZSA9IHNjZW5lO1xyXG4gICAgICAgIHRoaXMuX2dsb2JhbEJpbmRpbmdzID0gc2NlbmUucm9vdC5waXBlbGluZS5nbG9iYWxCaW5kaW5ncy5nZXQoVUJPU2hhZG93LkJMT0NLLm5hbWUpITtcclxuICAgICAgICB0aGlzLl9tYXRlcmlhbCA9IG5ldyBNYXRlcmlhbCgpO1xyXG4gICAgICAgIHRoaXMuX21hdGVyaWFsLmluaXRpYWxpemUoeyBlZmZlY3ROYW1lOiAncGlwZWxpbmUvcGxhbmFyLXNoYWRvdycgfSk7XHJcbiAgICAgICAgdGhpcy5faW5zdGFuY2luZ01hdGVyaWFsID0gbmV3IE1hdGVyaWFsKCk7XHJcbiAgICAgICAgdGhpcy5faW5zdGFuY2luZ01hdGVyaWFsLmluaXRpYWxpemUoeyBlZmZlY3ROYW1lOiAncGlwZWxpbmUvcGxhbmFyLXNoYWRvdycsIGRlZmluZXM6IHsgVVNFX0lOU1RBTkNJTkc6IHRydWUgfSB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdXBkYXRlU3BoZXJlTGlnaHQgKGxpZ2h0OiBTcGhlcmVMaWdodCkge1xyXG4gICAgICAgIGxpZ2h0Lm5vZGUhLmdldFdvcmxkUG9zaXRpb24oX3YzKTtcclxuICAgICAgICBjb25zdCBuID0gdGhpcy5fbm9ybWFsOyBjb25zdCBkID0gdGhpcy5fZGlzdGFuY2UgKyAwLjAwMTsgLy8gYXZvaWQgei1maWdodGluZ1xyXG4gICAgICAgIGNvbnN0IE5kTCA9IFZlYzMuZG90KG4sIF92Myk7XHJcbiAgICAgICAgY29uc3QgbHggPSBfdjMueDsgY29uc3QgbHkgPSBfdjMueTsgY29uc3QgbHogPSBfdjMuejtcclxuICAgICAgICBjb25zdCBueCA9IG4ueDsgY29uc3QgbnkgPSBuLnk7IGNvbnN0IG56ID0gbi56O1xyXG4gICAgICAgIGNvbnN0IG0gPSB0aGlzLl9tYXRMaWdodDtcclxuICAgICAgICBtLm0wMCA9IE5kTCAtIGQgLSBseCAqIG54O1xyXG4gICAgICAgIG0ubTAxID0gLWx5ICogbng7XHJcbiAgICAgICAgbS5tMDIgPSAtbHogKiBueDtcclxuICAgICAgICBtLm0wMyA9IC1ueDtcclxuICAgICAgICBtLm0wNCA9IC1seCAqIG55O1xyXG4gICAgICAgIG0ubTA1ID0gTmRMIC0gZCAtIGx5ICogbnk7XHJcbiAgICAgICAgbS5tMDYgPSAtbHogKiBueTtcclxuICAgICAgICBtLm0wNyA9IC1ueTtcclxuICAgICAgICBtLm0wOCA9IC1seCAqIG56O1xyXG4gICAgICAgIG0ubTA5ID0gLWx5ICogbno7XHJcbiAgICAgICAgbS5tMTAgPSBOZEwgLSBkIC0gbHogKiBuejtcclxuICAgICAgICBtLm0xMSA9IC1uejtcclxuICAgICAgICBtLm0xMiA9IGx4ICogZDtcclxuICAgICAgICBtLm0xMyA9IGx5ICogZDtcclxuICAgICAgICBtLm0xNCA9IGx6ICogZDtcclxuICAgICAgICBtLm0xNSA9IE5kTDtcclxuICAgICAgICBNYXQ0LnRvQXJyYXkodGhpcy5kYXRhLCB0aGlzLl9tYXRMaWdodCk7XHJcbiAgICAgICAgdGhpcy5fZ2xvYmFsQmluZGluZ3MuYnVmZmVyIS51cGRhdGUodGhpcy5kYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdXBkYXRlRGlyTGlnaHQgKGxpZ2h0OiBEaXJlY3Rpb25hbExpZ2h0KSB7XHJcbiAgICAgICAgbGlnaHQubm9kZSEuZ2V0V29ybGRSb3RhdGlvbihfcXQpO1xyXG4gICAgICAgIFZlYzMudHJhbnNmb3JtUXVhdChfdjMsIF9mb3J3YXJkLCBfcXQpO1xyXG4gICAgICAgIGNvbnN0IG4gPSB0aGlzLl9ub3JtYWw7IGNvbnN0IGQgPSB0aGlzLl9kaXN0YW5jZSArIDAuMDAxOyAvLyBhdm9pZCB6LWZpZ2h0aW5nXHJcbiAgICAgICAgY29uc3QgTmRMID0gVmVjMy5kb3QobiwgX3YzKTsgY29uc3Qgc2NhbGUgPSAxIC8gTmRMO1xyXG4gICAgICAgIGNvbnN0IGx4ID0gX3YzLnggKiBzY2FsZTsgY29uc3QgbHkgPSBfdjMueSAqIHNjYWxlOyBjb25zdCBseiA9IF92My56ICogc2NhbGU7XHJcbiAgICAgICAgY29uc3QgbnggPSBuLng7IGNvbnN0IG55ID0gbi55OyBjb25zdCBueiA9IG4uejtcclxuICAgICAgICBjb25zdCBtID0gdGhpcy5fbWF0TGlnaHQ7XHJcbiAgICAgICAgbS5tMDAgPSAxIC0gbnggKiBseDtcclxuICAgICAgICBtLm0wMSA9IC1ueCAqIGx5O1xyXG4gICAgICAgIG0ubTAyID0gLW54ICogbHo7XHJcbiAgICAgICAgbS5tMDMgPSAwO1xyXG4gICAgICAgIG0ubTA0ID0gLW55ICogbHg7XHJcbiAgICAgICAgbS5tMDUgPSAxIC0gbnkgKiBseTtcclxuICAgICAgICBtLm0wNiA9IC1ueSAqIGx6O1xyXG4gICAgICAgIG0ubTA3ID0gMDtcclxuICAgICAgICBtLm0wOCA9IC1ueiAqIGx4O1xyXG4gICAgICAgIG0ubTA5ID0gLW56ICogbHk7XHJcbiAgICAgICAgbS5tMTAgPSAxIC0gbnogKiBsejtcclxuICAgICAgICBtLm0xMSA9IDA7XHJcbiAgICAgICAgbS5tMTIgPSBseCAqIGQ7XHJcbiAgICAgICAgbS5tMTMgPSBseSAqIGQ7XHJcbiAgICAgICAgbS5tMTQgPSBseiAqIGQ7XHJcbiAgICAgICAgbS5tMTUgPSAxO1xyXG4gICAgICAgIE1hdDQudG9BcnJheSh0aGlzLmRhdGEsIHRoaXMuX21hdExpZ2h0LCBVQk9TaGFkb3cuTUFUX0xJR0hUX1BMQU5FX1BST0pfT0ZGU0VUKTtcclxuICAgICAgICB0aGlzLl9nbG9iYWxCaW5kaW5ncy5idWZmZXIhLnVwZGF0ZSh0aGlzLmRhdGEpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyB1cGRhdGVDb21tYW5kQnVmZmVycyAoZnJzdG06IGZydXN0dW0sIHN0YW1wOiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLl9wZW5kaW5nTW9kZWxzLmxlbmd0aCA9IDA7XHJcbiAgICAgICAgaWYgKCF0aGlzLl9zY2VuZS5tYWluTGlnaHQpIHsgcmV0dXJuOyB9XHJcbiAgICAgICAgY29uc3QgbW9kZWxzID0gdGhpcy5fc2NlbmUubW9kZWxzO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbW9kZWxzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1vZGVsID0gbW9kZWxzW2ldO1xyXG4gICAgICAgICAgICBpZiAoIW1vZGVsLmVuYWJsZWQgfHwgIW1vZGVsLm5vZGUgfHwgIW1vZGVsLmNhc3RTaGFkb3cpIHsgY29udGludWU7IH1cclxuICAgICAgICAgICAgaWYgKG1vZGVsLndvcmxkQm91bmRzKSB7XHJcbiAgICAgICAgICAgICAgICBhYWJiLnRyYW5zZm9ybShfYWIsIG1vZGVsLndvcmxkQm91bmRzLCB0aGlzLl9tYXRMaWdodCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWludGVyc2VjdC5hYWJiX2ZydXN0dW0oX2FiLCBmcnN0bSkpIHsgY29udGludWU7IH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgZGF0YSA9IHRoaXMuX3JlY29yZC5nZXQobW9kZWwpO1xyXG4gICAgICAgICAgICBpZiAoZGF0YSAmJiAoISFkYXRhLmluc3RhbmNlZEJ1ZmZlciAhPT0gbW9kZWwuaXNJbnN0YW5jaW5nRW5hYmxlZCkpIHsgdGhpcy5kZXN0cm95U2hhZG93RGF0YShtb2RlbCk7IGRhdGEgPSB1bmRlZmluZWQ7IH1cclxuICAgICAgICAgICAgaWYgKCFkYXRhKSB7IGRhdGEgPSB0aGlzLmNyZWF0ZVNoYWRvd0RhdGEobW9kZWwpOyB0aGlzLl9yZWNvcmQuc2V0KG1vZGVsLCBkYXRhKTsgfVxyXG4gICAgICAgICAgICBpZiAobW9kZWwudXBkYXRlU3RhbXAgIT09IHN0YW1wKSB7IG1vZGVsLnVwZGF0ZVVCT3Moc3RhbXApOyB9IC8vIGZvciB0aG9zZSBvdXRzaWRlIHRoZSBmcnVzdHVtXHJcbiAgICAgICAgICAgIHRoaXMuX3BlbmRpbmdNb2RlbHMucHVzaChkYXRhKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHJlY29yZENvbW1hbmRCdWZmZXIgKGNtZEJ1ZmY6IEdGWENvbW1hbmRCdWZmZXIpIHtcclxuICAgICAgICBjb25zdCBtb2RlbHMgPSB0aGlzLl9wZW5kaW5nTW9kZWxzO1xyXG4gICAgICAgIGNvbnN0IG1vZGVsTGVuID0gbW9kZWxzLmxlbmd0aDtcclxuICAgICAgICBjb25zdCBidWZmZXIgPSB0aGlzLl9pbnN0YW5jaW5nTWF0ZXJpYWwucGFzc2VzWzBdLmluc3RhbmNlZEJ1ZmZlcjtcclxuICAgICAgICBpZiAoYnVmZmVyKSB7IGJ1ZmZlci5jbGVhcigpOyB9XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtb2RlbExlbjsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgbW9kZWwsIHBzb3MsIGluc3RhbmNlZEJ1ZmZlciB9ID0gbW9kZWxzW2ldO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHBzb3MubGVuZ3RoOyBqKyspIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHN1Ym1vZGVsID0gbW9kZWwuZ2V0U3ViTW9kZWwoaik7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwc28gPSBwc29zW2pdO1xyXG4gICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlZEJ1ZmZlcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGluc3RhbmNlZEJ1ZmZlci5tZXJnZShzdWJtb2RlbCwgbW9kZWwuaW5zdGFuY2VkQXR0cmlidXRlcywgcHNvKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaWEgPSBzdWJtb2RlbC5pbnB1dEFzc2VtYmxlciE7XHJcbiAgICAgICAgICAgICAgICAgICAgY21kQnVmZi5iaW5kUGlwZWxpbmVTdGF0ZShwc28pO1xyXG4gICAgICAgICAgICAgICAgICAgIGNtZEJ1ZmYuYmluZEJpbmRpbmdMYXlvdXQocHNvLnBpcGVsaW5lTGF5b3V0LmxheW91dHNbMF0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGNtZEJ1ZmYuYmluZElucHV0QXNzZW1ibGVyKGlhKTtcclxuICAgICAgICAgICAgICAgICAgICBjbWRCdWZmLmRyYXcoaWEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChidWZmZXIgJiYgYnVmZmVyLnBzbykge1xyXG4gICAgICAgICAgICBidWZmZXIudXBsb2FkQnVmZmVycygpO1xyXG4gICAgICAgICAgICBjbWRCdWZmLmJpbmRQaXBlbGluZVN0YXRlKGJ1ZmZlci5wc28hKTtcclxuICAgICAgICAgICAgY21kQnVmZi5iaW5kQmluZGluZ0xheW91dChidWZmZXIucHNvIS5waXBlbGluZUxheW91dC5sYXlvdXRzWzBdKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgYiA9IDA7IGIgPCBidWZmZXIuaW5zdGFuY2VzLmxlbmd0aDsgKytiKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGJ1ZmZlci5pbnN0YW5jZXNbYl07XHJcbiAgICAgICAgICAgICAgICBpZiAoIWluc3RhbmNlLmNvdW50KSB7IGNvbnRpbnVlOyB9XHJcbiAgICAgICAgICAgICAgICBjbWRCdWZmLmJpbmRJbnB1dEFzc2VtYmxlcihpbnN0YW5jZS5pYSk7XHJcbiAgICAgICAgICAgICAgICBjbWRCdWZmLmRyYXcoaW5zdGFuY2UuaWEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjcmVhdGVTaGFkb3dEYXRhIChtb2RlbDogTW9kZWwpOiBJU2hhZG93UmVuZGVyRGF0YSB7XHJcbiAgICAgICAgY29uc3QgcHNvczogR0ZYUGlwZWxpbmVTdGF0ZVtdID0gW107XHJcbiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBtb2RlbC5pc0luc3RhbmNpbmdFbmFibGVkID8gdGhpcy5faW5zdGFuY2luZ01hdGVyaWFsIDogdGhpcy5fbWF0ZXJpYWw7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtb2RlbC5zdWJNb2RlbE51bTsgaSsrKSB7XHJcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmUgVFMyNDQ1XHJcbiAgICAgICAgICAgIGNvbnN0IHBzbyA9IG1vZGVsLmNyZWF0ZVBpcGVsaW5lU3RhdGUobWF0ZXJpYWwucGFzc2VzWzBdLCBpKTtcclxuICAgICAgICAgICAgbW9kZWwuaW5zZXJ0SW1wbGFudFBTTyhwc28pOyAvLyBhZGQgYmFjayB0byBtb2RlbCB0byBzeW5jIGJpbmRpbmcgbGF5b3V0c1xyXG4gICAgICAgICAgICBwc28ucGlwZWxpbmVMYXlvdXQubGF5b3V0c1swXS51cGRhdGUoKTsgcHNvcy5wdXNoKHBzbyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB7IG1vZGVsLCBwc29zLCBpbnN0YW5jZWRCdWZmZXI6IG1hdGVyaWFsLnBhc3Nlc1swXS5pbnN0YW5jZWRCdWZmZXIgfTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZGVzdHJveVNoYWRvd0RhdGEgKG1vZGVsOiBNb2RlbCkge1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLl9yZWNvcmQuZ2V0KG1vZGVsKTtcclxuICAgICAgICBpZiAoIWRhdGEpIHsgcmV0dXJuOyB9XHJcbiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBkYXRhLmluc3RhbmNlZEJ1ZmZlciA/IHRoaXMuX2luc3RhbmNpbmdNYXRlcmlhbCA6IHRoaXMuX21hdGVyaWFsO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5wc29zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBzbyA9IGRhdGEucHNvc1tpXTtcclxuICAgICAgICAgICAgbW9kZWwucmVtb3ZlSW1wbGFudFBTTyhwc28pO1xyXG4gICAgICAgICAgICBtYXRlcmlhbC5wYXNzZXNbMF0uZGVzdHJveVBpcGVsaW5lU3RhdGUocHNvKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fcmVjb3JkLmRlbGV0ZShtb2RlbCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIG9uR2xvYmFsUGlwZWxpbmVTdGF0ZUNoYW5nZWQgKCkge1xyXG4gICAgICAgIGNvbnN0IGl0ID0gdGhpcy5fcmVjb3JkLmtleXMoKTsgbGV0IHJlcyA9IGl0Lm5leHQoKTtcclxuICAgICAgICB3aGlsZSAoIXJlcy5kb25lKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGVzdHJveVNoYWRvd0RhdGEocmVzLnZhbHVlKTtcclxuICAgICAgICAgICAgcmVzID0gaXQubmV4dCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl9yZWNvcmQuY2xlYXIoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZGVzdHJveSAoKSB7XHJcbiAgICAgICAgdGhpcy5vbkdsb2JhbFBpcGVsaW5lU3RhdGVDaGFuZ2VkKCk7XHJcbiAgICAgICAgdGhpcy5fbWF0ZXJpYWwuZGVzdHJveSgpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==