(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../../core/math/index.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../../core/math/index.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.index);
    global.utils = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _index) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.fillVertices3D = fillVertices3D;
  _exports.fillMeshVertices3D = fillMeshVertices3D;
  _exports.fillVerticesWithoutCalc3D = fillVerticesWithoutCalc3D;

  /**
   * @hidden
   */
  var vec3_temp = new _index.Vec3();

  var _worldMatrix = new _index.Mat4();

  function fillVertices3D(node, renderer, renderData, color) {
    var datas = renderData.datas;
    var buffer = renderer.currBufferBatch;
    var vertexOffset = buffer.byteOffset >> 2;
    var vertexCount = renderData.vertexCount;
    var indiceOffset = buffer.indiceOffset;
    var vertexId = buffer.vertexOffset;
    var isRecreate = buffer.request(vertexCount, renderData.indiceCount);

    if (!isRecreate) {
      buffer = renderer.currBufferBatch;
      vertexCount = 0;
      indiceOffset = 0;
      vertexId = 0;
    } // buffer data may be realloc, need get reference after request.


    var vbuf = buffer.vData;
    node.getWorldMatrix(_worldMatrix);

    for (var i = 0; i < vertexCount; i++) {
      var vert = datas[i];

      _index.Vec3.set(vec3_temp, vert.x, vert.y, 0);

      _index.Vec3.transformMat4(vec3_temp, vec3_temp, _worldMatrix);

      vbuf[vertexOffset++] = vec3_temp.x;
      vbuf[vertexOffset++] = vec3_temp.y;
      vbuf[vertexOffset++] = vec3_temp.z;
      vbuf[vertexOffset++] = vert.u;
      vbuf[vertexOffset++] = vert.v;

      _index.Color.toArray(vbuf, color, vertexOffset);

      vertexOffset += 4;
    } // buffer data may be realloc, need get reference after request.


    var ibuf = buffer.iData;

    for (var _i = 0; _i < renderData.dataLength; _i++) {
      ibuf[indiceOffset + _i] = vertexId + _i;
    }
  }

  function fillMeshVertices3D(node, renderer, renderData, color) {
    var datas = renderData.datas;
    var buffer = renderer.currBufferBatch;
    var vertexOffset = buffer.byteOffset >> 2;
    var vertexCount = renderData.vertexCount;
    var indiceOffset = buffer.indiceOffset;
    var vertexId = buffer.vertexOffset;
    var isRecreate = buffer.request(vertexCount, renderData.indiceCount);

    if (!isRecreate) {
      buffer = renderer.currBufferBatch;
      vertexCount = 0;
      indiceOffset = 0;
      vertexId = 0;
    } // buffer data may be realloc, need get reference after request.


    var vbuf = buffer.vData;
    var ibuf = buffer.iData;
    node.getWorldMatrix(_worldMatrix);

    for (var i = 0; i < vertexCount; i++) {
      var vert = datas[i];

      _index.Vec3.set(vec3_temp, vert.x, vert.y, 0);

      _index.Vec3.transformMat4(vec3_temp, vec3_temp, _worldMatrix);

      vbuf[vertexOffset++] = vec3_temp.x;
      vbuf[vertexOffset++] = vec3_temp.y;
      vbuf[vertexOffset++] = vec3_temp.z;
      vbuf[vertexOffset++] = vert.u;
      vbuf[vertexOffset++] = vert.v;

      _index.Color.toArray(vbuf, color, vertexOffset);

      vertexOffset += 4;
    } // fill index data


    for (var _i2 = 0, count = vertexCount / 4; _i2 < count; _i2++) {
      var start = vertexId + _i2 * 4;
      ibuf[indiceOffset++] = start;
      ibuf[indiceOffset++] = start + 1;
      ibuf[indiceOffset++] = start + 2;
      ibuf[indiceOffset++] = start + 1;
      ibuf[indiceOffset++] = start + 3;
      ibuf[indiceOffset++] = start + 2;
    }
  }

  function fillVerticesWithoutCalc3D(node, renderer, renderData, color) {
    var datas = renderData.datas;
    var buffer = renderer.currBufferBatch;
    var vertexOffset = buffer.byteOffset >> 2; // buffer

    var vertexCount = renderData.vertexCount;
    var indiceOffset = buffer.indiceOffset;
    var vertexId = buffer.vertexOffset;
    var isRecreate = buffer.request(vertexCount, renderData.indiceCount);

    if (!isRecreate) {
      buffer = renderer.currBufferBatch;
      vertexCount = 0;
      indiceOffset = 0;
      vertexId = 0;
    } // buffer data may be realloc, need get reference after request.


    var vbuf = buffer.vData;

    for (var i = 0; i < vertexCount; i++) {
      var vert = datas[i];
      vbuf[vertexOffset++] = vert.x;
      vbuf[vertexOffset++] = vert.y;
      vbuf[vertexOffset++] = vert.z;
      vbuf[vertexOffset++] = vert.u;
      vbuf[vertexOffset++] = vert.v;

      _index.Color.toArray(vbuf, color, vertexOffset);

      vertexOffset += 4;
    } // buffer data may be realloc, need get reference after request.


    var ibuf = buffer.iData;
    ibuf[indiceOffset++] = vertexId;
    ibuf[indiceOffset++] = vertexId + 1;
    ibuf[indiceOffset++] = vertexId + 2;
    ibuf[indiceOffset++] = vertexId + 1;
    ibuf[indiceOffset++] = vertexId + 3;
    ibuf[indiceOffset++] = vertexId + 2;
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkY6L2plbmtpbnMvd29ya3NwYWNlL0NyZWF0b3JfM0QvZWRpdG9yLTNkL3Jlc291cmNlcy8zZC9lbmdpbmUvY29jb3MvdWkvYXNzZW1ibGVyL3V0aWxzLnRzIl0sIm5hbWVzIjpbInZlYzNfdGVtcCIsIlZlYzMiLCJfd29ybGRNYXRyaXgiLCJNYXQ0IiwiZmlsbFZlcnRpY2VzM0QiLCJub2RlIiwicmVuZGVyZXIiLCJyZW5kZXJEYXRhIiwiY29sb3IiLCJkYXRhcyIsImJ1ZmZlciIsImN1cnJCdWZmZXJCYXRjaCIsInZlcnRleE9mZnNldCIsImJ5dGVPZmZzZXQiLCJ2ZXJ0ZXhDb3VudCIsImluZGljZU9mZnNldCIsInZlcnRleElkIiwiaXNSZWNyZWF0ZSIsInJlcXVlc3QiLCJpbmRpY2VDb3VudCIsInZidWYiLCJ2RGF0YSIsImdldFdvcmxkTWF0cml4IiwiaSIsInZlcnQiLCJzZXQiLCJ4IiwieSIsInRyYW5zZm9ybU1hdDQiLCJ6IiwidSIsInYiLCJDb2xvciIsInRvQXJyYXkiLCJpYnVmIiwiaURhdGEiLCJkYXRhTGVuZ3RoIiwiZmlsbE1lc2hWZXJ0aWNlczNEIiwiY291bnQiLCJzdGFydCIsImZpbGxWZXJ0aWNlc1dpdGhvdXRDYWxjM0QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7O0FBU0EsTUFBTUEsU0FBUyxHQUFHLElBQUlDLFdBQUosRUFBbEI7O0FBQ0EsTUFBTUMsWUFBWSxHQUFHLElBQUlDLFdBQUosRUFBckI7O0FBRU8sV0FBU0MsY0FBVCxDQUF5QkMsSUFBekIsRUFBcUNDLFFBQXJDLEVBQW1EQyxVQUFuRCxFQUEyRUMsS0FBM0UsRUFBeUY7QUFDNUYsUUFBTUMsS0FBSyxHQUFHRixVQUFVLENBQUNFLEtBQXpCO0FBQ0EsUUFBSUMsTUFBTSxHQUFHSixRQUFRLENBQUNLLGVBQXRCO0FBQ0EsUUFBSUMsWUFBWSxHQUFHRixNQUFNLENBQUNHLFVBQVAsSUFBcUIsQ0FBeEM7QUFFQSxRQUFJQyxXQUFXLEdB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RCxJQUFBQSxJQUFJLENBQUVuQixZQUFZLEVBQWQsQ0FBSixHQUF3QkMsUUFBeEI7QUFDQWtCLElBQUFBLElBQUksQ0FBRW5CLFlBQVksRUFBZCxDQUFKLEdBQXdCQyxRQUFRLEdBQUcsQ0FBbkM7QUFDQWtCLElBQUFBLElBQUksQ0FBRW5CLFlBQVksRUFBZCxDQUFKLEdBQXdCQyxRQUFRLEdBQUcsQ0FBbkM7QUFDQWtCLElBQUFBLElBQUksQ0FBRW5CLFlBQVksRUFBZCxDQUFKLEdBQXdCQyxRQUFRLEdBQUcsQ0FBbkM7QUFDQWtCLElBQUFBLElBQUksQ0FBRW5CLFlBQVksRUFBZCxDQUFKLEdBQXdCQyxRQUFRLEdBQUcsQ0FBbkM7QUFDQWtCLElBQUFBLElBQUksQ0FBRW5CLFlBQVksRUFBZCxDQUFKLEdBQXdCQyxRQUFRLEdBQUcsQ0FBbkM7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBAaGlkZGVuXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgQ29sb3IsIE1hdDQsIFZlYzMgfSBmcm9tICcuLi8uLi9jb3JlL21hdGgnO1xyXG5pbXBvcnQgeyBSZW5kZXJEYXRhIH0gZnJvbSAnLi4vLi4vY29yZS9yZW5kZXJlci91aS9yZW5kZXItZGF0YSc7XHJcbmltcG9ydCB7IFVJIH0gZnJvbSAnLi4vLi4vY29yZS9yZW5kZXJlci91aS91aSc7XHJcbmltcG9ydCB7IE5vZGUgfSBmcm9tICcuLi8uLi9jb3JlJztcclxuXHJcbmNvbnN0IHZlYzNfdGVtcCA9IG5ldyBWZWMzKCk7XHJcbmNvbnN0IF93b3JsZE1hdHJpeCA9IG5ldyBNYXQ0KCk7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmlsbFZlcnRpY2VzM0QgKG5vZGU6IE5vZGUsIHJlbmRlcmVyOiBVSSwgcmVuZGVyRGF0YTogUmVuZGVyRGF0YSwgY29sb3I6IENvbG9yKSB7XHJcbiAgICBjb25zdCBkYXRhcyA9IHJlbmRlckRhdGEuZGF0YXM7XHJcbiAgICBsZXQgYnVmZmVyID0gcmVuZGVyZXIuY3VyckJ1ZmZlckJhdGNoITtcclxuICAgIGxldCB2ZXJ0ZXhPZmZzZXQgPSBidWZmZXIuYnl0ZU9mZnNldCA+PiAyO1xyXG5cclxuICAgIGxldCB2ZXJ0ZXhDb3VudCA9IHJlbmRlckRhdGEudmVydGV4Q291bnQ7XHJcbiAgICBsZXQgaW5kaWNlT2Zmc2V0ID0gYnVmZmVyIS5pbmRpY2VPZmZzZXQ7XHJcbiAgICBsZXQgdmVydGV4SWQgPSBidWZmZXIudmVydGV4T2Zmc2V0O1xyXG4gICAgY29uc3QgaXNSZWNyZWF0ZSA9IGJ1ZmZlci5yZXF1ZXN0KHZlcnRleENvdW50LCByZW5kZXJEYXRhLmluZGljZUNvdW50KTtcclxuICAgIGlmICghaXNSZWNyZWF0ZSkge1xyXG4gICAgICAgIGJ1ZmZlciA9IHJlbmRlcmVyLmN1cnJCdWZmZXJCYXRjaCE7XHJcbiAgICAgICAgdmVydGV4Q291bnQgPSAwO1xyXG4gICAgICAgIGluZGljZU9mZnNldCA9IDA7XHJcbiAgICAgICAgdmVydGV4SWQgPSAwO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGJ1ZmZlciBkYXRhIG1heSBiZSByZWFsbG9jLCBuZWVkIGdldCByZWZlcmVuY2UgYWZ0ZXIgcmVxdWVzdC5cclxuICAgIGNvbnN0IHZidWYgPSBidWZmZXIudkRhdGEhO1xyXG5cclxuICAgIG5vZGUuZ2V0V29ybGRNYXRyaXgoX3dvcmxkTWF0cml4KTtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleENvdW50OyBpKyspIHtcclxuICAgICAgICBjb25zdCB2ZXJ0ID0gZGF0YXNbaV07XHJcbiAgICAgICAgVmVjMy5zZXQodmVjM190ZW1wLCB2ZXJ0LngsIHZlcnQueSwgMCk7XHJcbiAgICAgICAgVmVjMy50cmFuc2Zvcm1NYXQ0KHZlYzNfdGVtcCwgdmVjM190ZW1wLCBfd29ybGRNYXRyaXgpO1xyXG4gICAgICAgIHZidWZbdmVydGV4T2Zmc2V0KytdID0gdmVjM190ZW1wLng7XHJcbiAgICAgICAgdmJ1Zlt2ZXJ0ZXhPZmZzZXQrK10gPSB2ZWMzX3RlbXAueTtcclxuICAgICAgICB2YnVmW3ZlcnRleE9mZnNldCsrXSA9IHZlYzNfdGVtcC56O1xyXG4gICAgICAgIHZidWZbdmVydGV4T2Zmc2V0KytdID0gdmVydC51O1xyXG4gICAgICAgIHZidWZbdmVydGV4T2Zmc2V0KytdID0gdmVydC52O1xyXG4gICAgICAgIENvbG9yLnRvQXJyYXkodmJ1ZiEsIGNvbG9yLCB2ZXJ0ZXhPZmZzZXQpO1xyXG4gICAgICAgIHZlcnRleE9mZnNldCArPSA0O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGJ1ZmZlciBkYXRhIG1heSBiZSByZWFsbG9jLCBuZWVkIGdldCByZWZlcmVuY2UgYWZ0ZXIgcmVxdWVzdC5cclxuICAgIGNvbnN0IGlidWYgPSBidWZmZXIuaURhdGE7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlbmRlckRhdGEhLmRhdGFMZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGlidWYhW2luZGljZU9mZnNldCArIGldID0gdmVydGV4SWQgKyBpO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmlsbE1lc2hWZXJ0aWNlczNEIChub2RlOiBOb2RlLCByZW5kZXJlcjogVUksIHJlbmRlckRhdGE6IFJlbmRlckRhdGEsIGNvbG9yOiBDb2xvcikge1xyXG4gICAgY29uc3QgZGF0YXMgPSByZW5kZXJEYXRhLmRhdGFzO1xyXG4gICAgbGV0IGJ1ZmZlciA9IHJlbmRlcmVyLmN1cnJCdWZmZXJCYXRjaCE7XHJcbiAgICBsZXQgdmVydGV4T2Zmc2V0ID0gYnVmZmVyLmJ5dGVPZmZzZXQgPj4gMjtcclxuXHJcbiAgICBsZXQgdmVydGV4Q291bnQgPSByZW5kZXJEYXRhLnZlcnRleENvdW50O1xyXG4gICAgbGV0IGluZGljZU9mZnNldCA9IGJ1ZmZlci5pbmRpY2VPZmZzZXQ7XHJcbiAgICBsZXQgdmVydGV4SWQgPSBidWZmZXIudmVydGV4T2Zmc2V0O1xyXG5cclxuICAgIGNvbnN0IGlzUmVjcmVhdGUgPSBidWZmZXIucmVxdWVzdCh2ZXJ0ZXhDb3VudCwgcmVuZGVyRGF0YS5pbmRpY2VDb3VudCk7XHJcbiAgICBpZiAoIWlzUmVjcmVhdGUpIHtcclxuICAgICAgICBidWZmZXIgPSByZW5kZXJlci5jdXJyQnVmZmVyQmF0Y2ghO1xyXG4gICAgICAgIHZlcnRleENvdW50ID0gMDtcclxuICAgICAgICBpbmRpY2VPZmZzZXQgPSAwO1xyXG4gICAgICAgIHZlcnRleElkID0gMDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBidWZmZXIgZGF0YSBtYXkgYmUgcmVhbGxvYywgbmVlZCBnZXQgcmVmZXJlbmNlIGFmdGVyIHJlcXVlc3QuXHJcbiAgICBjb25zdCB2YnVmID0gYnVmZmVyLnZEYXRhITtcclxuICAgIGNvbnN0IGlidWYgPSBidWZmZXIuaURhdGEhO1xyXG5cclxuICAgIG5vZGUuZ2V0V29ybGRNYXRyaXgoX3dvcmxkTWF0cml4KTtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleENvdW50OyBpKyspIHtcclxuICAgICAgICBjb25zdCB2ZXJ0ID0gZGF0YXNbaV07XHJcbiAgICAgICAgVmVjMy5zZXQodmVjM190ZW1wLCB2ZXJ0LngsIHZlcnQueSwgMCk7XHJcbiAgICAgICAgVmVjMy50cmFuc2Zvcm1NYXQ0KHZlYzNfdGVtcCwgdmVjM190ZW1wLCBfd29ybGRNYXRyaXgpO1xyXG4gICAgICAgIHZidWZbdmVydGV4T2Zmc2V0KytdID0gdmVjM190ZW1wLng7XHJcbiAgICAgICAgdmJ1Zlt2ZXJ0ZXhPZmZzZXQrK10gPSB2ZWMzX3RlbXAueTtcclxuICAgICAgICB2YnVmW3ZlcnRleE9mZnNldCsrXSA9IHZlYzNfdGVtcC56O1xyXG4gICAgICAgIHZidWZbdmVydGV4T2Zmc2V0KytdID0gdmVydC51O1xyXG4gICAgICAgIHZidWZbdmVydGV4T2Zmc2V0KytdID0gdmVydC52O1xyXG4gICAgICAgIENvbG9yLnRvQXJyYXkodmJ1ZiEsIGNvbG9yLCB2ZXJ0ZXhPZmZzZXQpO1xyXG4gICAgICAgIHZlcnRleE9mZnNldCArPSA0O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGZpbGwgaW5kZXggZGF0YVxyXG4gICAgZm9yIChsZXQgaSA9IDAsIGNvdW50ID0gdmVydGV4Q291bnQgLyA0OyBpIDwgY291bnQ7IGkrKykge1xyXG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gdmVydGV4SWQgKyBpICogNDtcclxuICAgICAgICBpYnVmW2luZGljZU9mZnNldCsrXSA9IHN0YXJ0O1xyXG4gICAgICAgIGlidWZbaW5kaWNlT2Zmc2V0KytdID0gc3RhcnQgKyAxO1xyXG4gICAgICAgIGlidWZbaW5kaWNlT2Zmc2V0KytdID0gc3RhcnQgKyAyO1xyXG4gICAgICAgIGlidWZbaW5kaWNlT2Zmc2V0KytdID0gc3RhcnQgKyAxO1xyXG4gICAgICAgIGlidWZbaW5kaWNlT2Zmc2V0KytdID0gc3RhcnQgKyAzO1xyXG4gICAgICAgIGlidWZbaW5kaWNlT2Zmc2V0KytdID0gc3RhcnQgKyAyO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmlsbFZlcnRpY2VzV2l0aG91dENhbGMzRCAobm9kZTogTm9kZSwgcmVuZGVyZXI6IFVJLCByZW5kZXJEYXRhOiBSZW5kZXJEYXRhLCBjb2xvcjogQ29sb3IpIHtcclxuICAgIGNvbnN0IGRhdGFzID0gcmVuZGVyRGF0YS5kYXRhcztcclxuICAgIGxldCBidWZmZXIgPSByZW5kZXJlci5jdXJyQnVmZmVyQmF0Y2ghO1xyXG4gICAgbGV0IHZlcnRleE9mZnNldCA9IGJ1ZmZlci5ieXRlT2Zmc2V0ID4+IDI7XHJcblxyXG4gICAgLy8gYnVmZmVyXHJcbiAgICBsZXQgdmVydGV4Q291bnQgPSByZW5kZXJEYXRhLnZlcnRleENvdW50O1xyXG4gICAgbGV0IGluZGljZU9mZnNldDogbnVtYmVyID0gYnVmZmVyLmluZGljZU9mZnNldDtcclxuICAgIGxldCB2ZXJ0ZXhJZDogbnVtYmVyID0gYnVmZmVyLnZlcnRleE9mZnNldDtcclxuICAgIGNvbnN0IGlzUmVjcmVhdGUgPSBidWZmZXIucmVxdWVzdCh2ZXJ0ZXhDb3VudCwgcmVuZGVyRGF0YS5pbmRpY2VDb3VudCk7XHJcbiAgICBpZiAoIWlzUmVjcmVhdGUpIHtcclxuICAgICAgICBidWZmZXIgPSByZW5kZXJlci5jdXJyQnVmZmVyQmF0Y2ghO1xyXG4gICAgICAgIHZlcnRleENvdW50ID0gMDtcclxuICAgICAgICBpbmRpY2VPZmZzZXQgPSAwO1xyXG4gICAgICAgIHZlcnRleElkID0gMDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBidWZmZXIgZGF0YSBtYXkgYmUgcmVhbGxvYywgbmVlZCBnZXQgcmVmZXJlbmNlIGFmdGVyIHJlcXVlc3QuXHJcbiAgICBjb25zdCB2YnVmID0gYnVmZmVyLnZEYXRhITtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleENvdW50OyBpKyspIHtcclxuICAgICAgICBjb25zdCB2ZXJ0ID0gZGF0YXNbaV07XHJcbiAgICAgICAgdmJ1Zlt2ZXJ0ZXhPZmZzZXQrK10gPSB2ZXJ0Lng7XHJcbiAgICAgICAgdmJ1Zlt2ZXJ0ZXhPZmZzZXQrK10gPSB2ZXJ0Lnk7XHJcbiAgICAgICAgdmJ1Zlt2ZXJ0ZXhPZmZzZXQrK10gPSB2ZXJ0Lno7XHJcbiAgICAgICAgdmJ1Zlt2ZXJ0ZXhPZmZzZXQrK10gPSB2ZXJ0LnU7XHJcbiAgICAgICAgdmJ1Zlt2ZXJ0ZXhPZmZzZXQrK10gPSB2ZXJ0LnY7XHJcbiAgICAgICAgQ29sb3IudG9BcnJheSh2YnVmISwgY29sb3IsIHZlcnRleE9mZnNldCk7XHJcbiAgICAgICAgdmVydGV4T2Zmc2V0ICs9IDQ7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gYnVmZmVyIGRhdGEgbWF5IGJlIHJlYWxsb2MsIG5lZWQgZ2V0IHJlZmVyZW5jZSBhZnRlciByZXF1ZXN0LlxyXG4gICAgY29uc3QgaWJ1ZiA9IGJ1ZmZlci5pRGF0YTtcclxuICAgIGlidWYhW2luZGljZU9mZnNldCsrXSA9IHZlcnRleElkO1xyXG4gICAgaWJ1ZiFbaW5kaWNlT2Zmc2V0KytdID0gdmVydGV4SWQgKyAxO1xyXG4gICAgaWJ1ZiFbaW5kaWNlT2Zmc2V0KytdID0gdmVydGV4SWQgKyAyO1xyXG4gICAgaWJ1ZiFbaW5kaWNlT2Zmc2V0KytdID0gdmVydGV4SWQgKyAxO1xyXG4gICAgaWJ1ZiFbaW5kaWNlT2Zmc2V0KytdID0gdmVydGV4SWQgKyAzO1xyXG4gICAgaWJ1ZiFbaW5kaWNlT2Zmc2V0KytdID0gdmVydGV4SWQgKyAyO1xyXG59XHJcbiJdfQ==